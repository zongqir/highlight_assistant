# æ€æºç¬”è®°ï¼šé«˜äº®æ ·å¼å®Œæ•´å®ç°åˆ†æ

## ç›®å½•
1. [å®Œæ•´æ•°æ®æµ](#å®Œæ•´æ•°æ®æµ)
2. [å‰ç«¯è¡Œä¸ºè¯¦è§£](#å‰ç«¯è¡Œä¸ºè¯¦è§£)
3. [API æ¥å£è¯¦è§£](#api-æ¥å£è¯¦è§£)
4. [åç«¯å¤„ç†è¯¦è§£](#åç«¯å¤„ç†è¯¦è§£)
5. [æ•°æ®åº“æ“ä½œè¯¦è§£](#æ•°æ®åº“æ“ä½œè¯¦è§£)
6. [æ’ä»¶å¼€å‘æŒ‡å—](#æ’ä»¶å¼€å‘æŒ‡å—)

---

## å®Œæ•´æ•°æ®æµ

```
ç”¨æˆ·æ“ä½œ
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å‰ç«¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                             â”‚
â”‚ 1. ç”¨æˆ·é€‰æ‹©æ–‡æœ¬ "æˆ‘çˆ±"                                      â”‚
â”‚ 2. ç‚¹å‡»å·¥å…·æ èƒŒæ™¯è‰²æŒ‰é’®                                     â”‚
â”‚ 3. Font.ts::fontEvent()                                    â”‚
â”‚    - è·å–é€‰ä¸­çš„ Range å¯¹è±¡                                  â”‚
â”‚    - ç¡®å®šå—å…ƒç´  (block_id)                                  â”‚
â”‚    - ç»Ÿè®¡é€‰åŒºå†…çš„å…ƒç´ ç±»å‹                                   â”‚
â”‚                                                             â”‚
â”‚ 4. Toolbar.ts::setInlineMark()                            â”‚
â”‚    â”œâ”€ åˆ›å»º <span data-type="text" style="...">æˆ‘çˆ±</span>  â”‚
â”‚    â”œâ”€ æ’å…¥åˆ° DOM ä¸­                                         â”‚
â”‚    â””â”€ åˆå¹¶ç›¸é‚»çš„ç›¸åŒæ ·å¼ span                               â”‚
â”‚                                                             â”‚
â”‚ 5. transaction.ts::updateTransaction()                    â”‚
â”‚    â”œâ”€ ç”Ÿæˆ doOperations (æ–° HTML)                          â”‚
â”‚    â”œâ”€ ç”Ÿæˆ undoOperations (æ—§ HTML)                        â”‚
â”‚    â””â”€ è°ƒç”¨ fetchPost("/api/transactions", {...})          â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ HTTP POST
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åç«¯ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                             â”‚
â”‚ 6. api/transaction.go::performTransactions()              â”‚
â”‚    â”œâ”€ æ¥æ”¶ transactions æ•°ç»„                               â”‚
â”‚    â”œâ”€ è§£æ doOperations                                    â”‚
â”‚    â””â”€ è°ƒç”¨ model.PerformTransactions()                    â”‚
â”‚                                                             â”‚
â”‚ 7. model/transaction.go::PerformTransactions()            â”‚
â”‚    â”œâ”€ éå†æ¯ä¸ª operation                                   â”‚
â”‚    â”œâ”€ é’ˆå¯¹ action: "update"                                â”‚
â”‚    â”œâ”€ è§£æ HTML â†’ Lute AST                                â”‚
â”‚    â””â”€ è°ƒç”¨ sql.UpsertTree()                               â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ•°æ®åº“å±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                             â”‚
â”‚ 8. sql/upsert.go::upsertTree()                            â”‚
â”‚    â”œâ”€ sql/database.go::fromTree()                         â”‚
â”‚    â”‚   â”œâ”€ éå† AST èŠ‚ç‚¹                                    â”‚
â”‚    â”‚   â”œâ”€ buildSpanFromNode() â†’ spans æ•°æ®                â”‚
â”‚    â”‚   â”œâ”€ buildAttributeFromNode() â†’ attributes æ•°æ®      â”‚
â”‚    â”‚   â””â”€ buildBlockFromNode() â†’ blocks æ•°æ®              â”‚
â”‚    â”‚                                                        â”‚
â”‚    â”œâ”€ æ‰¹é‡æ’å…¥æ•°æ®                                         â”‚
â”‚    â”‚   â”œâ”€ INSERT INTO blocks (...)                        â”‚
â”‚    â”‚   â”œâ”€ INSERT INTO spans (...)                         â”‚
â”‚    â”‚   â””â”€ INSERT INTO attributes (...)                    â”‚
â”‚    â”‚                                                        â”‚
â”‚    â””â”€ è§¦å‘ç´¢å¼•æ›´æ–°                                         â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   æ•°æ®åº“ç»“æœ  â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚ blocks: 1æ¡   â”‚
                    â”‚ spans: 1æ¡    â”‚
                    â”‚ attributes: 1æ¡â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å‰ç«¯è¡Œä¸ºè¯¦è§£

### 1. ç”¨æˆ·é€‰æ‹©æ–‡æœ¬å¹¶è§¦å‘æ ·å¼

#### 1.1 é€‰æ‹©æ–‡æœ¬ (æµè§ˆå™¨ Selection API)

```typescript
// å‰ç«¯è·å–é€‰åŒº
const selection = window.getSelection();
const range = selection.getRangeAt(0);

// ç¤ºä¾‹ï¼šé€‰ä¸­ "æˆ‘çˆ±" ä¸¤ä¸ªå­—
{
  startContainer: TextNode("å…³é”®ä¿¡æ¯æ˜¯æˆ‘çˆ±ä½ "),
  startOffset: 5,          // "æˆ‘" çš„ä½ç½®
  endContainer: TextNode("å…³é”®ä¿¡æ¯æ˜¯æˆ‘çˆ±ä½ "),
  endOffset: 7,            // "ä½ " ä¹‹å‰çš„ä½ç½®
  commonAncestorContainer: <div data-node-id="20251001111753-36y1un2">
}
```

#### 1.2 ç‚¹å‡»å·¥å…·æ æŒ‰é’® (app/src/protyle/toolbar/Font.ts)

```typescript
// æ­¥éª¤ 1: æ‰“å¼€æ ·å¼èœå•
export class Font extends ToolbarItem {
    constructor(protyle: IProtyle, menuItem: IMenuItem) {
        this.element.addEventListener("click", () => {
            // æ˜¾ç¤ºé¢œè‰²é€‰æ‹©é¢æ¿
            protyle.toolbar.subElement.append(appearanceMenu(protyle, nodeElements));
        });
    }
}

// æ­¥éª¤ 2: æ„å»ºé¢œè‰²é¢æ¿
export const appearanceMenu = (protyle: IProtyle, nodeElements?: Element[]) => {
    let bgHTML = "";
    // é¢„è®¾çš„ 13 ç§èƒŒæ™¯è‰²
    ["", "var(--b3-font-background1)", "var(--b3-font-background2)", ...].forEach((item) => {
        bgHTML += `<button class="color__square" 
                          style="background-color:${item}" 
                          data-type="backgroundColor"></button>`;
    });
    
    // ç›‘å¬ç‚¹å‡»äº‹ä»¶
    element.addEventListener("click", function (event) {
        if (dataType === "backgroundColor") {
            // è°ƒç”¨ fontEvent åº”ç”¨æ ·å¼
            fontEvent(protyle, nodeElements, dataType, target.style.backgroundColor);
        }
    });
};

// æ­¥éª¤ 3: åº”ç”¨æ ·å¼
export const fontEvent = (protyle: IProtyle, nodeElements: Element[], 
                          type?: string, color?: string) => {
    // è®°å½•æœ€è¿‘ä½¿ç”¨çš„æ ·å¼ï¼ˆæœ¬åœ°å­˜å‚¨ï¼‰
    window.siyuan.storage[Constants.LOCAL_FONTSTYLES].push(`${type}${Constants.ZWSP}${color}`);
    
    if (nodeElements && nodeElements.length > 0) {
        // åœºæ™¯ A: æ‰¹é‡ä¿®æ”¹å·²é€‰ä¸­çš„å—
        updateBatchTransaction(nodeElements, protyle, (e: HTMLElement) => {
            if (type === "backgroundColor") {
                e.style.backgroundColor = color;  // ç›´æ¥è®¾ç½® DOM æ ·å¼
            }
        });
    } else {
        // åœºæ™¯ B: ç»™é€‰ä¸­çš„æ–‡æœ¬æ·»åŠ æ ·å¼ï¼ˆä½ çš„åœºæ™¯ï¼‰
        protyle.toolbar.setInlineMark(protyle, "text", "range", {type, color});
    }
};
```

### 2. åˆ›å»º Span å…ƒç´  (app/src/protyle/toolbar/index.ts)

```typescript
public setInlineMark(protyle: IProtyle, type: string, action: "range" | "toolbar", 
                     textObj?: ITextOption) {
    // æ­¥éª¤ 1: è·å–å—å…ƒç´ 
    const nodeElement = hasClosestBlock(this.range.startContainer);
    const blockId = nodeElement.getAttribute("data-node-id");  // 20251001111753-36y1un2
    
    // æ­¥éª¤ 2: åˆ†æé€‰åŒºå†…çš„å…ƒç´ ç±»å‹
    let rangeTypes: string[] = [];
    this.range.cloneContents().childNodes.forEach((item: HTMLElement) => {
        if (item.nodeType !== 3) {  // éæ–‡æœ¬èŠ‚ç‚¹
            rangeTypes = rangeTypes.concat(item.getAttribute("data-type").split(" "));
        }
    });
    
    // æ­¥éª¤ 3: æå–é€‰ä¸­çš„å†…å®¹
    this.range.insertNode(document.createElement("wbr"));  // æ’å…¥ä¹¦ç­¾
    const html = nodeElement.outerHTML;  // ä¿å­˜æ—§ HTMLï¼ˆç”¨äº undoï¼‰
    const contents = this.range.extractContents();  // æå–é€‰ä¸­å†…å®¹
    
    // æ­¥éª¤ 4: åˆ›å»ºæ–°çš„ span å…ƒç´ 
    contents.childNodes.forEach((item: HTMLElement) => {
        if (item.nodeType === 3 && item.textContent) {  // æ–‡æœ¬èŠ‚ç‚¹
            const inlineElement = document.createElement("span");
            inlineElement.setAttribute("data-type", type);  // "text"
            inlineElement.textContent = item.textContent;   // "æˆ‘çˆ±"
            
            // åº”ç”¨æ ·å¼ (setFontStyle)
            if (textObj.type === "backgroundColor") {
                inlineElement.style.backgroundColor = textObj.color;
                // ç»“æœ: <span data-type="text" style="background-color: var(--b3-font-background2);">æˆ‘çˆ±</span>
            }
            
            newNodes.push(inlineElement);
        }
    });
    
    // æ­¥éª¤ 5: æ’å…¥æ–°å…ƒç´ 
    newNodes.forEach(item => this.range.insertNode(item));
    
    // æ­¥éª¤ 6: æäº¤äº‹åŠ¡
    updateTransaction(protyle, blockId, nodeElement.outerHTML, html);
}
```

### 3. æäº¤äº‹åŠ¡ (app/src/protyle/wysiwyg/transaction.ts)

```typescript
export const updateTransaction = (protyle: IProtyle, id: string, 
                                  newHTML: string, html: string) => {
    if (newHTML === html) return;  // æ— å˜åŒ–åˆ™è·³è¿‡
    
    transaction(protyle, [{
        id,              // "20251001111753-36y1un2"
        data: newHTML,   // æ–°çš„ HTMLï¼ˆåŒ…å« spanï¼‰
        action: "update"
    }], [{
        id,
        data: html,      // æ—§çš„ HTMLï¼ˆç”¨äºæ’¤é”€ï¼‰
        action: "update"
    }]);
};

// å®é™…å‘é€è¯·æ±‚
const promiseTransaction = () => {
    const doOperations = window.siyuan.transactions[0].doOperations;
    const undoOperations = window.siyuan.transactions[0].undoOperations;
    
    fetchPost("/api/transactions", {
        session: protyle.id,           // ç¼–è¾‘å™¨ä¼šè¯ ID
        app: Constants.SIYUAN_APPID,   // "siyuan"
        transactions: [{
            doOperations,      // è¦æ‰§è¡Œçš„æ“ä½œ
            undoOperations     // æ’¤é”€æ“ä½œ
        }]
    }, (response) => {
        // å¤„ç†å“åº”ï¼Œæ›´æ–°åµŒå…¥å—ç­‰
    });
};
```

### 4. å‰ç«¯å…³é”®æ•°æ®ç»“æ„

```typescript
// å‘é€åˆ°åç«¯çš„æ•°æ®æ ¼å¼
{
  "session": "sy-20250101-editor-1",
  "app": "siyuan",
  "transactions": [{
    "doOperations": [{
      "action": "update",
      "id": "20251001111753-36y1un2",
      "data": "<div data-node-id=\"20251001111753-36y1un2\" ...>å…³é”®ä¿¡æ¯æ˜¯<span data-type=\"text\" style=\"background-color: var(--b3-font-background2);\">æˆ‘çˆ±</span>ä½ </div>"
    }],
    "undoOperations": [{
      "action": "update",
      "id": "20251001111753-36y1un2",
      "data": "<div data-node-id=\"20251001111753-36y1un2\" ...>å…³é”®ä¿¡æ¯æ˜¯æˆ‘çˆ±ä½ </div>"
    }]
  }]
}
```

---

## API æ¥å£è¯¦è§£

### POST /api/transactions

#### è¯·æ±‚å‚æ•°

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| `session` | string | æ˜¯ | ç¼–è¾‘å™¨ä¼šè¯ IDï¼Œç”¨äºåŒºåˆ†ä¸åŒçš„ç¼–è¾‘å™¨å®ä¾‹ |
| `app` | string | æ˜¯ | åº”ç”¨æ ‡è¯†ï¼Œå›ºå®šä¸º "siyuan" |
| `transactions` | array | æ˜¯ | äº‹åŠ¡æ•°ç»„ï¼Œæ¯ä¸ªäº‹åŠ¡åŒ…å« doOperations å’Œ undoOperations |

#### transactions[].doOperations å­—æ®µ

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| `action` | string | æ“ä½œç±»å‹ï¼š`update`, `insert`, `delete`, `move`, `foldHeading`, `unfoldHeading` |
| `id` | string | å— IDï¼ˆ20ä½é›ªèŠ±IDï¼‰ |
| `data` | string | æ–°çš„ HTML å†…å®¹ï¼ˆaction=update/insert æ—¶éœ€è¦ï¼‰ |
| `parentID` | string | çˆ¶å— IDï¼ˆaction=insert æ—¶éœ€è¦ï¼‰ |
| `previousID` | string | å‰ä¸€ä¸ªå…„å¼Ÿå— IDï¼ˆaction=move æ—¶éœ€è¦ï¼‰ |

#### å“åº”æ•°æ®

```json
{
  "code": 0,
  "msg": "",
  "data": [{
    "doOperations": [{
      "action": "update",
      "id": "20251001111753-36y1un2",
      "data": "<div ...>...</div>",
      "retData": null
    }],
    "undoOperations": [...]
  }]
}
```

---

## åç«¯å¤„ç†è¯¦è§£

### 1. API å…¥å£ (kernel/api/transaction.go)

```go
func performTransactions(c *gin.Context) {
    // è§£æè¯·æ±‚
    var request struct {
        Session      string        `json:"session"`
        App          string        `json:"app"`
        Transactions []Transaction `json:"transactions"`
    }
    c.BindJSON(&request)
    
    // è°ƒç”¨æ¨¡å‹å±‚
    result := model.PerformTransactions(&request)
    
    c.JSON(200, result)
}
```

### 2. äº‹åŠ¡å¤„ç† (kernel/model/transaction.go)

```go
func PerformTransactions(req *TransactionsRequest) (result) {
    for _, tx := range req.Transactions {
        for _, op := range tx.DoOperations {
            switch op.Action {
            case "update":
                handleUpdate(op)
            case "insert":
                handleInsert(op)
            // ... å…¶ä»–æ“ä½œ
            }
        }
    }
}

func handleUpdate(op *Operation) {
    // 1. è§£æ HTML ä¸º Lute AST
    tree := parseHTML(op.Data)
    
    // 2. ä¿å­˜ .sy æ–‡ä»¶
    saveTree(tree)
    
    // 3. æ›´æ–°æ•°æ®åº“ç´¢å¼•
    sql.UpsertTree(tree)
}
```

### 3. HTML è§£æä¸º AST (kernel/model ä½¿ç”¨ Lute åº“)

```go
import "github.com/88250/lute"

func parseHTML(html string) *parse.Tree {
    luteEngine := lute.New()
    luteEngine.SetTextMark(true)  // å¯ç”¨ TextMark æ”¯æŒ
    
    // è§£æ HTML
    tree := luteEngine.HTML2Tree(html)
    
    // AST ç»“æ„ç¤ºä¾‹ï¼š
    // NodeDocument
    //   â””â”€ NodeParagraph (id: 20251001111753-36y1un2)
    //        â”œâ”€ NodeText: "å…³é”®ä¿¡æ¯æ˜¯"
    //        â”œâ”€ NodeTextMark (TextMarkType: "text")
    //        â”‚    â”œâ”€ NodeText: "æˆ‘çˆ±"
    //        â”‚    â””â”€ NodeKramdownSpanIAL: {: style="background-color: ..."}
    //        â””â”€ NodeText: "ä½ "
    
    return tree
}
```

### 4. ç´¢å¼•åˆ°æ•°æ®åº“ (kernel/sql/upsert.go)

```go
func upsertTree(tx *sql.Tx, tree *parse.Tree, context map[string]interface{}) error {
    // 1. ä» AST æå–æ•°æ®
    blocks, spans, assets, attributes := fromTree(tree.Root, tree)
    
    // 2. åˆ é™¤æ—§æ•°æ®
    deleteSpansByRootID(tx, tree.ID)
    deleteAttributesByRootID(tx, tree.ID)
    
    // 3. æ’å…¥æ–°æ•°æ®
    insertBlocks(tx, blocks, context)
    insertSpans(tx, spans)
    insertAttributes(tx, attributes)
    
    return nil
}
```

### 5. ä» AST æå–æ•°æ® (kernel/sql/database.go)

```go
func fromTree(node *ast.Node, tree *parse.Tree) (blocks, spans, assets, attributes) {
    ast.Walk(node, func(n *ast.Node, entering bool) ast.WalkStatus {
        if !entering {
            return ast.WalkContinue
        }
        
        // å¤„ç†è¡Œçº§å…ƒç´ ï¼ˆspanï¼‰
        switch n.Type {
        case ast.NodeTextMark:
            span := buildSpanFromTextMark(n, tree)
            spans = append(spans, span)
        }
        
        // å¤„ç†å±æ€§èŠ‚ç‚¹ï¼ˆIALï¼‰
        switch n.Type {
        case ast.NodeKramdownSpanIAL:
            attrs := buildAttributeFromSpanIAL(n, tree)
            attributes = append(attributes, attrs...)
        }
        
        // å¤„ç†å—çº§å…ƒç´ 
        if n.IsBlock() {
            block := buildBlockFromNode(n, tree)
            blocks = append(blocks, block)
        }
        
        return ast.WalkContinue
    })
    
    return
}

// æ„å»º Span è®°å½•
func buildSpanFromTextMark(n *ast.Node, tree *parse.Tree) *Span {
    parentBlock := treenode.ParentBlock(n)
    
    return &Span{
        ID:       ast.NewNodeID(),                  // 20251001111832-b574fnd
        BlockID:  parentBlock.ID,                    // 20251001111753-36y1un2
        RootID:   tree.ID,                           // 20251001111753-bo1zbnu
        Box:      tree.Box,                          // 20250927162737-llbshdd
        Path:     tree.Path,                         // /20251001111753-bo1zbnu.sy
        Content:  n.TextMarkTextContent,             // "æˆ‘çˆ±"
        Markdown: treenode.ExportNodeStdMd(n),       // "<span data-type=\"text\">æˆ‘çˆ±</span>"
        Type:     "textmark text",                   // ç±»å‹æ ‡è¯†
        IAL:      treenode.IALStr(n),               // "{: style=\"background-color: ...\"}"
    }
}

// æ„å»º Attribute è®°å½•
func buildAttributeFromSpanIAL(n *ast.Node, tree *parse.Tree) []*Attribute {
    parentBlock := treenode.ParentBlock(n)
    attrs := parse.IALValMap(n)  // è§£æ IAL ä¸º map
    
    var result []*Attribute
    for name, val := range attrs {
        if !isAttr(name) {  // åªå­˜å‚¨ç‰¹å®šå±æ€§
            continue
        }
        
        result = append(result, &Attribute{
            ID:      ast.NewNodeID(),           // 20251001111832-pjcbyat
            Name:    name,                       // "style"
            Value:   val,                        // "background-color: var(--b3-font-background2);"
            Type:    "s",                        // "s" = span çº§å±æ€§
            BlockID: parentBlock.ID,             // 20251001111753-36y1un2 (æ³¨æ„ï¼šå…³è”åˆ°å—ï¼Œä¸æ˜¯ span)
            RootID:  tree.ID,
            Box:     tree.Box,
            Path:    tree.Path,
        })
    }
    
    return result
}

// åˆ¤æ–­å“ªäº›å±æ€§éœ€è¦å­˜åˆ° attributes è¡¨
func isAttr(name string) bool {
    return strings.HasPrefix(name, "custom-") ||
           name == "style" ||
           name == "name" ||
           name == "alias" ||
           name == "memo" ||
           name == "bookmark" ||
           name == "fold" ||
           name == "heading-fold"
}
```

---

## æ•°æ®åº“æ“ä½œè¯¦è§£

### 1. è¡¨ç»“æ„è®¾è®¡

```sql
-- blocks è¡¨ï¼šå­˜å‚¨æ‰€æœ‰å—çº§å…ƒç´ 
CREATE TABLE blocks (
    id          TEXT PRIMARY KEY,   -- å— ID
    parent_id   TEXT,               -- çˆ¶å— ID
    root_id     TEXT,               -- æ–‡æ¡£ ID
    hash        TEXT,               -- å†…å®¹å“ˆå¸Œï¼ˆç”¨äºå¢é‡æ›´æ–°ï¼‰
    box         TEXT,               -- ç¬”è®°æœ¬ ID
    path        TEXT,               -- æ–‡ä»¶è·¯å¾„
    hpath       TEXT,               -- äººç±»å¯è¯»è·¯å¾„
    name        TEXT,               -- å—åç§°
    alias       TEXT,               -- åˆ«å
    memo        TEXT,               -- å¤‡æ³¨
    tag         TEXT,               -- æ ‡ç­¾
    content     TEXT,               -- çº¯æ–‡æœ¬å†…å®¹
    fcontent    TEXT,               -- ç¬¬ä¸€ä¸ªå­å—å†…å®¹
    markdown    TEXT,               -- Markdown å†…å®¹ï¼ˆå®Œæ•´ï¼‰
    length      INT,                -- å†…å®¹é•¿åº¦
    type        TEXT,               -- å—ç±»å‹ (p, h, l, i, d, etc.)
    subtype     TEXT,               -- å­ç±»å‹
    ial         TEXT,               -- å—çº§å±æ€§åˆ—è¡¨
    sort        INT,                -- æ’åº
    created     TEXT,               -- åˆ›å»ºæ—¶é—´
    updated     TEXT                -- æ›´æ–°æ—¶é—´
);

-- spans è¡¨ï¼šå­˜å‚¨è¡Œçº§å…ƒç´ 
CREATE TABLE spans (
    id          TEXT PRIMARY KEY,   -- Span ID
    block_id    TEXT,               -- æ‰€å±å— ID
    root_id     TEXT,               -- æ–‡æ¡£ ID
    box         TEXT,               -- ç¬”è®°æœ¬ ID
    path        TEXT,               -- æ–‡ä»¶è·¯å¾„
    content     TEXT,               -- çº¯æ–‡æœ¬å†…å®¹
    markdown    TEXT,               -- Markdown è¡¨ç¤º
    type        TEXT,               -- ç±»å‹ (textmark text, textmark tag, image, etc.)
    ial         TEXT                -- è¡Œçº§å±æ€§åˆ—è¡¨
);
CREATE INDEX idx_spans_root_id ON spans(root_id);

-- attributes è¡¨ï¼šå­˜å‚¨å¯æŸ¥è¯¢çš„å±æ€§
CREATE TABLE attributes (
    id          TEXT PRIMARY KEY,   -- å±æ€§ ID
    name        TEXT,               -- å±æ€§å (style, custom-*, name, alias, etc.)
    value       TEXT,               -- å±æ€§å€¼
    type        TEXT,               -- ç±»å‹ ("b"=blockçº§, "s"=spançº§)
    block_id    TEXT,               -- å…³è”çš„å— IDï¼ˆæ³¨æ„ï¼šå³ä½¿æ˜¯ span å±æ€§ä¹Ÿå…³è”åˆ°å—ï¼‰
    root_id     TEXT,               -- æ–‡æ¡£ ID
    box         TEXT,               -- ç¬”è®°æœ¬ ID
    path        TEXT                -- æ–‡ä»¶è·¯å¾„
);
CREATE INDEX idx_attributes_block_id ON attributes(block_id);
CREATE INDEX idx_attributes_root_id ON attributes(root_id);
```

### 2. æ’å…¥æ“ä½œ (kernel/sql/upsert.go)

```go
// æ‰¹é‡æ’å…¥ blocks
func insertBlocks(tx *sql.Tx, blocks []*Block, context map[string]interface{}) error {
    // æ¯ 512 æ¡æ‰¹é‡æ’å…¥
    const batchSize = 512
    
    for i := 0; i < len(blocks); i += batchSize {
        end := min(i+batchSize, len(blocks))
        batch := blocks[i:end]
        
        // æ„é€  SQL
        stmt := "INSERT INTO blocks (id, parent_id, root_id, ...) VALUES "
        values := []interface{}{}
        
        for _, b := range batch {
            stmt += "(?, ?, ?, ..., ?), "
            values = append(values, b.ID, b.ParentID, b.RootID, ...)
        }
        
        stmt = strings.TrimSuffix(stmt, ", ")
        tx.Exec(stmt, values...)
    }
    
    return nil
}

// æ’å…¥ spansï¼ˆç±»ä¼¼çš„æ‰¹é‡é€»è¾‘ï¼‰
func insertSpans(tx *sql.Tx, spans []*Span) error {
    stmt := "INSERT INTO spans (id, block_id, root_id, box, path, content, markdown, type, ial) VALUES "
    // ... æ‰¹é‡æ’å…¥
}

// æ’å…¥ attributes
func insertAttributes(tx *sql.Tx, attributes []*Attribute) error {
    stmt := "INSERT INTO attributes (id, name, value, type, block_id, root_id, box, path) VALUES "
    // ... æ‰¹é‡æ’å…¥
}
```

### 3. å®é™…æ’å…¥çš„æ•°æ®

```sql
-- blocks è¡¨æ’å…¥
INSERT INTO blocks VALUES (
    '20251001111753-36y1un2',                      -- id
    '20251001111753-bo1zbnu',                      -- parent_id (æ–‡æ¡£å—)
    '20251001111753-bo1zbnu',                      -- root_id
    'a1b2c3d4...',                                  -- hash
    '20250927162737-llbshdd',                      -- box
    '/20251001111753-bo1zbnu.sy',                  -- path
    '/é«˜äº®æµ‹è¯•',                                     -- hpath
    '',                                             -- name
    '',                                             -- alias
    '',                                             -- memo
    '',                                             -- tag
    'å…³é”®ä¿¡æ¯æ˜¯æˆ‘çˆ±ä½ ',                              -- content (çº¯æ–‡æœ¬)
    '',                                             -- fcontent
    'å…³é”®ä¿¡æ¯æ˜¯<span data-type="text" style="background-color: var(--b3-font-background2);">æˆ‘çˆ±</span>{: style="background-color: var(--b3-font-background2);"}ä½ ',  -- markdown
    8,                                              -- length
    'p',                                            -- type (paragraph)
    '',                                             -- subtype
    '',                                             -- ial
    0,                                              -- sort
    '20251001111753',                               -- created
    '20251001111824'                                -- updated
);

-- spans è¡¨æ’å…¥
INSERT INTO spans VALUES (
    '20251001111832-b574fnd',                      -- id
    '20251001111753-36y1un2',                      -- block_id
    '20251001111753-bo1zbnu',                      -- root_id
    '20250927162737-llbshdd',                      -- box
    '/20251001111753-bo1zbnu.sy',                  -- path
    'æˆ‘çˆ±',                                          -- content
    '<span data-type="text" style="background-color: var(--b3-font-background2);">æˆ‘çˆ±</span>',  -- markdown
    'textmark text',                                -- type
    '{: style="background-color: var(--b3-font-background2);"}'  -- ial
);

-- attributes è¡¨æ’å…¥
INSERT INTO attributes VALUES (
    '20251001111832-pjcbyat',                      -- id
    'style',                                        -- name
    'background-color: var(--b3-font-background2);',  -- value
    's',                                            -- type (spançº§)
    '20251001111753-36y1un2',                      -- block_id (å…³è”åˆ°çˆ¶å—)
    '20251001111753-bo1zbnu',                      -- root_id
    '20250927162737-llbshdd',                      -- box
    '/20251001111753-bo1zbnu.sy'                   -- path
);
```

### 4. æŸ¥è¯¢ç¤ºä¾‹

```sql
-- æŸ¥è¯¢ 1: æ‰¾åˆ°åŒ…å«é«˜äº®æ–‡æœ¬çš„æ‰€æœ‰å—
SELECT b.id, b.markdown, s.content, a.value
FROM blocks b
JOIN spans s ON b.id = s.block_id
JOIN attributes a ON b.id = a.block_id
WHERE a.name = 'style' 
  AND a.value LIKE '%background-color%'
  AND a.type = 's';

-- æŸ¥è¯¢ 2: ç»Ÿè®¡ä½¿ç”¨äº†è‡ªå®šä¹‰æ ·å¼çš„å—æ•°é‡
SELECT COUNT(DISTINCT block_id) as styled_blocks_count
FROM attributes 
WHERE name = 'style' AND type = 's';

-- æŸ¥è¯¢ 3: æŸ¥æ‰¾æŸä¸ªå—çš„æ‰€æœ‰ spans
SELECT * FROM spans 
WHERE block_id = '20251001111753-36y1un2'
ORDER BY id;

-- æŸ¥è¯¢ 4: é‡å»ºå®Œæ•´çš„å—å†…å®¹ï¼ˆå®é™…ä¸éœ€è¦ï¼Œblocks.markdown å·²åŒ…å«å®Œæ•´å†…å®¹ï¼‰
SELECT markdown FROM blocks WHERE id = '20251001111753-36y1un2';
```

---

## æ’ä»¶å¼€å‘æŒ‡å—

### 1. æ’ä»¶å¯ä»¥ç›´æ¥å¤ç”¨çš„å†…å®¹

#### âœ… **API å±‚é¢**

```typescript
// 1. ç›´æ¥ä½¿ç”¨æ€æºçš„ transactions API
import { fetchPost } from "siyuan";

async function applyCustomHighlight(blockId: string, newHTML: string, oldHTML: string) {
    await fetchPost("/api/transactions", {
        session: "plugin-session",
        app: "siyuan",
        transactions: [{
            doOperations: [{
                action: "update",
                id: blockId,
                data: newHTML
            }],
            undoOperations: [{
                action: "update",
                id: blockId,
                data: oldHTML
            }]
        }]
    });
}
```

#### âœ… **DOM æ“ä½œå±‚é¢**

```typescript
// 2. åŠ«æŒå·¥å…·æ ï¼ˆä½ çš„ toolbarHijacker.ts å·²å®ç°ï¼‰
import { getAllEditor } from "siyuan";

class ToolbarHijacker {
    hijack() {
        const editors = getAllEditor();
        editors.forEach(editor => {
            const toolbar = editor.protyle.toolbar;
            const originalShowContent = toolbar.showContent.bind(toolbar);
            
            toolbar.showContent = (...args) => {
                // åœ¨åŸæœ‰é€»è¾‘å‰æ’å…¥è‡ªå®šä¹‰æŒ‰é’®
                this.injectCustomButtons(toolbar);
                return originalShowContent(...args);
            };
        });
    }
    
    injectCustomButtons(toolbar) {
        // æ·»åŠ è‡ªå®šä¹‰é¢œè‰²æŒ‰é’®
        const customColorBtn = document.createElement("button");
        customColorBtn.innerHTML = "ğŸ¨";
        customColorBtn.onclick = () => this.applyCustomColor();
        toolbar.element.appendChild(customColorBtn);
    }
}
```

#### âœ… **æ ·å¼æ‰©å±•**

```typescript
// 3. æ·»åŠ è‡ªå®šä¹‰é¢œè‰²
const CUSTOM_COLORS = [
    { name: "è§å…‰é»„", value: "#FFFF00" },
    { name: "è§å…‰ç»¿", value: "#00FF00" },
    { name: "è§å…‰ç²‰", value: "#FF00FF" },
];

function applyCustomColor(protyle, color: string) {
    const range = protyle.toolbar.range;
    const blockElement = hasClosestBlock(range.startContainer);
    const oldHTML = blockElement.outerHTML;
    
    // åˆ›å»º span
    const span = document.createElement("span");
    span.setAttribute("data-type", "text");
    span.style.backgroundColor = color;
    span.textContent = range.toString();
    
    // æ›¿æ¢é€‰åŒº
    range.deleteContents();
    range.insertNode(span);
    
    // æäº¤äº‹åŠ¡
    fetchPost("/api/transactions", {
        session: protyle.id,
        app: "siyuan",
        transactions: [{
            doOperations: [{
                action: "update",
                id: blockElement.getAttribute("data-node-id"),
                data: blockElement.outerHTML
            }],
            undoOperations: [{
                action: "update",
                id: blockElement.getAttribute("data-node-id"),
                data: oldHTML
            }]
        }]
    });
}
```

### 2. æ’ä»¶ä¸èƒ½ç›´æ¥å¤ç”¨çš„å†…å®¹

#### âŒ **æ•°æ®åº“ç›´æ¥æ“ä½œ**

æ’ä»¶**ä¸èƒ½**ç›´æ¥æ“ä½œæ•°æ®åº“ï¼Œå¿…é¡»é€šè¿‡ APIï¼š

```typescript
// âŒ é”™è¯¯ï¼šæ’ä»¶æ— æ³•ç›´æ¥è®¿é—®æ•°æ®åº“
// const db = sqlite3.open('/data/storage/siyuan.db');
// db.exec("INSERT INTO spans ...");

// âœ… æ­£ç¡®ï¼šé€šè¿‡ API æ“ä½œ
fetchPost("/api/transactions", { ... });  // åç«¯ä¼šè‡ªåŠ¨æ›´æ–°æ•°æ®åº“
```

#### âŒ **åç«¯ç´¢å¼•é€»è¾‘**

æ’ä»¶æ— æ³•ä¿®æ”¹åç«¯çš„ç´¢å¼•é€»è¾‘ï¼ˆfromTree, buildSpanFromNode ç­‰ï¼‰ï¼Œåªèƒ½ï¼š
- ä½¿ç”¨æ ‡å‡†çš„ HTML ç»“æ„ï¼ˆæ€æºä¼šè‡ªåŠ¨è§£æï¼‰
- ä½¿ç”¨æ ‡å‡†çš„å±æ€§åï¼ˆstyle, custom-*, etc.ï¼‰

### 3. ä½ çš„æ’ä»¶å½“å‰å®ç°åˆ†æ

#### å½“å‰ä»£ç ç»“æ„

```
src/
â”œâ”€â”€ index.ts                 # æ’ä»¶å…¥å£
â””â”€â”€ utils/
    â””â”€â”€ toolbarHijacker.ts   # å·¥å…·æ åŠ«æŒå™¨
```

#### å·²å®ç°çš„åŠŸèƒ½

```typescript
// src/utils/toolbarHijacker.ts
export class ToolbarHijacker {
    hijack() {
        // âœ… å·²å®ç°ï¼šåŠ«æŒå·¥å…·æ çš„ showContent æ–¹æ³•
        const originalShowContent = toolbar.showContent.bind(toolbar);
        toolbar.showContent = (...args) => {
            // æ³¨å…¥è‡ªå®šä¹‰æŒ‰é’®
            return originalShowContent(...args);
        };
    }
}
```

### 4. å»ºè®®çš„å¢å¼ºæ–¹å‘

#### æ–¹æ¡ˆ A: æ‰©å±•é¢œè‰²é€‰æ‹©å™¨

```typescript
// src/utils/colorExtender.ts
export class ColorExtender {
    private customColors = [
        { name: "è§å…‰é»„", value: "#FFFF00", icon: "ğŸŸ¡" },
        { name: "è§å…‰ç»¿", value: "#00FF00", icon: "ğŸŸ¢" },
        { name: "è§å…‰ç²‰", value: "#FF00FF", icon: "ğŸŸ£" },
        { name: "è§å…‰æ©™", value: "#FFA500", icon: "ğŸŸ " },
    ];
    
    injectColorButtons(toolbar: Toolbar) {
        const colorPanel = toolbar.subElement.querySelector(".protyle-font");
        if (!colorPanel) return;
        
        // æ·»åŠ è‡ªå®šä¹‰é¢œè‰²åŒºåŸŸ
        const customSection = document.createElement("div");
        customSection.innerHTML = `
            <div class="fn__hr"></div>
            <div>ğŸ¨ æ’ä»¶è‡ªå®šä¹‰é¢œè‰²</div>
            <div class="fn__hr--small"></div>
            <div class="fn__flex fn__flex-wrap">
                ${this.customColors.map(c => `
                    <button class="color__square" 
                            style="background-color:${c.value}" 
                            data-type="backgroundColor"
                            title="${c.name}">
                    </button>
                `).join('')}
            </div>
        `;
        
        colorPanel.appendChild(customSection);
    }
}
```

#### æ–¹æ¡ˆ B: é«˜äº®æ¨¡æ¿

```typescript
// src/utils/highlightTemplates.ts
export class HighlightTemplates {
    private templates = {
        important: {
            backgroundColor: "var(--b3-card-error-background)",
            color: "var(--b3-card-error-color)",
            fontWeight: "bold"
        },
        info: {
            backgroundColor: "var(--b3-card-info-background)",
            color: "var(--b3-card-info-color)"
        },
        quote: {
            backgroundColor: "transparent",
            borderLeft: "3px solid var(--b3-theme-primary)",
            paddingLeft: "8px",
            fontStyle: "italic"
        }
    };
    
    applyTemplate(protyle: IProtyle, templateName: string) {
        const style = this.templates[templateName];
        const range = protyle.toolbar.range;
        
        // åˆ›å»º span å¹¶åº”ç”¨æ ·å¼
        const span = document.createElement("span");
        span.setAttribute("data-type", "text");
        Object.assign(span.style, style);
        span.textContent = range.toString();
        
        // æäº¤äº‹åŠ¡...
    }
}
```

#### æ–¹æ¡ˆ C: å¿«æ·é”®æ”¯æŒ

```typescript
// src/utils/keyboardShortcuts.ts
export class KeyboardShortcuts {
    register(plugin: Plugin) {
        // æ³¨å†Œå¿«æ·é”® Ctrl+Shift+H
        document.addEventListener("keydown", (e) => {
            if (e.ctrlKey && e.shiftKey && e.key === "H") {
                e.preventDefault();
                this.quickHighlight();
            }
        });
    }
    
    private quickHighlight() {
        const editors = getAllEditor();
        editors.forEach(editor => {
            const toolbar = editor.protyle.toolbar;
            // åº”ç”¨é»˜è®¤é«˜äº®è‰²
            applyCustomColor(editor.protyle, "#FFFF00");
        });
    }
}
```

### 5. å®Œæ•´çš„æ’ä»¶ç¤ºä¾‹

```typescript
// src/index.ts (å¢å¼ºç‰ˆ)
import { Plugin, getAllEditor, fetchPost } from "siyuan";
import { ToolbarHijacker } from "./utils/toolbarHijacker";
import { ColorExtender } from "./utils/colorExtender";
import { HighlightTemplates } from "./utils/highlightTemplates";
import { KeyboardShortcuts } from "./utils/keyboardShortcuts";

export default class HighlightAssistantPlugin extends Plugin {
    private hijacker: ToolbarHijacker;
    private colorExtender: ColorExtender;
    private templates: HighlightTemplates;
    private shortcuts: KeyboardShortcuts;
    
    async onload() {
        // 1. åˆå§‹åŒ–å„æ¨¡å—
        this.hijacker = new ToolbarHijacker();
        this.colorExtender = new ColorExtender();
        this.templates = new HighlightTemplates();
        this.shortcuts = new KeyboardShortcuts();
        
        // 2. åŠ«æŒå·¥å…·æ 
        this.hijacker.hijack();
        
        // 3. æ³¨å…¥è‡ªå®šä¹‰é¢œè‰²
        this.hijacker.onToolbarShow = (toolbar) => {
            this.colorExtender.injectColorButtons(toolbar);
        };
        
        // 4. æ³¨å†Œå¿«æ·é”®
        this.shortcuts.register(this);
        
        // 5. æ·»åŠ é¡¶æ æŒ‰é’®
        this.addTopBar({
            icon: "iconHighlight",
            title: "å¿«é€Ÿé«˜äº®",
            callback: () => this.showQuickMenu()
        });
    }
    
    private showQuickMenu() {
        // æ˜¾ç¤ºå¿«æ·èœå•
        const menu = new Menu("highlight-menu");
        menu.addItem({
            icon: "iconInfo",
            label: "é‡è¦",
            click: () => this.templates.applyTemplate(this.getCurrentProtyle(), "important")
        });
        menu.addItem({
            icon: "iconHelp",
            label: "æç¤º",
            click: () => this.templates.applyTemplate(this.getCurrentProtyle(), "info")
        });
        menu.open();
    }
    
    private getCurrentProtyle() {
        const editors = getAllEditor();
        return editors[0]?.protyle;  // è·å–å½“å‰ç¼–è¾‘å™¨
    }
}
```

### 6. æ•°æ®åº“æŸ¥è¯¢ï¼ˆæ’ä»¶å¯ä»¥ä½¿ç”¨ï¼‰

è™½ç„¶æ’ä»¶ä¸èƒ½ç›´æ¥æ“ä½œæ•°æ®åº“ï¼Œä½†å¯ä»¥é€šè¿‡ API æŸ¥è¯¢ï¼š

```typescript
// æŸ¥è¯¢åŒ…å«é«˜äº®çš„å—
async function findHighlightedBlocks() {
    const result = await fetchPost("/api/query/sql", {
        stmt: `
            SELECT b.id, b.content, b.markdown, a.value as style_value
            FROM blocks b
            JOIN attributes a ON b.id = a.block_id
            WHERE a.name = 'style' 
              AND a.type = 's'
              AND a.value LIKE '%background-color%'
            LIMIT 100
        `
    });
    
    return result.data;
}

// ç»Ÿè®¡é«˜äº®ä½¿ç”¨æƒ…å†µ
async function getHighlightStats() {
    const result = await fetchPost("/api/query/sql", {
        stmt: `
            SELECT 
                COUNT(DISTINCT block_id) as block_count,
                COUNT(*) as span_count
            FROM attributes
            WHERE name = 'style' AND type = 's'
        `
    });
    
    return result.data[0];
}
```

### 7. æ³¨æ„äº‹é¡¹

#### âš ï¸ **äº‹åŠ¡å¤„ç†**

- æ‰€æœ‰ä¿®æ”¹å¿…é¡»é€šè¿‡ `/api/transactions`
- doOperations å’Œ undoOperations å¿…é¡»é…å¯¹
- ä¸è¦è·³è¿‡äº‹åŠ¡ç›´æ¥ä¿®æ”¹ DOMï¼ˆä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ï¼‰

#### âš ï¸ **HTML ç»“æ„**

```html
<!-- âœ… æ­£ç¡®ï¼šä½¿ç”¨æ ‡å‡†ç»“æ„ -->
<span data-type="text" style="background-color: #FFFF00;">é«˜äº®æ–‡æœ¬</span>

<!-- âŒ é”™è¯¯ï¼šè‡ªå®šä¹‰å±æ€§ä¸ä¼šè¢«ç´¢å¼• -->
<span class="my-highlight" data-my-color="#FFFF00">é«˜äº®æ–‡æœ¬</span>
```

#### âš ï¸ **å±æ€§å‘½å**

```typescript
// âœ… ä¼šè¢«ç´¢å¼•åˆ° attributes è¡¨
span.style.backgroundColor = "#FFFF00";  // â†’ attributes (name=style)
span.setAttribute("custom-highlight-level", "3");  // â†’ attributes (name=custom-highlight-level)

// âŒ ä¸ä¼šè¢«ç´¢å¼•
span.setAttribute("data-highlight", "true");  // ä¸ç¬¦åˆ isAttr() è§„åˆ™
span.className = "highlight";  // class ä¸ä¼šè¢«ç´¢å¼•åˆ° attributes
```

#### âš ï¸ **æ€§èƒ½è€ƒè™‘**

- æ‰¹é‡æ“ä½œæ—¶ä½¿ç”¨å•ä¸ªäº‹åŠ¡
- é¿å…é¢‘ç¹çš„å°äº‹åŠ¡
- å¤§é‡æ•°æ®æŸ¥è¯¢æ—¶ä½¿ç”¨åˆ†é¡µ

```typescript
// âŒ æ€§èƒ½å·®ï¼šæ¯ä¸ªå—ä¸€ä¸ªäº‹åŠ¡
blocks.forEach(block => {
    fetchPost("/api/transactions", { ... });
});

// âœ… æ€§èƒ½å¥½ï¼šæ‰¹é‡æ“ä½œ
fetchPost("/api/transactions", {
    transactions: [{
        doOperations: blocks.map(block => ({
            action: "update",
            id: block.id,
            data: block.newHTML
        })),
        undoOperations: blocks.map(block => ({
            action: "update",
            id: block.id,
            data: block.oldHTML
        }))
    }]
});
```

---

## æ€»ç»“

### å®Œæ•´çš„é«˜äº®æ ·å¼å®ç°æ¶‰åŠï¼š

1. **å‰ç«¯è¡Œä¸º** (5ä¸ªå…³é”®æ­¥éª¤)
   - é€‰æ‹©æ–‡æœ¬ (Selection API)
   - è§¦å‘å·¥å…·æ  (Font.ts)
   - åˆ›å»º Span (setInlineMark)
   - åº”ç”¨æ ·å¼ (setFontStyle)
   - æäº¤äº‹åŠ¡ (updateTransaction)

2. **API æ¥å£** (1ä¸ªæ ¸å¿ƒæ¥å£)
   - POST `/api/transactions`
   - åŒ…å« doOperations å’Œ undoOperations
   - æ”¯æŒ update/insert/delete/move æ“ä½œ

3. **åç«¯å¤„ç†** (4ä¸ªå¤„ç†å±‚)
   - API å±‚ï¼šæ¥æ”¶è¯·æ±‚
   - æ¨¡å‹å±‚ï¼šå¤„ç†äº‹åŠ¡
   - è§£æå±‚ï¼šHTML â†’ AST
   - ç´¢å¼•å±‚ï¼šAST â†’ æ•°æ®åº“

4. **æ•°æ®åº“æ“ä½œ** (3ä¸ªè¡¨ + æ‰¹é‡æ’å…¥)
   - blocksï¼šå­˜å‚¨å®Œæ•´å—å†…å®¹
   - spansï¼šå­˜å‚¨è¡Œçº§å…ƒç´ ï¼ˆä¾¿äºæœç´¢ï¼‰
   - attributesï¼šå­˜å‚¨å¯æŸ¥è¯¢å±æ€§ï¼ˆä¾¿äºç­›é€‰ï¼‰

5. **æ’ä»¶å¼€å‘** (âœ… å¯å¤ç”¨ + âŒ ä¸å¯å¤ç”¨)
   - âœ… å¯ä»¥ï¼šåŠ«æŒå·¥å…·æ ã€æ‰©å±•é¢œè‰²ã€æ·»åŠ å¿«æ·é”®ã€ä½¿ç”¨ API
   - âŒ ä¸èƒ½ï¼šç›´æ¥æ“ä½œæ•°æ®åº“ã€ä¿®æ”¹åç«¯é€»è¾‘

6. **å…¶ä»–é‡è¦ä¿¡æ¯**
   - IAL (Inline Attribute List) æ˜¯æ ¸å¿ƒæ¦‚å¿µ
   - å±æ€§åŒé‡å­˜å‚¨ï¼šspans.ial + attributes è¡¨
   - span å±æ€§å…³è”åˆ°çˆ¶å—ï¼Œä¸æ˜¯ span è‡ªèº«
   - æ‰¹é‡æ“ä½œä¼˜äºå•ä¸ªæ“ä½œ
   - å¿…é¡»ä½¿ç”¨æ ‡å‡†çš„ HTML ç»“æ„å’Œå±æ€§å

### ä½ çš„æ’ä»¶å¯ä»¥åšä»€ä¹ˆï¼Ÿ

1. **æ‰©å±•é¢œè‰²é€‰æ‹©å™¨** - æ·»åŠ æ›´å¤šé¢„è®¾é¢œè‰²
2. **é«˜äº®æ¨¡æ¿** - ä¸€é”®åº”ç”¨é¢„è®¾æ ·å¼ç»„åˆ
3. **å¿«æ·é”®** - Ctrl+Shift+æ•°å­—é”®å¿«é€Ÿåº”ç”¨é¢œè‰²
4. **ç»Ÿè®¡é¢æ¿** - æ˜¾ç¤ºé«˜äº®ä½¿ç”¨æƒ…å†µ
5. **æ‰¹é‡æ“ä½œ** - æ‰¹é‡ä¿®æ”¹/æ¸…é™¤é«˜äº®
6. **å¯¼å‡ºåŠŸèƒ½** - å¯¼å‡ºé«˜äº®ç¬”è®°ä¸º HTML/PDF

æ‰€æœ‰è¿™äº›éƒ½å¯ä»¥é€šè¿‡åŠ«æŒå·¥å…·æ  + è°ƒç”¨ `/api/transactions` å®ç°ï¼Œæ— éœ€ä¿®æ”¹æ€æºæ ¸å¿ƒä»£ç ï¼

