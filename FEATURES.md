# 高亮助手功能详解

> 一个专为思源笔记手机版设计的高亮和备注工具，提供类似微信读书的阅读体验

## 🎯 核心功能

### 1. 📝 文本高亮功能

**功能描述：**
选中任意文本即可进行多彩高亮标记，支持4种预设颜色，操作简单直观。

**使用方式：**
1. 在思源笔记手机版中选中任意文本
2. 自动弹出浮动工具栏
3. 点击颜色按钮即可应用高亮
4. 高亮文本支持后续编辑和删除

**支持颜色：**
- 🟡 **黄色高亮**：适合重要内容标记
- 🔵 **蓝色高亮**：适合概念和定义
- 🟢 **绿色高亮**：适合正面信息和成功案例
- 🔴 **粉色高亮**：适合警告和注意事项

### 2. 💭 智能备注功能

**功能描述：**
为任意文本添加个人想法和备注，支持查看、编辑和删除，构建个人知识体系。

**使用方式：**
1. 选中文本后点击备注按钮（💭）
2. 在自定义弹窗中输入备注内容
3. 备注文本会显示特殊样式（下划线+小图标）
4. 点击已有备注可编辑或删除

**备注特性：**
- 📱 **手机优化**：底部弹出式输入界面
- 🎨 **引用显示**：自动显示被备注的原文
- ✏️ **支持编辑**：随时修改已有备注内容
- 🗑️ **安全删除**：二次确认防止误删

### 3. 🔄 状态管理功能

**功能描述：**
完善的高亮和备注状态管理，支持修改、删除、批量操作等。

**管理操作：**
- **修改颜色**：点击已高亮文本可更换颜色
- **删除高亮**：白色按钮可移除所有高亮格式
- **编辑备注**：点击备注文本可修改内容
- **删除备注**：在编辑界面可删除备注（保留原文）

### 4. 📱 移动端优化

**功能描述：**
专为手机版思源设计的交互体验，确保在小屏幕上的最佳使用效果。

**优化特性：**
- **浮动工具栏**：跟随选择自动定位
- **防溢出设计**：自动调整位置避免超出屏幕
- **触摸友好**：按钮大小适合手指操作
- **自动隐藏**：点击外部区域自动隐藏工具栏

### 5. 🌙 主题适配功能

**功能描述：**
完美适配思源笔记的明暗主题切换，确保在任何主题下都有良好的视觉效果。

**适配特性：**
- **颜色自适应**：高亮颜色在明暗主题下自动调整
- **界面协调**：弹窗和工具栏使用思源主题色
- **对比度优化**：确保文本在任何背景下都清晰可读
- **动画一致**：与思源原生动画风格保持一致

## 🛠 技术实现

### 1. 工具栏劫持技术

**实现原理：**
通过劫持思源原生的 `toolbar.showContent` 方法，在原有工具栏基础上添加高亮功能按钮。

**技术特点：**
- **无缝集成**：不破坏原有功能，只是增强
- **智能检测**：自动识别手机版环境
- **状态管理**：完善的劫持状态控制，支持启动和停止
- **内存安全**：自动清理事件监听器，避免内存泄漏

**核心代码逻辑：**
```javascript
// 保存原始方法
this.originalShowContent = editor.protyle.toolbar.showContent;

// 劫持并增强
editor.protyle.toolbar.showContent = function(protyle, range, nodeElement) {
    // 先调用原始方法
    hijacker.originalShowContent.call(this, protyle, range, nodeElement);
    
    // 延迟增强工具栏
    setTimeout(() => {
        hijacker.enhanceToolbarForMobile(this, range, nodeElement, protyle);
    }, 50);
};
```

### 2. Markdown 格式保留

**实现原理：**
使用思源的 `getBlockKramdown` API 获取原始 Markdown 内容，在修改时保留格式标记。

**解决的问题：**
- 保留标题格式（`#`, `##`, `###`）
- 保留列表格式（`-`, `*`, `1.`）
- 保留其他 Markdown 语法

**技术流程：**
```javascript
// 1. 获取原始 Markdown
const response = await this.api.getBlockKramdown(blockId);
const originalMarkdown = response.data.kramdown;

// 2. 从 DOM 提取修改后的内容
const modifiedHtml = contentDiv.innerHTML;

// 3. 智能合并
const mergedContent = this.mergeHighlightIntoMarkdown(originalMarkdown, blockElement);

// 4. 保存回思源
await this.api.updateBlock(blockId, mergedContent, "markdown");
```

### 3. 原生弹窗拦截

**实现原理：**
通过事件捕获机制拦截思源原生的备注弹窗，替换为自定义的手机友好界面。

**拦截策略：**
- **DOM 事件拦截**：监听 `data-type="inline-memo"` 元素的点击
- **方法替换**：拦截可能的 `prompt` 等原生弹窗方法
- **事件阻止**：使用 `preventDefault` 和 `stopPropagation` 阻止原生行为

**自定义界面特点：**
- **Bottom Sheet 设计**：从底部滑出的现代化界面
- **响应式布局**：适配不同屏幕尺寸
- **平滑动画**：300ms 的滑入滑出动画
- **主题兼容**：使用思源的 CSS 变量

### 4. 只读状态保护

**实现原理：**
在每次操作完成后自动恢复块的只读状态，确保阅读模式的一致性。

**保护机制：**
```javascript
// 操作完成后延迟恢复只读状态
setTimeout(() => this.restoreReadOnlyState(blockId), 100);

// 恢复方法
private restoreReadOnlyState(blockId: string): void {
    const blockElement = document.querySelector(`[data-node-id="${blockId}"]`);
    
    // 将所有可编辑元素设置为只读
    const editableDivs = blockElement.querySelectorAll('div[contenteditable="true"]');
    editableDivs.forEach(div => {
        div.setAttribute('contenteditable', 'false');
    });
}
```

### 5. 智能状态重置

**实现原理：**
每次工具栏显示时自动重置状态，解决工具栏只能使用一次的问题。

**重置机制：**
- **可见性重置**：清除之前的 `display: none` 状态
- **按钮清理**：移除之前添加的按钮，避免重复
- **事件清理**：清理旧的事件监听器
- **状态恢复**：确保工具栏处于可用状态

## 🎨 用户体验设计

### 界面设计理念

1. **极简主义**：移除所有不必要的文字和装饰
2. **直觉操作**：颜色按钮直接显示效果，无需说明
3. **一致性**：与思源原生界面风格保持一致
4. **响应式**：适配各种屏幕尺寸和方向

### 交互流程优化

1. **选择 → 操作 → 完成**：三步完成所有操作
2. **自动隐藏**：操作完成后工具栏自动隐藏
3. **状态反馈**：通过视觉变化提供即时反馈
4. **错误恢复**：操作失败时自动回滚

### 性能优化

1. **轻量级**：插件体积仅 28KB，加载迅速
2. **按需加载**：只在手机版环境下激活
3. **内存管理**：完善的事件监听器清理机制
4. **DOM 优化**：最小化 DOM 操作，保持流畅性

## 🔧 兼容性说明

### 支持环境
- ✅ **iOS Safari**：完美支持
- ✅ **Android Chrome**：完美支持  
- ✅ **移动浏览器**：完美支持
- ❌ **桌面版**：暂不支持（专为移动端设计）

### 思源版本要求
- **最低版本**：思源笔记 v3.2.1+
- **推荐版本**：最新版本以获得最佳体验

### 已知限制
- 仅支持手机版环境
- 需要网络连接（调用思源API）
- 部分第三方主题可能需要样式调整

## 🚀 未来规划

### 计划功能
- [ ] 更多高亮颜色选择



---

*本插件专注于提供最佳的移动端高亮和备注体验，让思源笔记的阅读更加高效和愉悦。*
