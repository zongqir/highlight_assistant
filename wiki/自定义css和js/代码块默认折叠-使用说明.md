# 思源笔记 - 代码块默认折叠功能

## 📌 功能介绍

这个脚本可以让思源笔记中的所有代码块默认处于折叠状态，提供更简洁的阅读体验。主要特性：

- ✅ 代码块默认折叠，只显示前几行
- ✅ 点击按钮即可展开/收起
- ✅ 平滑的动画过渡效果
- ✅ 渐变遮罩提示有更多内容
- ✅ 自动监听动态加载的代码块
- ✅ 短代码块自动跳过（不折叠）

## 🚀 使用方法

### 方法一：通过思源设置添加（推荐）

1. 打开思源笔记
2. 进入 **设置** → **外观** → **代码片段**
3. 点击 **JS** 标签页
4. 将 `代码块默认折叠.js` 文件中的代码粘贴进去
5. 保存并重启思源笔记

### 方法二：通过主题配置添加

1. 找到你的主题文件夹
2. 在主题的 `theme.js` 文件中引入这段代码
3. 重新加载主题

### 方法三：独立JS文件引入

1. 将 `代码块默认折叠.js` 放到思源的某个位置
2. 在需要的地方通过 `<script>` 标签引入

## ⚙️ 配置选项

脚本开头有一个 `CONFIG` 对象，你可以根据需要修改：

```javascript
const CONFIG = {
    defaultCollapsed: true,        // 默认是否折叠（true/false）
    showLineCount: 3,              // 折叠时显示的行数
    animationDuration: 300,        // 展开/收起动画时长（毫秒）
    toggleButtonText: '▼ 展开代码', // 展开按钮文字
    collapseButtonText: '▲ 收起代码', // 收起按钮文字
    buttonPosition: 'top-right',   // 按钮位置: 'top-right', 'top-left', 'bottom-right', 'bottom-left'
};
```

### 配置说明

- **defaultCollapsed**: 设置为 `false` 可以让代码块默认展开
- **showLineCount**: 折叠时显示的行数，建议 2-5 行
- **animationDuration**: 动画时长，单位毫秒，建议 200-500
- **toggleButtonText**: 自定义按钮文字，支持 emoji
- **buttonPosition**: 按钮位置，有四个选项：
  - `top-right`: 右上角（默认）
  - `top-left`: 左上角
  - `bottom-right`: 右下角
  - `bottom-left`: 左下角

## 🎨 自定义样式

如果你想自定义按钮样式，可以修改脚本中的 `toggleButton.style` 部分，或者通过 CSS 覆盖：

```css
/* 自定义折叠按钮样式 */
.code-collapse-toggle {
    background-color: #your-color !important;
    color: #your-text-color !important;
    border-radius: 8px !important;
    font-size: 14px !important;
}

/* 悬停效果 */
.code-collapse-toggle:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2) !important;
}
```

## 🔧 工作原理

1. **自动扫描**: 脚本会自动扫描页面中所有的 `.code-block` 元素
2. **判断长度**: 只对超过指定行数的代码块添加折叠功能
3. **添加按钮**: 为每个代码块添加折叠/展开按钮
4. **监听变化**: 使用 MutationObserver 监听 DOM 变化，自动处理新加载的代码块
5. **避免重复**: 使用 WeakSet 记录已处理的代码块，避免重复处理

## 📝 注意事项

- 脚本会自动跳过行数较少的代码块（默认 ≤3 行）
- 折叠按钮位于代码块右上角，不影响复制和其他操作
- 展开后代码块会恢复完整高度，可以正常滚动
- 兼容思源笔记的代码高亮功能

## 🐛 常见问题

### Q: 脚本不生效怎么办？
A: 
1. 检查浏览器控制台是否有错误信息
2. 确认已重启思源笔记
3. 查看控制台是否有 "📦 代码块默认折叠脚本已加载" 的提示

### Q: 某些代码块没有折叠按钮？
A: 
- 如果代码块行数少于配置的 `showLineCount`，不会添加折叠功能
- 检查该代码块是否有 `.code-block` 和 `.hljs` 类

### Q: 按钮位置不合适怎么办？
A: 
- 修改 `CONFIG.buttonPosition` 选项
- 或者通过 CSS 自定义按钮的 `top`、`right`、`bottom`、`left` 属性

### Q: 想要默认展开怎么办？
A: 
- 将 `CONFIG.defaultCollapsed` 设置为 `false`

### Q: 发现.sy文件中有残留的按钮代码怎么办？
A: 
1. **自动清理**（推荐）：更新到 v1.0.1 版本后，脚本会在加载时自动清理残留元素
2. **手动清理**：如果自动清理没生效，可以：
   - 在代码块所在文档中，手动删除并重新创建代码块
   - 或者直接编辑.sy文件，删除包含 `code-collapse-toggle` 和 `code-collapse-fade` 的HTML标签
3. **预防措施**：确保使用的是最新版本（v1.0.1+），该版本已添加 `contenteditable="false"` 防止持久化

## 🎯 效果预览

**折叠状态**：
```
[代码块顶部]
line 1
line 2  
line 3
[渐变遮罩...]          [▼ 展开代码]
```

**展开状态**：
```
[代码块顶部]
line 1
line 2  
line 3
line 4
line 5
...
[所有代码行]          [▲ 收起代码]
```

## 📄 版本信息

- **版本**: v1.0.1
- **作者**: AI Assistant
- **最后更新**: 2025-10-05
- **兼容性**: 思源笔记 v2.x+

## 🔧 更新日志

### v1.0.1 (2025-10-05)
- 🐛 **修复重大BUG**: 修复UI元素被持久化到文档的问题
  - 给所有动态创建的UI元素添加 `contenteditable="false"` 属性
  - 添加 `data-type="ui-element"` 标记，明确标识为UI元素
  - 添加初始化时的自动清理机制，清除被误保存的UI元素
  - 在每次处理代码块前都会先清理残留元素

**重要**: 如果你之前使用过旧版本，建议更新后手动检查并清理.sy文件中可能残留的按钮和遮罩层代码。

### v1.0.0 (2025-10-04)
- ✨ 首次发布：代码块默认折叠功能

## 📜 许可证

MIT License - 自由使用、修改和分发

---

**提示**: 如有问题或建议，欢迎反馈！

