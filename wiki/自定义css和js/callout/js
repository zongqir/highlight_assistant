(function() {
    'use strict';

    console.log('=== Optimized SiYuan BlockQuote Enhanced Script ===');

    // ==================== è‡ªå®šä¹‰æ ·å¼æ£€æµ‹ ====================
  
    // æ£€æŸ¥æ˜¯å¦ä¸ºè‡ªå®šä¹‰æ ·å¼çš„ BlockQuote
    function hasCustomStyle(blockQuote) {
        if (!blockQuote) return false;
      
        // æ£€æŸ¥ custom-b å±æ€§
        const customB = blockQuote.getAttribute('custom-b');
        if (customB) {
            const customBTypes = ['info', 'light', 'bell', 'check', 'question', 'warn', 'wrong', 'bug', 'note', 'pen'];
            if (customBTypes.includes(customB)) {
                return true;
            }
        }
      
        // æ£€æŸ¥ custom-callout å±æ€§
        const customCallout = blockQuote.getAttribute('custom-callout');
        if (customCallout === 'ä¹¦ç­¾') {
            return true;
        }
      
        return false;
    }

    // ==================== å‘½ä»¤èœå•éƒ¨åˆ† ====================
  
    // å‘½ä»¤å®šä¹‰ï¼ˆèœå•ç”¨ï¼‰
    const menuCommands = [
        {
            command: '@info',
            displayName: 'ä¿¡æ¯è¯´æ˜',
            icon: `<svg width="24" height="24" viewBox="0 0 24 24" fill="white" overflow="visible"><circle cx="12" cy="12" r="10" stroke="#4493f8" stroke-width="1.7" fill="white"/><rect x="11" y="7" width="2" height="7" rx="1" fill="#4493f8"/><circle cx="12" cy="17" r="1.2" fill="#4493f8"/></svg>`,
            color: '#4493f8'
        },
        {
            command: '@concept',
            displayName: 'æ¦‚å¿µè§£é‡Š',
            icon: `<svg width="24" height="24" viewBox="0 0 24 24" fill="white" overflow="visible"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" stroke="#9333ea" stroke-width="1.5" fill="none"/></svg>`,
            color: '#9333ea'
        },
        {
            command: '@example',
            displayName: 'ç¤ºä¾‹æ¼”ç¤º',
            icon: `<svg width="24" height="24" viewBox="0 0 24 24" fill="white" overflow="visible"><rect x="3" y="3" width="18" height="18" rx="2" stroke="#10b981" stroke-width="1.5" fill="none"/><path d="M8 10h8M8 14h5" stroke="#10b981" stroke-width="1.5" stroke-linecap="round"/></svg>`,
            color: '#10b981'
        },
        {
            command: '@tip',
            displayName: 'ä½¿ç”¨æŠ€å·§',
            icon: `<svg width="24" height="24" viewBox="0 0 24 24" fill="white" overflow="visible"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" stroke="#84cc16" stroke-width="1.5" fill="none"/></svg>`,
            color: '#84cc16'
        },
        {
            command: '@best-practice',
            displayName: 'æœ€ä½³å®è·µ',
            icon: `<svg width="24" height="24" viewBox="0 0 24 24" fill="white" overflow="visible"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="#059669" stroke-width="1.5" fill="none"/></svg>`,
            color: '#059669'
        },
        {
            command: '@tradeoff',
            displayName: 'æƒè¡¡å–èˆ',
            icon: `<svg width="24" height="24" viewBox="0 0 24 24" fill="white" overflow="visible"><path d="M3 12h18M12 3v18" stroke="#ea580c" stroke-width="1.5"/><circle cx="7" cy="7" r="2" fill="#ea580c"/><circle cx="17" cy="17" r="2" fill="#ea580c"/></svg>`,
            color: '#ea580c'
        },
        {
            command: '@deep-dive',
            displayName: 'æ·±æ°´åŒº',
            icon: `<svg width="24" height="24" viewBox="0 0 24 24" fill="white" overflow="visible"><path d="M12 3v18m0 0l-6-6m6 6l6-6" stroke="#1e40af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M3 8h18" stroke="#1e40af" stroke-width="1.5" stroke-linecap="round"/></svg>`,
            color: '#1e40af'
        },
        {
            command: '@comparison',
            displayName: 'å¯¹æ¯”åˆ†æ',
            icon: `<svg width="24" height="24" viewBox="0 0 24 24" fill="white" overflow="visible"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" stroke="#6366f1" stroke-width="1.5" fill="none"/><path d="M9 12h6M9 16h6" stroke="#6366f1" stroke-width="1.5" stroke-linecap="round"/></svg>`,
            color: '#6366f1'
        },
        {
            command: '@summary',
            displayName: 'ç« èŠ‚æ€»ç»“',
            icon: `<svg width="24" height="24" viewBox="0 0 24 24" fill="white" overflow="visible"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" stroke="#06b6d4" stroke-width="1.5" fill="none"/></svg>`,
            color: '#06b6d4'
        },
        {
            command: '@pitfall',
            displayName: 'å¸¸è§é™·é˜±',
            icon: `<svg width="24" height="24" viewBox="0 0 24 24" fill="white" overflow="visible"><path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" stroke="#dc2626" stroke-width="1.5" fill="none"/></svg>`,
            color: '#dc2626'
        }
    ];

    // èœå•çŠ¶æ€ç®¡ç†
    let commandMenu = null;
    let isMenuVisible = false;
    let isProcessingEvent = false;
    let trackedBlockQuotes = new Set();
    let recentlyCreatedBlockQuotes = new Set();
    let currentTargetBlockQuote = null;
    let selectedMenuIndex = 0;
    let menuItems = [];

    // ==================== Callout å¤„ç†éƒ¨åˆ† ====================
  
    // Callout ç±»å‹å®šä¹‰ï¼ˆå¤„ç†å™¨ç”¨ï¼‰
    const calloutTypes = {
        '@info': { type: 'info', displayName: 'ä¿¡æ¯è¯´æ˜' },
        '@ä¿¡æ¯': { type: 'info', displayName: 'ä¿¡æ¯è¯´æ˜' },
        '@concept': { type: 'concept', displayName: 'æ¦‚å¿µè§£é‡Š' },
        '@æ¦‚å¿µ': { type: 'concept', displayName: 'æ¦‚å¿µè§£é‡Š' },
        '@example': { type: 'example', displayName: 'ç¤ºä¾‹æ¼”ç¤º' },
        '@ç¤ºä¾‹': { type: 'example', displayName: 'ç¤ºä¾‹æ¼”ç¤º' },
        '@tip': { type: 'tip', displayName: 'ä½¿ç”¨æŠ€å·§' },
        '@æŠ€å·§': { type: 'tip', displayName: 'ä½¿ç”¨æŠ€å·§' },
        '@best-practice': { type: 'best-practice', displayName: 'æœ€ä½³å®è·µ' },
        '@æœ€ä½³å®è·µ': { type: 'best-practice', displayName: 'æœ€ä½³å®è·µ' },
        '@tradeoff': { type: 'tradeoff', displayName: 'æƒè¡¡å–èˆ' },
        '@å–èˆ': { type: 'tradeoff', displayName: 'æƒè¡¡å–èˆ' },
        '@æƒè¡¡å–èˆ': { type: 'tradeoff', displayName: 'æƒè¡¡å–èˆ' },
        '@deep-dive': { type: 'deep-dive', displayName: 'æ·±æ°´åŒº' },
        '@æ·±å…¥': { type: 'deep-dive', displayName: 'æ·±æ°´åŒº' },
        '@æ·±æ°´åŒº': { type: 'deep-dive', displayName: 'æ·±æ°´åŒº' },
        '@comparison': { type: 'comparison', displayName: 'å¯¹æ¯”åˆ†æ' },
        '@å¯¹æ¯”': { type: 'comparison', displayName: 'å¯¹æ¯”åˆ†æ' },
        '@å¯¹æ¯”åˆ†æ': { type: 'comparison', displayName: 'å¯¹æ¯”åˆ†æ' },
        '@summary': { type: 'summary', displayName: 'ç« èŠ‚æ€»ç»“' },
        '@æ€»ç»“': { type: 'summary', displayName: 'ç« èŠ‚æ€»ç»“' },
        '@ç« èŠ‚æ€»ç»“': { type: 'summary', displayName: 'ç« èŠ‚æ€»ç»“' },
        '@pitfall': { type: 'pitfall', displayName: 'å¸¸è§é™·é˜±' },
        '@é™·é˜±': { type: 'pitfall', displayName: 'å¸¸è§é™·é˜±' },
        '@å¸¸è§é™·é˜±': { type: 'pitfall', displayName: 'å¸¸è§é™·é˜±' }
    };

    // ==================== å‘½ä»¤èœå•åŠŸèƒ½ ====================

    // æ›´æ–°é€‰ä¸­çš„èœå•é¡¹
    function updateMenuSelection(immediate = false) {
        const doUpdate = () => {
            menuItems.forEach((item, index) => {
                if (index === selectedMenuIndex) {
                    item.style.backgroundColor = '#dbeafe';
                    item.style.borderColor = '#60a5fa';
                    item.style.transform = 'scale(1.02)';
                    // åªåœ¨éœ€è¦æ—¶æ‰æ»šåŠ¨ï¼Œä¸”ä½¿ç”¨ instant é¿å…åŠ¨ç”»å†²çª
                    if (commandMenu) {
                        const itemRect = item.getBoundingClientRect();
                        const menuRect = commandMenu.getBoundingClientRect();
                        if (itemRect.top < menuRect.top || itemRect.bottom > menuRect.bottom) {
                            item.scrollIntoView({ block: 'nearest', behavior: 'instant' });
                        }
                    }
                } else {
                    item.style.backgroundColor = '';
                    item.style.borderColor = '#f3f4f6';
                    item.style.transform = 'scale(1)';
                }
            });
        };
        
        if (immediate) {
            doUpdate();
        } else {
            requestAnimationFrame(doUpdate);
        }
    }

    // é€‰æ‹©å½“å‰é«˜äº®çš„èœå•é¡¹
    function selectCurrentMenuItem() {
        if (menuItems[selectedMenuIndex]) {
            menuItems[selectedMenuIndex].click();
        }
    }

    // åˆ›å»ºå‘½ä»¤èœå•
    function createCommandMenu(targetBlockQuote) {
        if (commandMenu) return commandMenu;

        currentTargetBlockQuote = targetBlockQuote;
        selectedMenuIndex = 0;
        menuItems = [];
        
        commandMenu = document.createElement('div');
        commandMenu.setAttribute('tabindex', '0'); // è®©èœå•å¯ä»¥è·å¾—ç„¦ç‚¹
        commandMenu.style.cssText = `
            position: fixed;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            max-height: 500px;
            overflow-y: auto;
            z-index: 10000;
            font-size: 14px;
            min-width: 520px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.15s cubic-bezier(0.4, 0, 0.2, 1), transform 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            outline: none;
            will-change: opacity, transform;
        `;

        // å…³é—­æŒ‰é’®
        const closeButton = document.createElement('div');
        closeButton.style.cssText = `
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            color: #6b7280;
            transition: all 0.15s ease;
            z-index: 1;
        `;
        closeButton.innerHTML = 'Ã—';
        closeButton.addEventListener('mouseenter', () => {
            closeButton.style.background = '#ef4444';
            closeButton.style.color = 'white';
        });
        closeButton.addEventListener('mouseleave', () => {
            closeButton.style.background = '#f3f4f6';
            closeButton.style.color = '#6b7280';
        });
        closeButton.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            hideCommandMenu(true);
        });
        commandMenu.appendChild(closeButton);

        // æ ‡é¢˜
        const header = document.createElement('div');
        header.style.cssText = `
            padding: 12px 40px 12px 16px;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            font-size: 13px;
            color: #6b7280;
            font-weight: 600;
        `;
        header.innerHTML = '<div>Callout å‘½ä»¤èœå•</div>';
        commandMenu.appendChild(header);

        // åˆ›å»ºç½‘æ ¼å®¹å™¨
        const gridContainer = document.createElement('div');
        gridContainer.style.cssText = `
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 4px;
            padding: 8px;
        `;

        // å‘½ä»¤é€‰é¡¹
        menuCommands.forEach((cmd, index) => {
            const item = document.createElement('div');
            item.style.cssText = `
                padding: 10px 12px;
                cursor: pointer;
                border: 1px solid #f3f4f6;
                border-radius: 6px;
                display: flex;
                align-items: center;
                gap: 10px;
                transition: background-color 0.1s ease, transform 0.1s ease, border-color 0.1s ease;
            `;
          
            item.innerHTML = `
                <span style="width:20px;height:20px;display:flex;align-items:center;justify-content:center;flex-shrink:0;">${cmd.icon}</span>
                <div style="flex: 1; min-width: 0;">
                    <div style="font-weight: 500; color: #374151; font-size: 13px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${cmd.command}</div>
                    <div style="color: #6b7280; font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${cmd.displayName}</div>
                </div>
            `;
          
            item.addEventListener('mouseenter', () => {
                selectedMenuIndex = index; // åŒæ­¥æ›´æ–°é€‰ä¸­ç´¢å¼•
                updateMenuSelection();
            });
          
            item.addEventListener('mouseleave', () => {
                // é¼ æ ‡ç¦»å¼€æ—¶ä¿æŒé”®ç›˜é€‰ä¸­çŠ¶æ€
            });
          
            item.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                item.style.backgroundColor = '#dbeafe';
                item.style.color = '#1e40af';
                insertCommandToBlockQuote(cmd.command, currentTargetBlockQuote);
                setTimeout(() => hideCommandMenu(true), 300);
            });
          
            menuItems.push(item); // ä¿å­˜èœå•é¡¹å¼•ç”¨
            gridContainer.appendChild(item);
        });
        
        // å°†ç½‘æ ¼å®¹å™¨æ·»åŠ åˆ°èœå•
        commandMenu.appendChild(gridContainer);

        // åº•éƒ¨æç¤º
        const footer = document.createElement('div');
        footer.style.cssText = `
            padding: 8px 16px;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
            font-size: 11px;
            color: #9ca3af;
            text-align: center;
        `;
        footer.innerHTML = 'â†‘â†“â†â†’ å¯¼èˆª â€¢ Enter ç¡®è®¤ â€¢ ESC å…³é—­';
        commandMenu.appendChild(footer);

        // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬ï¼ˆæ”¯æŒä¸Šä¸‹å·¦å³å¯¼èˆªï¼‰
        commandMenu.addEventListener('keydown', (e) => {
            const cols = 2; // åˆ—æ•°
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                // å‘ä¸‹ç§»åŠ¨2è¡Œï¼ˆå› ä¸ºæ˜¯2åˆ—ï¼‰
                selectedMenuIndex = Math.min(selectedMenuIndex + cols, menuItems.length - 1);
                updateMenuSelection();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                // å‘ä¸Šç§»åŠ¨2è¡Œ
                selectedMenuIndex = Math.max(selectedMenuIndex - cols, 0);
                updateMenuSelection();
            } else if (e.key === 'ArrowRight') {
                e.preventDefault();
                // å‘å³ç§»åŠ¨
                selectedMenuIndex = Math.min(selectedMenuIndex + 1, menuItems.length - 1);
                updateMenuSelection();
            } else if (e.key === 'ArrowLeft') {
                e.preventDefault();
                // å‘å·¦ç§»åŠ¨
                selectedMenuIndex = Math.max(selectedMenuIndex - 1, 0);
                updateMenuSelection();
            } else if (e.key === 'Enter') {
                e.preventDefault();
                selectCurrentMenuItem();
            } else if (e.key === 'Escape') {
                e.preventDefault();
                hideCommandMenu(true);
            }
        });

        document.body.appendChild(commandMenu);
        
        return commandMenu;
    }

    // æ’å…¥å‘½ä»¤å¹¶è‡ªåŠ¨æ¢è¡Œ
    function insertCommandToBlockQuote(command, blockQuoteElement) {
        if (!blockQuoteElement) return false;

        const editableDiv = blockQuoteElement.querySelector('[contenteditable="true"]');
        if (!editableDiv) return false;

        try {
            editableDiv.textContent = command;
          
            // è§¦å‘äº‹ä»¶ï¼Œè®© Callout å¤„ç†å™¨çŸ¥é“å†…å®¹å·²æ›´æ”¹
            editableDiv.dispatchEvent(new Event('input', { bubbles: true }));
            editableDiv.dispatchEvent(new Event('change', { bubbles: true }));

            // è®¾ç½®å…‰æ ‡å¹¶è‡ªåŠ¨æ¢è¡Œ
            setTimeout(() => {
                editableDiv.focus();
              
                const range = document.createRange();
                const selection = window.getSelection();
              
                if (editableDiv.childNodes.length > 0) {
                    const lastNode = editableDiv.childNodes[editableDiv.childNodes.length - 1];
                    if (lastNode.nodeType === Node.TEXT_NODE) {
                        range.setStart(lastNode, lastNode.textContent.length);
                        range.setEnd(lastNode, lastNode.textContent.length);
                    } else {
                        range.setStartAfter(lastNode);
                        range.setEndAfter(lastNode);
                    }
                } else {
                    range.selectNodeContents(editableDiv);
                    range.collapse(false);
                }
              
                selection.removeAllRanges();
                selection.addRange(range);
              
                // è‡ªåŠ¨æ¢è¡Œ
                setTimeout(() => {
                    editableDiv.dispatchEvent(new KeyboardEvent('keydown', {
                        key: 'Enter', code: 'Enter', keyCode: 13, bubbles: true
                    }));
                    editableDiv.dispatchEvent(new KeyboardEvent('keyup', {
                        key: 'Enter', code: 'Enter', keyCode: 13, bubbles: true
                    }));
                  
                    // å»¶è¿Ÿå¤„ç† Calloutï¼Œç¡®ä¿å†…å®¹å·²æ›´æ–°
                    setTimeout(() => {
                        processBlockquote(blockQuoteElement);
                    }, 200);
                }, 100);
            }, 150);

            return true;
        } catch (error) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(command);
            }
            return false;
        }
    }

    // æ˜¾ç¤ºèœå•
    function showCommandMenu(x, y, blockQuoteElement) {
        if (isProcessingEvent || isMenuVisible) return;
      
        // æ£€æŸ¥æ˜¯å¦ä¸ºè‡ªå®šä¹‰æ ·å¼çš„ BlockQuote
        if (hasCustomStyle(blockQuoteElement)) {
            console.log('Skipping custom styled blockquote:', blockQuoteElement);
            return;
        }
      
        isProcessingEvent = true;
        const menu = createCommandMenu(blockQuoteElement);

        // è·å–èœå•å°ºå¯¸
        menu.style.left = '0px';
        menu.style.top = '0px';
        menu.style.visibility = 'hidden';
        menu.style.opacity = '1';
        menu.style.pointerEvents = 'auto';

        requestAnimationFrame(() => {
            const menuRect = menu.getBoundingClientRect();
            const menuHeight = menuRect.height;
            const menuWidth = menuRect.width;
          
            let menuX = x;
            let menuY = y;
          
            if (blockQuoteElement) {
                const blockRect = blockQuoteElement.getBoundingClientRect();
                menuX = blockRect.left;
                menuY = blockRect.top - menuHeight - 10;
            }

            // è¾¹ç•Œæ£€æŸ¥
            if (menuY < 10 && blockQuoteElement) {
                const blockRect = blockQuoteElement.getBoundingClientRect();
                menuY = blockRect.bottom + 10;
            }
            if (menuX + menuWidth > window.innerWidth) {
                menuX = window.innerWidth - menuWidth - 10;
            }
            if (menuY + menuHeight > window.innerHeight) {
                menuY = window.innerHeight - menuHeight - 10;
            }
            if (menuX < 10) menuX = 10;
            if (menuY < 10) menuY = 10;
          
            // è®¾ç½®ä½ç½®å¹¶æ˜¾ç¤º
            menu.style.left = menuX + 'px';
            menu.style.top = menuY + 'px';
            menu.style.visibility = 'visible';
            menu.style.opacity = '0';
            menu.style.transform = 'translateY(-10px)';
          
            // ç«‹å³æ›´æ–°é€‰ä¸­çŠ¶æ€ï¼ˆåœ¨åŠ¨ç”»ä¹‹å‰ï¼‰
            updateMenuSelection(true);
            
            // ç„¶åæ‰§è¡ŒåŠ¨ç”»
            requestAnimationFrame(() => {
                menu.style.opacity = '1';
                menu.style.transform = 'translateY(0)';
                
                // åŠ¨ç”»ç»“æŸåèšç„¦
                menu.addEventListener('transitionend', function focusMenu() {
                    menu.removeEventListener('transitionend', focusMenu);
                    menu.focus();
                }, { once: true });
            });
          
            isMenuVisible = true;
            isProcessingEvent = false;
          
            // æ ‡è®°å·²æ˜¾ç¤º
            if (blockQuoteElement) {
                const nodeId = blockQuoteElement.getAttribute('data-node-id');
                if (nodeId) {
                    recentlyCreatedBlockQuotes.add(nodeId);
                    setTimeout(() => recentlyCreatedBlockQuotes.delete(nodeId), 3000);
                }
            }
        });
    }

    // éšè—èœå•
    function hideCommandMenu(immediate = false) {
        if (!commandMenu || !isMenuVisible) return;
      
        currentTargetBlockQuote = null;
        selectedMenuIndex = 0;
        menuItems = [];
      
        if (immediate) {
            commandMenu.remove();
            commandMenu = null;
            isMenuVisible = false;
            return;
        }
      
        commandMenu.style.opacity = '0';
        commandMenu.style.transform = 'translateY(-10px)';
        commandMenu.style.pointerEvents = 'none';
      
        setTimeout(() => {
            if (commandMenu) {
                commandMenu.remove();
                commandMenu = null;
            }
            isMenuVisible = false;
        }, 200);
    }

    // ==================== Callout å¤„ç†åŠŸèƒ½ ====================

    // å¤„ç†å•ä¸ªå¼•ç”¨å—çš„å‡½æ•°
    function processBlockquote(blockquote) {
        console.log('Processing blockquote:', blockquote);
      
        // è·³è¿‡è‡ªå®šä¹‰æ ·å¼çš„ BlockQuote
        if (hasCustomStyle(blockquote)) {
            console.log('Skipping custom styled blockquote for callout processing');
            return;
        }
      
        const firstParagraph = blockquote.querySelector('div[data-type="NodeParagraph"]:first-of-type');
        if (!firstParagraph) {
            console.log('No first paragraph found');
            return;
        }

        const titleDiv = firstParagraph.querySelector('div[contenteditable="true"]');
        if (!titleDiv) {
            console.log('No contenteditable div found');
            return;
        }

        const text = titleDiv.textContent.trim();
        console.log('Current text:', text);
      
        // æ£€æŸ¥æ˜¯å¦åŒ¹é…ä»»ä½• callout ç±»å‹
        for (const [trigger, config] of Object.entries(calloutTypes)) {
            if (text.startsWith(trigger)) {
                console.log(`Match found: ${trigger} -> ${config.type}`);
              
                // è®¾ç½® callout ç±»å‹ï¼ˆä½¿ç”¨ custom-callout å±æ€§ä»¥åŒ¹é… CSSï¼‰
                blockquote.setAttribute('custom-callout', config.type);
              
                // æ ‡è®°æ ‡é¢˜å¹¶è®¾ç½®æ˜¾ç¤ºåç§°
                titleDiv.setAttribute('data-callout-title', 'true');
                titleDiv.setAttribute('data-callout-display-name', config.displayName);
              
                console.log('Callout attributes set');
                return;
            }
        }
      
        // å¦‚æœä¸åŒ¹é…ä»»ä½• callout ç±»å‹ï¼Œæ¸…é™¤ç›¸å…³å±æ€§
        if (blockquote.hasAttribute('custom-callout')) {
            console.log('Clearing callout attributes');
            blockquote.removeAttribute('custom-callout');
            titleDiv.removeAttribute('data-callout-title');
            titleDiv.removeAttribute('data-callout-display-name');
        }
    }

    // å¤„ç†æ‰€æœ‰å¼•ç”¨å—
    function processAllBlockquotes() {
        console.log('=== Processing all blockquotes ===');
        const blockquotes = document.querySelectorAll('.bq');
        console.log('Found blockquotes:', blockquotes.length);
      
        blockquotes.forEach((bq, index) => {
            if (!hasCustomStyle(bq)) {
                console.log(`Processing blockquote ${index + 1}`);
                processBlockquote(bq);
            } else {
                console.log(`Skipping custom blockquote ${index + 1}`);
            }
        });
    }

    // ==================== å…±ç”¨åŠŸèƒ½ ====================

    // æŸ¥æ‰¾ BlockQuote å…ƒç´ 
    function findSiYuanBlockQuotes() {
        const selectors = ['[data-type="NodeBlockquote"]', '.bq'];
        let allBlockQuotes = [];
      
        selectors.forEach(selector => {
            allBlockQuotes = allBlockQuotes.concat(Array.from(document.querySelectorAll(selector)));
        });
      
        return [...new Set(allBlockQuotes)];
    }

    // æ£€æŸ¥æ˜¯å¦ä¸ºç©º
    function isBlockQuoteEmpty(blockQuote) {
        const contentDiv = blockQuote.querySelector('[contenteditable="true"]');
        if (!contentDiv) return false;
      
        const text = contentDiv.textContent.trim();
        return text === '' || text.length < 3 || /^[\s\n\r]*$/.test(text);
    }

    // æ£€æŸ¥æ˜¯å¦æ–°åˆ›å»º
    function isBlockQuoteNewlyCreated(blockQuote) {
        const nodeId = blockQuote.getAttribute('data-node-id');
        if (!nodeId) return false;
      
        // è·³è¿‡è‡ªå®šä¹‰æ ·å¼çš„ BlockQuote
        if (hasCustomStyle(blockQuote)) {
            return false;
        }
      
        const wasTracked = trackedBlockQuotes.has(nodeId);
        const isEmpty = isBlockQuoteEmpty(blockQuote);
      
        return !wasTracked && isEmpty;
    }

    // ==================== ä¼˜åŒ–çš„äº‹ä»¶ç›‘å¬ç³»ç»Ÿ ====================

    // ä¼˜åŒ–çš„MutationObserver
    function setupOptimizedObserver() {
        const observer = new MutationObserver(function(mutations) {
            const relevantMutations = mutations.filter(mutation => {
                // åªå…³æ³¨æ·»åŠ èŠ‚ç‚¹çš„å˜åŒ–
                return mutation.type === 'childList' && mutation.addedNodes.length > 0;
            });

            if (relevantMutations.length === 0) return;

            let newBlockquotes = [];
          
            relevantMutations.forEach(mutation => {
                mutation.addedNodes.forEach(node => {
                    if (node.nodeType === Node.ELEMENT_NODE) {
                        // ç›´æ¥æ£€æŸ¥æ˜¯å¦æ˜¯blockquote
                        if (node.getAttribute?.('data-type') === 'NodeBlockquote' || 
                            node.classList?.contains('bq')) {
                            newBlockquotes.push(node);
                        }
                        // æ£€æŸ¥å­å…ƒç´ ä¸­çš„blockquote
                        const childBlockquotes = node.querySelectorAll?.('[data-type="NodeBlockquote"], .bq');
                        if (childBlockquotes?.length > 0) {
                            newBlockquotes.push(...Array.from(childBlockquotes));
                        }
                    }
                });
            });

            // æ‰¹é‡å¤„ç†æ–°çš„blockquote
            if (newBlockquotes.length > 0) {
                // å»é‡
                const uniqueBlockquotes = [...new Set(newBlockquotes)];
              
                setTimeout(() => {
                    uniqueBlockquotes.forEach(bq => {
                        if (!hasCustomStyle(bq)) {
                            const nodeId = bq.getAttribute('data-node-id');
                          
                            // æ ‡è®°ä¸ºå·²è·Ÿè¸ª
                            if (nodeId) {
                                trackedBlockQuotes.add(nodeId);
                            }
                          
                            // æ£€æŸ¥æ˜¯å¦ä¸ºæ–°å»ºçš„ç©ºblockquote
                            if (isBlockQuoteEmpty(bq)) {
                                const rect = bq.getBoundingClientRect();
                                if (rect.width > 0 && rect.height > 0) {
                                    showCommandMenu(rect.left, rect.top, bq);
                                }
                            }
                            // å¤„ç†callout
                            processBlockquote(bq);
                        }
                    });
                }, 50);
            }
        });

        // æ›´ç²¾ç¡®çš„è§‚å¯Ÿé…ç½®
        observer.observe(document.body, { 
            childList: true, 
            subtree: true,
            attributes: false, // ä¸è§‚å¯Ÿå±æ€§å˜åŒ–
            characterData: false // ä¸è§‚å¯Ÿæ–‡æœ¬å˜åŒ–
        });

        return observer;
    }

    // åŸºäºç„¦ç‚¹çš„æ£€æµ‹
    function setupFocusBasedDetection() {
        let lastFocusedElement = null;
      
        document.addEventListener('focusin', (e) => {
            const target = e.target;
          
            // æ£€æŸ¥æ˜¯å¦èšç„¦åˆ°blockquoteå†…çš„å¯ç¼–è¾‘å…ƒç´ 
            if (target.contentEditable === 'true') {
                const blockquote = target.closest('[data-type="NodeBlockquote"], .bq');
                if (blockquote && !hasCustomStyle(blockquote)) {
                    // å¦‚æœæ˜¯æ–°çš„ç©ºblockquoteï¼Œæ˜¾ç¤ºèœå•
                    if (isBlockQuoteEmpty(blockquote) && lastFocusedElement !== target) {
                        const nodeId = blockquote.getAttribute('data-node-id');
                        if (nodeId && !recentlyCreatedBlockQuotes.has(nodeId)) {
                            const rect = blockquote.getBoundingClientRect();
                            showCommandMenu(rect.left, rect.top, blockquote);
                        }
                    }
                    lastFocusedElement = target;
                }
            }
        });
    }

    // äº‹ä»¶é©±åŠ¨çš„calloutå¤„ç†
    function setupEventDrivenSystem() {
        // ä½¿ç”¨é˜²æŠ–çš„è¾“å…¥ç›‘å¬
        let inputTimeout;
      
        ['input', 'keyup', 'paste'].forEach(eventType => {
            document.addEventListener(eventType, function(e) {
                // æ£€æŸ¥æ˜¯å¦åœ¨å¯ç¼–è¾‘å…ƒç´ ä¸­
                if (e.target.contentEditable === 'true') {
                    clearTimeout(inputTimeout);
                    inputTimeout = setTimeout(() => {
                        // æŸ¥æ‰¾æœ€è¿‘çš„å¼•ç”¨å—çˆ¶å…ƒç´ 
                        const blockquote = e.target.closest('[data-type="NodeBlockquote"], .bq');
                        if (blockquote && !hasCustomStyle(blockquote)) {
                            processBlockquote(blockquote);
                        }
                    }, eventType === 'paste' ? 100 : 300); // é˜²æŠ–300msï¼Œç²˜è´´100ms
                }
            }, true);
        });
    }

    // ğŸ”¥ ä¿®å¤ï¼šæ€æºAPIç›‘å¬ï¼ˆå®‰å…¨ç‰ˆæœ¬ï¼‰
    function setupSiYuanAPIListener() {
        try {
            // æ£€æŸ¥æ€æºAPIæ˜¯å¦å¯ç”¨
            if (typeof window.siyuan === 'object' && window.siyuan !== null) {
                console.log('SiYuan API detected');
              
                // å°è¯•ä¸åŒçš„APIç›‘å¬æ–¹å¼
                if (window.siyuan.ws && typeof window.siyuan.ws.onmessage !== 'undefined') {
                    // æ–¹å¼1ï¼šä½¿ç”¨ onmessage å±æ€§
                    const originalOnMessage = window.siyuan.ws.onmessage;
                    window.siyuan.ws.onmessage = function(event) {
                        // è°ƒç”¨åŸå§‹å¤„ç†å™¨
                        if (originalOnMessage) {
                            originalOnMessage.call(this, event);
                        }
                      
                        // æˆ‘ä»¬çš„å¤„ç†é€»è¾‘
                        try {
                            const data = JSON.parse(event.data);
                            if (data.cmd === 'transactions' && data.data) {
                                data.data.forEach(transaction => {
                                    transaction.doOperations?.forEach(op => {
                                        if (op.action === 'insert' && op.data?.includes('NodeBlockquote')) {
                                            setTimeout(() => {
                                                const newBlockquote = document.querySelector(`[data-node-id="${op.id}"]`);
                                                if (newBlockquote && !hasCustomStyle(newBlockquote) && isBlockQuoteEmpty(newBlockquote)) {
                                                    const rect = newBlockquote.getBoundingClientRect();
                                                    showCommandMenu(rect.left, rect.top, newBlockquote);
                                                }
                                            }, 100);
                                        }
                                    });
                                });
                            }
                        } catch (error) {
                            // å¿½ç•¥JSONè§£æé”™è¯¯
                        }
                    };
                    console.log('SiYuan WebSocket listener attached via onmessage');
                } else if (window.siyuan.eventBus && typeof window.siyuan.eventBus.on === 'function') {
                    // æ–¹å¼2ï¼šä½¿ç”¨äº‹ä»¶æ€»çº¿
                    window.siyuan.eventBus.on('ws-main', (data) => {
                        try {
                            if (data.cmd === 'transactions' && data.data) {
                                data.data.forEach(transaction => {
                                    transaction.doOperations?.forEach(op => {
                                        if (op.action === 'insert' && op.data?.includes('NodeBlockquote')) {
                                            setTimeout(() => {
                                                const newBlockquote = document.querySelector(`[data-node-id="${op.id}"]`);
                                                if (newBlockquote && !hasCustomStyle(newBlockquote) && isBlockQuoteEmpty(newBlockquote)) {
                                                    const rect = newBlockquote.getBoundingClientRect();
                                                    showCommandMenu(rect.left, rect.top, newBlockquote);
                                                }
                                            }, 100);
                                        }
                                    });
                                });
                            }
                        } catch (error) {
                            // å¿½ç•¥å¤„ç†é”™è¯¯
                        }
                    });
                    console.log('SiYuan event bus listener attached');
                } else {
                    console.log('SiYuan API available but no suitable WebSocket interface found');
                }
            } else {
                console.log('SiYuan API not detected, using DOM-based detection only');
            }
        } catch (error) {
            console.log('Error setting up SiYuan API listener:', error.message);
            console.log('Falling back to DOM-based detection only');
        }
    }

    // ä¼˜åŒ–çš„äº‹ä»¶ç›‘å¬è®¾ç½®
    function setupOptimizedEventListeners() {
        console.log('Setting up optimized event listeners');
      
        // åˆå§‹åŒ–å·²çŸ¥çš„ BlockQuote
        const initialBlockQuotes = findSiYuanBlockQuotes();
        initialBlockQuotes.forEach(bq => {
            const nodeId = bq.getAttribute('data-node-id');
            if (nodeId) trackedBlockQuotes.add(nodeId);
        });
      
        // 1. ä¼˜åŒ–çš„MutationObserver
        setupOptimizedObserver();
      
        // 2. åŸºäºç„¦ç‚¹çš„æ£€æµ‹
        setupFocusBasedDetection();
      
        // 3. äº‹ä»¶é©±åŠ¨çš„calloutå¤„ç†
        setupEventDrivenSystem();
      
        // 4. é”®ç›˜äº‹ä»¶ï¼ˆESCå…³é—­èœå•ï¼‰
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && isMenuVisible) {
                e.preventDefault();
                hideCommandMenu(true);
                return;
            }
        });
      
        // 5. ç‚¹å‡»å¤–éƒ¨å…³é—­èœå•
        document.addEventListener('click', function(e) {
            if (commandMenu && !commandMenu.contains(e.target) && isMenuVisible) {
                setTimeout(() => {
                    if (isMenuVisible) hideCommandMenu(true);
                }, 100);
            }
        });

        // 6. ğŸ”¥ ä¿®å¤ï¼šå®‰å…¨çš„æ€æºAPIç›‘å¬
        setupSiYuanAPIListener();
    }

    // ==================== åˆå§‹åŒ– ====================

    function initOptimized() {
        console.log('Initializing optimized BlockQuote script');
      
        // åˆå§‹å¤„ç†ç°æœ‰çš„blockquoteï¼ˆåªæ‰§è¡Œä¸€æ¬¡ï¼‰
        processAllBlockquotes();
      
        // è®¾ç½®ä¼˜åŒ–çš„äº‹ä»¶ç›‘å¬
        setupOptimizedEventListeners();
    }

    // å¯åŠ¨ä¼˜åŒ–ç‰ˆæœ¬
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initOptimized);
    } else {
        initOptimized();
    }

    // é¡µé¢å¸è½½æ¸…ç†
    window.addEventListener('beforeunload', () => hideCommandMenu(true));

    // è°ƒè¯•åŠŸèƒ½
    window.debugEnhancedBlockQuote = {
        // èœå•ç›¸å…³
        showMenu: () => {
            const blockQuotes = findSiYuanBlockQuotes();
            if (blockQuotes.length > 0) {
                const lastBlockQuote = blockQuotes[blockQuotes.length - 1];
                const rect = lastBlockQuote.getBoundingClientRect();
                showCommandMenu(rect.left, rect.top, lastBlockQuote);
            }
        },
        hideMenu: () => hideCommandMenu(true),
      
        // Callout ç›¸å…³
        processAll: processAllBlockquotes,
        checkBlockquotes: () => {
            const bqs = document.querySelectorAll('.bq');
            console.log('=== Current blockquotes ===');
            bqs.forEach((bq, i) => {
                const text = bq.textContent.trim();
                const type = bq.getAttribute('custom-callout');
                const customStyle = hasCustomStyle(bq);
                console.log(`BQ ${i + 1}: "${text}" - Type: ${type || 'none'} - Custom: ${customStyle}`);
            });
        },
      
        // æ£€æŸ¥è‡ªå®šä¹‰æ ·å¼
        checkCustomStyles: () => {
            const bqs = document.querySelectorAll('.bq');
            console.log('=== Custom styled blockquotes ===');
            bqs.forEach((bq, i) => {
                if (hasCustomStyle(bq)) {
                    const customB = bq.getAttribute('custom-b');
                    const customCallout = bq.getAttribute('custom-callout');
                    console.log(`Custom BQ ${i + 1}: custom-b="${customB}" custom-callout="${customCallout}"`);
                }
            });
        },
      
        // çŠ¶æ€æŸ¥çœ‹
        status: () => ({
            menuVisible: isMenuVisible,
            trackedCount: trackedBlockQuotes.size,
            recentCount: recentlyCreatedBlockQuotes.size
        }),

        // æ€§èƒ½æµ‹è¯•
        performanceTest: () => {
            const start = performance.now();
            processAllBlockquotes();
            const end = performance.now();
            console.log(`Processing all blockquotes took ${end - start} milliseconds`);
        }
    };

    console.log('=== Optimized Enhanced BlockQuote Script Loaded ===');
})();