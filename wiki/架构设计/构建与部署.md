# 构建与部署

<cite>
**本文档引用的文件**
- [webpack.config.js](file://app/webpack.config.js)
- [webpack.desktop.js](file://app/webpack.desktop.js)
- [webpack.mobile.js](file://app/webpack.mobile.js)
- [webpack.export.js](file://app/webpack.export.js)
- [electron-builder.yml](file://app/electron-builder.yml)
- [electron-builder-darwin.yml](file://app/electron-builder-darwin.yml)
- [electron-builder-linux.yml](file://app/electron-builder-linux.yml)
- [Dockerfile](file://Dockerfile)
- [darwin-build.sh](file://scripts/darwin-build.sh)
- [linux-build.sh](file://scripts/linux-build.sh)
- [win-build.bat](file://scripts/win-build.bat)
</cite>

## 目录
1. [简介](#简介)
2. [前端构建配置](#前端构建配置)
3. [桌面应用打包配置](#桌面应用打包配置)
4. [容器镜像构建](#容器镜像构建)
5. [自动化构建脚本分析](#自动化构建脚本分析)
6. [CI/CD流程](#cicd流程)
7. [部署方式与运维建议](#部署方式与运维建议)

## 简介
思源笔记（SiYuan）采用现代化的构建与部署体系，支持多平台发布和容器化部署。系统通过Webpack进行前端资源打包，使用Electron构建跨平台桌面应用，并通过Docker实现容器化部署。CI/CD流程自动化了从代码提交到多平台发布包生成的全过程。

## 前端构建配置

思源笔记使用Webpack作为前端资源打包工具，针对不同运行环境提供了多个配置文件。

### Webpack入口与输出配置
Webpack配置定义了多个入口点，包括主应用入口和窗口管理入口。输出路径根据目标平台分为不同的构建目录。

```mermaid
flowchart TD
A["入口配置"] --> B["main: ./src/index.ts"]
A --> C["window: ./src/window/index.ts"]
D["输出配置"] --> E["开发模式: eval-source-map"]
D --> F["生产模式: 无source map"]
G["目标平台"] --> H["electron-renderer"]
I["输出路径"] --> J["stage/build/app"]
```

**Diagram sources**
- [webpack.config.js](file://app/webpack.config.js#L10-L30)

**Section sources**
- [webpack.config.js](file://app/webpack.config.js#L1-L130)

### 模块加载与优化策略
系统配置了多种模块加载规则，支持TypeScript、SCSS、模板文件和静态资源的处理。生产环境下使用esbuild进行代码压缩优化。

```mermaid
flowchart TD
A["模块规则"] --> B[".tpl文件: html-loader"]
A --> C[".ts(x?)文件: esbuild-loader + ifdef-loader"]
A --> D[".scss文件: mini-css-extract-plugin + css-loader + sass-loader"]
A --> E[".png/.svg文件: file-loader"]
F["优化策略"] --> G["生产模式启用压缩"]
F --> H["esbuild插件: target=es2021"]
```

**Diagram sources**
- [webpack.config.js](file://app/webpack.config.js#L60-L100)

**Section sources**
- [webpack.config.js](file://app/webpack.config.js#L1-L130)

### 多环境构建配置
针对不同使用场景，项目提供了多个Webpack配置文件：
- `webpack.desktop.js`：桌面应用构建配置
- `webpack.mobile.js`：移动端构建配置
- `webpack.export.js`：导出功能构建配置

各配置通过ifdef-loader在编译时注入环境变量，实现条件编译。

```mermaid
flowchart TD
A["构建配置"] --> B["webpack.desktop.js"]
A --> C["webpack.mobile.js"]
A --> D["webpack.export.js"]
B --> E["BROWSER=true, MOBILE=false"]
C --> F["BROWSER=true, MOBILE=true"]
D --> G["导出Protyle库"]
```

**Diagram sources**
- [webpack.desktop.js](file://app/webpack.desktop.js#L1-L128)
- [webpack.mobile.js](file://app/webpack.mobile.js#L1-L129)
- [webpack.export.js](file://app/webpack.export.js#L1-L102)

**Section sources**
- [webpack.desktop.js](file://app/webpack.desktop.js#L1-L128)
- [webpack.mobile.js](file://app/webpack.mobile.js#L1-L129)
- [webpack.export.js](file://app/webpack.export.js#L1-L102)

## 桌面应用打包配置

思源笔记使用electron-builder进行桌面应用打包，针对不同操作系统提供了专门的配置文件。

### 通用打包配置
`electron-builder.yml`文件定义了通用的打包参数，包括应用名称、应用ID、版权信息等。

```yaml
productName: "SiYuan"
appId: "org.b3log.siyuan"
asar: false
compression: "store"
copyright: "© 2024 Yunnan Liandi Technology Co., Ltd."
```

**Section sources**
- [electron-builder.yml](file://app/electron-builder.yml#L1-L5)

### Windows平台配置
Windows平台的打包配置包含图标、额外资源、权限设置和安装程序选项。

```mermaid
flowchart TD
A["Windows配置"] --> B["图标: src/assets/icon.ico"]
A --> C["额外资源: kernel目录"]
A --> D["执行权限: asInvoker"]
A --> E["签名配置: SHA-256"]
A --> F["NSIS安装程序"]
F --> G["非一键安装"]
F --> H["允许更改安装目录"]
F --> I["创建桌面快捷方式"]
F --> J["卸载时删除用户数据"]
```

**Diagram sources**
- [electron-builder.yml](file://app/electron-builder.yml#L10-L40)

**Section sources**
- [electron-builder.yml](file://app/electron-builder.yml#L1-L74)

### macOS平台配置
macOS平台有独立的配置文件，分别针对Intel和Apple Silicon架构。

```mermaid
flowchart TD
A["macOS配置文件"] --> B["electron-builder-darwin.yml"]
A --> C["electron-builder-darwin-arm64.yml"]
B --> D["Intel架构"]
C --> E["Apple Silicon架构"]
F["通用配置"] --> G["应用图标"]
F --> H["代码签名"]
F --> I["DMG安装包"]
```

**Diagram sources**
- [electron-builder-darwin.yml](file://app/electron-builder-darwin.yml)
- [electron-builder-darwin-arm64.yml](file://app/electron-builder-darwin-arm64.yml)

**Section sources**
- [electron-builder-darwin.yml](file://app/electron-builder-darwin.yml)
- [electron-builder-darwin-arm64.yml](file://app/electron-builder-darwin-arm64.yml)

### Linux平台配置
Linux平台同样提供针对不同架构的配置文件。

```mermaid
flowchart TD
A["Linux配置文件"] --> B["electron-builder-linux.yml"]
A --> C["electron-builder-linux-arm64.yml"]
B --> D["x86_64架构"]
C --> E["ARM64架构"]
F["输出格式"] --> G["AppImage"]
F --> H["tar.gz"]
```

**Diagram sources**
- [electron-builder-linux.yml](file://app/electron-builder-linux.yml)
- [electron-builder-linux-arm64.yml](file://app/electron-builder-linux-arm64.yml)

**Section sources**
- [electron-builder-linux.yml](file://app/electron-builder-linux.yml)
- [electron-builder-linux-arm64.yml](file://app/electron-builder-linux-arm64.yml)

## 容器镜像构建

思源笔记通过Dockerfile定义了容器镜像的构建过程，采用多阶段构建优化镜像大小。

### Dockerfile结构分析
Docker构建过程分为三个阶段：Node构建阶段、Go构建阶段和最终镜像阶段。

```mermaid
graph TD
A["第一阶段: Node构建"] --> B["基础镜像: node:21"]
A --> C["安装pnpm"]
A --> D["安装前端依赖"]
A --> E["构建前端资源"]
F["第二阶段: Go构建"] --> G["基础镜像: golang:1.24-alpine"]
F --> H["复制前端构建结果"]
F --> I["编译Go内核"]
F --> J["整理应用资源"]
K["第三阶段: 最终镜像"] --> L["基础镜像: alpine:latest"]
K --> M["复制构建结果"]
K --> N["安装运行时依赖"]
K --> O["设置启动命令"]
```

**Diagram sources**
- [Dockerfile](file://Dockerfile#L1-L53)

**Section sources**
- [Dockerfile](file://Dockerfile#L1-L53)

### 构建参数与环境变量
Docker构建过程中设置了多个环境变量和构建参数。

```yaml
ENV TZ=Asia/Shanghai
ENV HOME=/home/siyuan
ENV RUN_IN_CONTAINER=true
EXPOSE 6806
ENTRYPOINT ["/opt/siyuan/entrypoint.sh"]
CMD ["/opt/siyuan/kernel"]
```

**Section sources**
- [Dockerfile](file://Dockerfile#L45-L53)

## 自动化构建脚本分析

项目提供了针对不同操作系统的构建脚本，实现了自动化编译任务。

### Linux构建脚本
`linux-build.sh`脚本负责Linux平台的完整构建流程。

```mermaid
flowchart TD
A["Linux构建脚本"] --> B["构建UI"]
B --> C["清理旧构建"]
C --> D["构建内核 (amd64)"]
D --> E["构建内核 (arm64)"]
E --> F["构建Electron应用 (amd64)"]
F --> G["构建Electron应用 (arm64)"]
H["关键技术"] --> I["GOOS=linux"]
H --> J["CGO_ENABLED=1"]
H --> K["musl-cross编译"]
```

**Diagram sources**
- [linux-build.sh](file://scripts/linux-build.sh#L1-L39)

**Section sources**
- [linux-build.sh](file://scripts/linux-build.sh#L1-L39)

### macOS构建脚本
`darwin-build.sh`脚本负责macOS平台的构建。

```mermaid
flowchart TD
A["macOS构建脚本"] --> B["构建UI"]
B --> C["清理旧构建"]
C --> D["构建内核 (amd64)"]
D --> E["构建内核 (arm64)"]
E --> F["构建Electron应用 (amd64)"]
F --> G["构建Electron应用 (arm64)"]
H["关键技术"] --> I["GOOS=darwin"]
H --> J["GOARCH=amd64/arm64"]
H --> K["交叉编译"]
```

**Diagram sources**
- [darwin-build.sh](file://scripts/darwin-build.sh#L1-L38)

**Section sources**
- [darwin-build.sh](file://scripts/darwin-build.sh#L1-L38)

### Windows构建脚本
`win-build.bat`批处理文件负责Windows平台的构建。

```mermaid
flowchart TD
A["Windows构建脚本"] --> B["构建UI"]
B --> C["清理旧构建"]
C --> D["构建内核 (amd64)"]
D --> E["构建内核 (arm64)"]
E --> F["构建Electron应用 (amd64)"]
F --> G["构建Electron应用 (arm64)"]
G --> H["构建Appx包"]
H --> I["构建Appx arm64包"]
J["关键技术"] --> K["GOOS=windows"]
J --> L["CC=aarch64-w64-mingw32-gcc"]
J --> M["electron-windows-store"]
```

**Diagram sources**
- [win-build.bat](file://scripts/win-build.bat#L1-L81)

**Section sources**
- [win-build.bat](file://scripts/win-build.bat#L1-L81)

## CI/CD流程

思源笔记通过GitHub Actions实现了完整的CI/CD流程。

### 持续集成工作流
`.github/workflows/cd.yml`定义了持续集成流程。

```mermaid
flowchart TD
A["代码推送或手动触发"] --> B["创建预发布版本"]
B --> C["提取版本信息"]
C --> D["解析变更日志"]
D --> E["并行构建各平台"]
E --> F["Ubuntu: Linux AppImage/tar.gz"]
E --> G["macOS: DMG"]
E --> H["Windows: EXE"]
F --> I["上传发布资产"]
G --> I
H --> I
I --> J["完成发布"]
```

**Diagram sources**
- [.github/workflows/cd.yml](file://.github/workflows/cd.yml#L1-L241)

**Section sources**
- [.github/workflows/cd.yml](file://.github/workflows/cd.yml#L1-L241)

### 容器镜像发布流程
`.github/workflows/dockerimage.yml`定义了Docker镜像的发布流程。

```mermaid
flowchart TD
A["代码推送到master分支"] --> B["检出代码"]
B --> C["提取版本号"]
C --> D["设置QEMU"]
D --> E["配置Docker buildx"]
E --> F["登录Docker Hub"]
F --> G["多平台构建并推送"]
G --> H["支持: amd64, arm64, arm/v7, arm/v8"]
I["手动触发"] --> J["指定版本标签"]
```

**Diagram sources**
- [.github/workflows/dockerimage.yml](file://.github/workflows/dockerimage.yml#L1-L80)

**Section sources**
- [.github/workflows/dockerimage.yml](file://.github/workflows/dockerimage.yml#L1-L80)

## 部署方式与运维建议

思源笔记支持多种部署方式，各有其适用场景和运维特点。

### 桌面应用部署
桌面应用通过Electron打包为原生应用，提供最佳用户体验。

**优势:**
- 完整的本地功能访问
- 离线使用能力
- 系统级集成

**注意事项:**
- 需要为各平台分别构建
- 更新需要用户手动下载
- 安全签名配置复杂

### 容器化部署
通过Docker容器化部署，适合服务器环境。

**优势:**
- 环境一致性
- 易于扩展和管理
- 支持多架构

**注意事项:**
- 需要维护Docker环境
- 数据持久化配置
- 网络端口映射

### 运维最佳实践
```mermaid
graph TD
A["运维建议"] --> B["定期备份数据"]
A --> C["监控资源使用"]
A --> D["及时更新版本"]
A --> E["配置自动备份"]
A --> F["限制外部访问"]
A --> G["日志轮转"]
```

**Section sources**
- [Dockerfile](file://Dockerfile#L1-L53)
- [scripts/*.sh](file://scripts/)
- [app/electron-builder*.yml](file://app/electron-builder*.yml)