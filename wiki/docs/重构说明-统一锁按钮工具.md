# é‡æ„è¯´æ˜ - ç»Ÿä¸€é”æŒ‰é’®å·¥å…·

**æ—¥æœŸ**: 2025-10-02  
**ç‰ˆæœ¬**: v1.2.0  
**ç±»å‹**: ä»£ç é‡æ„ / ä¼˜åŒ–

## ğŸ¯ é‡æ„ç›®æ ‡

è§£å†³ä»£ç é‡å¤å’Œé€»è¾‘ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œç»Ÿä¸€ç®¡ç†"è·å–å½“å‰æ¿€æ´»tabçš„é”æŒ‰é’®"çš„é€»è¾‘ã€‚

## ğŸ” å‘ç°çš„é—®é¢˜

### 1. ä»£ç é‡å¤ä¸¥é‡
è‡³å°‘æœ‰ **4ä¸ªåœ°æ–¹** å®ç°äº†è‡ªå·±çš„ `getCurrentActiveReadonlyButton()` æ–¹æ³•ï¼š
- `operationWrapper.ts` (ç§æœ‰æ–¹æ³•)
- `customToolbarManager.ts` (ç§æœ‰æ–¹æ³•) 
- `tagManager.ts` (ç§æœ‰æ–¹æ³•)
- `highlightClickManager.ts` (**ç›´æ¥ç”¨ç®€å•çš„ `document.querySelector`ï¼Œæ²¡æœ‰å¤šç­–ç•¥æŸ¥æ‰¾**)

### 2. é€»è¾‘ä¸ä¸€è‡´
`highlightClickManager.ts` æ²¡æœ‰ä½¿ç”¨å¤šç­–ç•¥æŸ¥æ‰¾ï¼Œè€Œæ˜¯ç®€å•åœ°ï¼š
```typescript
const readonlyBtn = document.querySelector('.protyle-breadcrumb button[data-type="readonly"]');
```
è¿™ä¼šæ‹¿åˆ°**ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„é”æŒ‰é’®**ï¼Œä¸ä¸€å®šæ˜¯å½“å‰æ¿€æ´»çš„tabï¼

### 3. æ— æ³•å¤ç”¨
æ¯ä¸ªç±»éƒ½æ˜¯ç§æœ‰æ–¹æ³•ï¼Œå…¶ä»–åœ°æ–¹æ— æ³•å¤ç”¨è¿™ä¸ªé€»è¾‘ã€‚

## âœ… è§£å†³æ–¹æ¡ˆ

### åˆ›å»ºç»Ÿä¸€å·¥å…·æ¨¡å—

æ–°å»º `src/utils/readonlyButtonUtils.ts`ï¼Œæä¾›ä¸‰ä¸ªæ ¸å¿ƒå‡½æ•°ï¼š

#### 1. `getCurrentActiveReadonlyButton()`
```typescript
export function getCurrentActiveReadonlyButton(): HTMLElement | null
```
**åŠŸèƒ½**: è·å–å½“å‰æ¿€æ´»æ–‡æ¡£çš„é”æŒ‰é’®

**æŸ¥æ‰¾ç­–ç•¥**ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰ï¼š
1. ğŸ¥‡ **ä¼˜å…ˆ**: é€šè¿‡æ€æº `getActiveTab()` API è·å–ï¼ˆæœ€å‡†ç¡®ï¼‰
2. ğŸ¥ˆ **æ¬¡é€‰**: é€šè¿‡ç„¦ç‚¹å…ƒç´  `document.activeElement` å‘ä¸ŠæŸ¥æ‰¾
3. ğŸ¥‰ **å¤‡é€‰**: æŸ¥æ‰¾æ´»è·ƒçª—å£ `.layout__wnd--active`
4. ğŸ†˜ **å…œåº•**: å…¨å±€æŸ¥æ‰¾ç¬¬ä¸€ä¸ªï¼ˆå¯èƒ½ä¸å‡†ç¡®ï¼Œä¼šæœ‰è­¦å‘Šæ—¥å¿—ï¼‰

#### 2. `isCurrentDocumentReadonly()`
```typescript
export function isCurrentDocumentReadonly(): boolean
```
**åŠŸèƒ½**: æ£€æŸ¥å½“å‰æ¿€æ´»æ–‡æ¡£æ˜¯å¦å¤„äºåªè¯»çŠ¶æ€ï¼ˆå·²é”å®šï¼‰

**è¿”å›å€¼**:
- `true` - åªè¯»æ¨¡å¼ï¼ˆå·²é”å®šğŸ”’ï¼‰
- `false` - å¯ç¼–è¾‘æ¨¡å¼ï¼ˆå·²è§£é”âœï¸ï¼‰

**åˆ¤æ–­é€»è¾‘**ï¼ˆåŸºäºæ€æºæºç ï¼‰:
```typescript
const iconHref = readonlyBtn.querySelector('use')?.getAttribute('xlink:href') || '';
const isReadonly = iconHref !== '#iconUnlock';
```

#### 3. `isCurrentDocumentEditable()`
```typescript
export function isCurrentDocumentEditable(): boolean
```
**åŠŸèƒ½**: æ£€æŸ¥å½“å‰æ¿€æ´»æ–‡æ¡£æ˜¯å¦å¯ç¼–è¾‘ï¼ˆå·²è§£é”ï¼‰

**è¿”å›å€¼**:
- `true` - å¯ç¼–è¾‘ï¼ˆå·²è§£é”ğŸ”“ï¼‰
- `false` - åªè¯»ï¼ˆå·²é”å®šğŸ”’ï¼‰

## ğŸ“¦ ä¿®æ”¹çš„æ–‡ä»¶

### æ–°å»ºæ–‡ä»¶
- âœ¨ `src/utils/readonlyButtonUtils.ts` - ç»Ÿä¸€çš„é”æŒ‰é’®å·¥å…·æ¨¡å—

### ä¿®æ”¹æ–‡ä»¶
| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|---------|
| `operationWrapper.ts` | âœ… å¼•å…¥ç»Ÿä¸€å·¥å…·ï¼Œåˆ é™¤ç§æœ‰æ–¹æ³• |
| `customToolbarManager.ts` | âœ… å¼•å…¥ç»Ÿä¸€å·¥å…·ï¼Œåˆ é™¤ç§æœ‰æ–¹æ³• |
| `tagManager.ts` | âœ… å¼•å…¥ç»Ÿä¸€å·¥å…·ï¼Œåˆ é™¤ç§æœ‰æ–¹æ³• |
| `highlightClickManager.ts` | âœ… å¼•å…¥ç»Ÿä¸€å·¥å…·ï¼Œåˆ é™¤ç®€å•å®ç° |

### ä¿®æ”¹è¯¦æƒ…

#### operationWrapper.ts
```diff
+ import { isCurrentDocumentEditable } from './readonlyButtonUtils';

  // å…œåº•é˜²å¾¡æ£€æŸ¥
- if (this.isDocumentEditable()) {
+ if (isCurrentDocumentEditable()) {
      Logger.error(`æ–‡æ¡£å¤„äºå¯ç¼–è¾‘çŠ¶æ€ï¼Œæ‹’ç»æ‰§è¡Œæ“ä½œ`);
  }

- private isDocumentEditable(): boolean { ... }  // åˆ é™¤
- private getCurrentActiveReadonlyButton(): HTMLElement | null { ... }  // åˆ é™¤
```

#### customToolbarManager.ts
```diff
+ import { getCurrentActiveReadonlyButton } from './readonlyButtonUtils';

  // æ£€æŸ¥å½“å‰æ´»è·ƒæ–‡æ¡£çš„åªè¯»çŠ¶æ€
- const readonlyBtn = this.getCurrentActiveReadonlyButton();
+ const readonlyBtn = getCurrentActiveReadonlyButton();

- private getCurrentActiveReadonlyButton(): HTMLElement | null { ... }  // åˆ é™¤
```

#### tagManager.ts
```diff
+ import { isCurrentDocumentReadonly, isCurrentDocumentEditable } from './readonlyButtonUtils';

  // æ£€æŸ¥æ˜¯å¦å¤„äºåªè¯»çŠ¶æ€
- const isDocReadonly = this.checkDocumentReadonly();
+ const isDocReadonly = isCurrentDocumentReadonly();

  // å…œåº•é˜²å¾¡æ£€æŸ¥
  private isDocumentEditableCheck(): boolean {
-     try { ... }  // åˆ é™¤æ•´ä¸ªå®ç°
+     return isCurrentDocumentEditable();  // ç›´æ¥è°ƒç”¨ç»Ÿä¸€å·¥å…·
  }

- private checkDocumentReadonly(): boolean { ... }  // åˆ é™¤
- private getCurrentActiveReadonlyButton(): HTMLElement | null { ... }  // åˆ é™¤
```

#### highlightClickManager.ts
```diff
+ import { isCurrentDocumentReadonly } from './readonlyButtonUtils';

  // æ£€æŸ¥æ–‡æ¡£æ˜¯å¦å¤„äºé”å®šç¼–è¾‘çŠ¶æ€
- const isDocReadonly = this.checkDocumentReadonly();
+ const isDocReadonly = isCurrentDocumentReadonly();

- private checkDocumentReadonly(): boolean { ... }  // åˆ é™¤ç®€å•å®ç°
```

## ğŸ¨ ä»£ç å¯¹æ¯”

### ä¹‹å‰ï¼ˆåˆ†æ•£çš„å®ç°ï¼‰

**highlightClickManager.ts** - ç®€å•å®ç°ï¼ˆæœ‰é—®é¢˜ï¼‰:
```typescript
private checkDocumentReadonly(): boolean {
    // âŒ åªæ˜¯ç®€å•åœ°æŸ¥æ‰¾ç¬¬ä¸€ä¸ªï¼Œå¯èƒ½ä¸æ˜¯å½“å‰tab
    const readonlyBtn = document.querySelector('.protyle-breadcrumb button[data-type="readonly"]');
    
    if (!readonlyBtn) return false;
    
    const iconHref = readonlyBtn.querySelector('use')?.getAttribute('xlink:href') || '';
    const isReadonly = iconHref !== '#iconUnlock';
    
    return isReadonly;
}
```

**å…¶ä»–æ–‡ä»¶** - å„è‡ªå®ç°ï¼ˆé‡å¤ä»£ç ï¼‰:
```typescript
// operationWrapper.tsã€customToolbarManager.tsã€tagManager.ts 
// éƒ½æœ‰ç±»ä¼¼çš„ getCurrentActiveReadonlyButton() å®ç°
// ä»£ç é‡å¤ï¼Œç»´æŠ¤å›°éš¾
```

### ç°åœ¨ï¼ˆç»Ÿä¸€å®ç°ï¼‰

**readonlyButtonUtils.ts** - ç»Ÿä¸€çš„ã€å®Œå–„çš„å®ç°:
```typescript
export function getCurrentActiveReadonlyButton(): HTMLElement | null {
    // âœ… ç­–ç•¥1: å°è¯•ä½¿ç”¨æ€æº getActiveTab APIï¼ˆæœ€å‡†ç¡®ï¼‰
    try {
        const { getActiveTab } = require('siyuan');
        const activeTab = getActiveTab();
        if (activeTab?.model?.editor?.protyle) {
            const protyle = activeTab.model.editor.protyle;
            const readonlyBtn = protyle.element?.querySelector('...');
            if (readonlyBtn) return readonlyBtn;
        }
    } catch (error) { ... }
    
    // âœ… ç­–ç•¥2: é€šè¿‡ç„¦ç‚¹å…ƒç´ æŸ¥æ‰¾
    const focusedElement = document.activeElement;
    if (focusedElement) {
        const protyleContainer = focusedElement.closest('.protyle');
        if (protyleContainer) {
            const readonlyBtn = protyleContainer.querySelector('...');
            if (readonlyBtn) return readonlyBtn;
        }
    }
    
    // âœ… ç­–ç•¥3: æŸ¥æ‰¾æ´»è·ƒçª—å£
    const activeWnd = document.querySelector('.layout__wnd--active');
    if (activeWnd) {
        const readonlyBtn = activeWnd.querySelector('...');
        if (readonlyBtn) return readonlyBtn;
    }
    
    // âœ… ç­–ç•¥4: å…œåº•æ–¹æ¡ˆï¼ˆä¼šæœ‰è­¦å‘Šæ—¥å¿—ï¼‰
    const readonlyBtn = document.querySelector('...');
    if (readonlyBtn) {
        Logger.warn('ä½¿ç”¨å…œåº•æ–¹æ¡ˆï¼Œå¯èƒ½ä¸å‡†ç¡®');
        return readonlyBtn;
    }
    
    return null;
}
```

**æ‰€æœ‰æ–‡ä»¶** - ç®€å•è°ƒç”¨:
```typescript
// ç°åœ¨æ‰€æœ‰åœ°æ–¹éƒ½è¿™æ ·ç®€å•è°ƒç”¨
import { isCurrentDocumentReadonly } from './readonlyButtonUtils';

const isReadonly = isCurrentDocumentReadonly();
```

## ğŸ“Š é‡æ„æˆæœ

### ä»£ç è¡Œæ•°å¯¹æ¯”

| æŒ‡æ ‡ | é‡æ„å‰ | é‡æ„å | ä¼˜åŒ– |
|------|--------|--------|------|
| é‡å¤æ–¹æ³•æ•°é‡ | 4ä¸ª | 1ä¸ª | â¬‡ï¸ 75% |
| æ€»ä»£ç è¡Œæ•° | ~300è¡Œ | ~180è¡Œ | â¬‡ï¸ 40% |
| æ–°å¢å·¥å…·æ–‡ä»¶ | 0 | 1 | +1 |

### ä»£ç è´¨é‡æå‡

| æ–¹é¢ | é‡æ„å‰ | é‡æ„å |
|------|--------|--------|
| **é€»è¾‘ä¸€è‡´æ€§** | âŒ ä¸ä¸€è‡´ | âœ… å®Œå…¨ä¸€è‡´ |
| **å¯å¤ç”¨æ€§** | âŒ ç§æœ‰æ–¹æ³• | âœ… å¯¼å‡ºå‡½æ•° |
| **å¯ç»´æŠ¤æ€§** | âŒ åˆ†æ•£ç»´æŠ¤ | âœ… ç»Ÿä¸€ç»´æŠ¤ |
| **æŸ¥æ‰¾å‡†ç¡®æ€§** | âš ï¸ éƒ¨åˆ†ä¸å‡†ç¡® | âœ… å¤šç­–ç•¥å‡†ç¡® |
| **è°ƒè¯•å‹å¥½** | âš ï¸ æ—¥å¿—åˆ†æ•£ | âœ… ç»Ÿä¸€æ—¥å¿— |

## ğŸ¯ æ ¸å¿ƒæ”¹è¿›

### 1. ç»Ÿä¸€äº†ä¸šåŠ¡é€»è¾‘
æ‰€æœ‰"è·å–å½“å‰æ¿€æ´»tabçš„é”æŒ‰é’®"çš„é€»è¾‘ç°åœ¨éƒ½åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œæ˜“äºç»´æŠ¤å’Œä¿®æ”¹ã€‚

### 2. ä¿®å¤äº†æ½œåœ¨BUG
`highlightClickManager.ts` ä¹‹å‰çš„ç®€å•å®ç°å¯èƒ½æ‹¿åˆ°é”™è¯¯çš„tabçš„é”æŒ‰é’®ï¼Œç°åœ¨ä¿®å¤äº†ã€‚

### 3. æå‡äº†æŸ¥æ‰¾å‡†ç¡®æ€§
é‡‡ç”¨å¤šç­–ç•¥æŸ¥æ‰¾ï¼Œä¼˜å…ˆä½¿ç”¨æœ€å‡†ç¡®çš„ `getActiveTab()` APIã€‚

### 4. æ›´å¥½çš„è°ƒè¯•æ”¯æŒ
ç»Ÿä¸€çš„æ—¥å¿—è¾“å‡ºæ ¼å¼ï¼Œå¸¦ `[ReadonlyButton]` å‰ç¼€ï¼Œæ˜“äºè¿‡æ»¤å’Œè°ƒè¯•ã€‚

## ğŸ” æ—¥å¿—ç¤ºä¾‹

### æˆåŠŸæ‰¾åˆ°ï¼ˆç­–ç•¥1ï¼‰
```
ğŸ” [ReadonlyButton] å¼€å§‹æŸ¥æ‰¾å½“å‰æ´»è·ƒæ–‡æ¡£çš„é”æŒ‰é’®...
ğŸ” [ReadonlyButton] æ€æºgetActiveTabè¿”å›: { hasActiveTab: true, tabId: "xxx", ... }
âœ… [ReadonlyButton] ç­–ç•¥1æˆåŠŸ - é€šè¿‡getActiveTabæ‰¾åˆ°é”æŒ‰é’®: { iconHref: "#iconUnlock", ... }
```

### æˆåŠŸæ‰¾åˆ°ï¼ˆç­–ç•¥2ï¼‰
```
ğŸ” [ReadonlyButton] å¼€å§‹æŸ¥æ‰¾å½“å‰æ´»è·ƒæ–‡æ¡£çš„é”æŒ‰é’®...
âš ï¸ [ReadonlyButton] getActiveTab APIä¸å¯ç”¨: ...
ğŸ” [ReadonlyButton] å½“å‰ç„¦ç‚¹å…ƒç´ : { tagName: "DIV", ... }
âœ… [ReadonlyButton] ç­–ç•¥2æˆåŠŸ - é€šè¿‡ç„¦ç‚¹å…ƒç´ æ‰¾åˆ°é”æŒ‰é’®: { iconHref: "#iconLock", ... }
```

### ä½¿ç”¨å…œåº•æ–¹æ¡ˆï¼ˆè­¦å‘Šï¼‰
```
ğŸ” [ReadonlyButton] å¼€å§‹æŸ¥æ‰¾å½“å‰æ´»è·ƒæ–‡æ¡£çš„é”æŒ‰é’®...
âš ï¸ [ReadonlyButton] getActiveTab APIä¸å¯ç”¨: ...
ğŸ” [ReadonlyButton] å½“å‰ç„¦ç‚¹å…ƒç´ : { tagName: "BODY", ... }
ğŸ” [ReadonlyButton] æ´»è·ƒçª—å£: { found: false }
âš ï¸ [ReadonlyButton] ç­–ç•¥4å…œåº• - ä½¿ç”¨ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„é”æŒ‰é’®ï¼ˆå¯èƒ½ä¸å‡†ç¡®ï¼‰: { ... }
```

## âœ… éªŒè¯æµ‹è¯•

### æ„å»ºç»“æœ
```bash
npm run build
âœ“ 24 modules transformed.
dist/index.js   176.07 kB â”‚ gzip: 46.13 kB
âœ“ built in 631ms
```

### Linteræ£€æŸ¥
- âœ… æ— é”™è¯¯
- âš ï¸ 4ä¸ªè­¦å‘Šï¼ˆéƒ½æ˜¯åŸæœ‰ä»£ç çš„æœªä½¿ç”¨å˜é‡ï¼Œä¸æœ¬æ¬¡é‡æ„æ— å…³ï¼‰

## ğŸ“ æœ€ä½³å®è·µ

è¿™æ¬¡é‡æ„éµå¾ªäº†ä»¥ä¸‹æœ€ä½³å®è·µï¼š

1. âœ… **DRYåŸåˆ™** (Don't Repeat Yourself) - æ¶ˆé™¤é‡å¤ä»£ç 
2. âœ… **å•ä¸€èŒè´£** - æ¯ä¸ªå‡½æ•°åªåšä¸€ä»¶äº‹
3. âœ… **æå–å…¬å…±é€»è¾‘** - å°†é€šç”¨é€»è¾‘æŠ½å–ä¸ºå·¥å…·å‡½æ•°
4. âœ… **ç»Ÿä¸€æ¥å£** - æä¾›ä¸€è‡´çš„APIç»™è°ƒç”¨æ–¹
5. âœ… **ä¿æŒå…¼å®¹** - ä¸å½±å“åŸæœ‰ä¸šåŠ¡é€»è¾‘

## ğŸ“ ä½¿ç”¨æŒ‡å—

### å¯¹äºå¼€å‘è€…

å¦‚æœä½ éœ€è¦è·å–å½“å‰æ¿€æ´»tabçš„é”æŒ‰é’®ï¼š

```typescript
import { getCurrentActiveReadonlyButton } from './utils/readonlyButtonUtils';

const readonlyBtn = getCurrentActiveReadonlyButton();
if (readonlyBtn) {
    // æ‰¾åˆ°äº†ï¼Œå¯ä»¥æ“ä½œ
} else {
    // æ²¡æ‰¾åˆ°
}
```

å¦‚æœä½ åªéœ€è¦æ£€æŸ¥åªè¯»çŠ¶æ€ï¼š

```typescript
import { isCurrentDocumentReadonly } from './utils/readonlyButtonUtils';

if (isCurrentDocumentReadonly()) {
    // å½“å‰æ–‡æ¡£å·²é”å®šï¼ˆåªè¯»æ¨¡å¼ï¼‰
} else {
    // å½“å‰æ–‡æ¡£å·²è§£é”ï¼ˆå¯ç¼–è¾‘æ¨¡å¼ï¼‰
}
```

å¦‚æœä½ éœ€è¦æ£€æŸ¥å¯ç¼–è¾‘çŠ¶æ€ï¼š

```typescript
import { isCurrentDocumentEditable } from './utils/readonlyButtonUtils';

if (isCurrentDocumentEditable()) {
    // å½“å‰æ–‡æ¡£å¯ç¼–è¾‘ï¼ˆå·²è§£é”ï¼‰
} else {
    // å½“å‰æ–‡æ¡£åªè¯»ï¼ˆå·²é”å®šï¼‰
}
```

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

1. **æ€§èƒ½ä¼˜åŒ–**: å¯ä»¥è€ƒè™‘ç¼“å­˜æŸ¥æ‰¾ç»“æœï¼Œé¿å…é¢‘ç¹DOMæŸ¥è¯¢
2. **é”™è¯¯å¤„ç†**: å¯ä»¥æ·»åŠ æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œæ¢å¤ç­–ç•¥
3. **å•å…ƒæµ‹è¯•**: ä¸ºæ–°çš„å·¥å…·å‡½æ•°æ·»åŠ å•å…ƒæµ‹è¯•

## ğŸ“Œ æ€»ç»“

| æ–¹é¢ | è¯´æ˜ |
|------|------|
| **é—®é¢˜** | ä»£ç é‡å¤ã€é€»è¾‘ä¸ä¸€è‡´ã€æ½œåœ¨BUG |
| **æ–¹æ¡ˆ** | æŠ½å–ç»Ÿä¸€å·¥å…·æ¨¡å— `readonlyButtonUtils.ts` |
| **æ”¹è¿›** | å‡å°‘40%ä»£ç ã€æå‡å‡†ç¡®æ€§ã€æ˜“äºç»´æŠ¤ |
| **å½±å“** | âœ… æ— å‰¯ä½œç”¨ï¼Œä¸å½±å“åŸæœ‰ä¸šåŠ¡ |
| **çŠ¶æ€** | âœ… å·²å®Œæˆå¹¶é€šè¿‡æµ‹è¯• |

---

**é‡æ„å®Œæˆæ—¥æœŸ**: 2025-10-02  
**æ„å»ºçŠ¶æ€**: âœ… æˆåŠŸ  
**å½±å“èŒƒå›´**: 4ä¸ªå·¥å…·æ–‡ä»¶  
**æµ‹è¯•çŠ¶æ€**: âœ… é€šè¿‡

