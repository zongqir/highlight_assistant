# ç°æœ‰é«˜äº®æ’ä»¶ä»£ç é—®é¢˜åˆ†æ

## ğŸ”´ æ ¸å¿ƒé—®é¢˜æ€»ç»“

ä½ çš„ä»£ç ä¸»è¦æœ‰ **5 ä¸ªå…³é”®æ€§é”™è¯¯**ï¼Œå¯¼è‡´æ— æ³•æ­£ç¡®å®ç°é«˜äº®åŠŸèƒ½ã€‚

---

## é—®é¢˜ 1: âŒ ä½¿ç”¨äº†é”™è¯¯çš„ API

### ä½ çš„ä»£ç  (toolbarHijacker.ts:36-42)
```typescript
this.api = {
    updateBlock: async (blockId: string, data: string, dataType: string) => {
        const response = await fetch('/api/block/updateBlock', {  // âŒ é”™è¯¯çš„API
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                id: blockId,
                data: data,
                dataType: dataType  // âŒ é”™è¯¯çš„å‚æ•°æ ¼å¼
            })
        });
        return await response.json();
    }
}
```

### æ€æºåŸç”Ÿæ–¹å¼
```typescript
// æ­£ç¡®ï¼šä½¿ç”¨ /api/transactions
fetchPost("/api/transactions", {
    session: protyle.id,
    app: "siyuan",
    transactions: [{
        doOperations: [{
            action: "update",
            id: blockId,
            data: newHTML  // å®Œæ•´çš„å— HTML
        }],
        undoOperations: [{
            action: "update",
            id: blockId,
            data: oldHTML  // æ—§çš„å— HTML
        }]
    }]
});
```

### ä¸ºä»€ä¹ˆé”™è¯¯ï¼Ÿ
- `/api/block/updateBlock` æ˜¯**æ—§ç‰ˆ API**ï¼Œä¸æ”¯æŒå®Œæ•´çš„äº‹åŠ¡ç®¡ç†
- ç¼ºå°‘ **undoOperations**ï¼ˆæ’¤é”€æ“ä½œï¼‰ï¼Œæ— æ³•æ”¯æŒ Ctrl+Z
- æ€æºå†…éƒ¨ç´¢å¼•æœºåˆ¶ä¾èµ– `/api/transactions` æ¥æ›´æ–° spans å’Œ attributes è¡¨
- `dataType: "markdown"` å‚æ•°ä¸æ­£ç¡®ï¼Œåº”è¯¥ä¼ é€’å®Œæ•´çš„ HTML å—å†…å®¹

---

## é—®é¢˜ 2: âŒ æ‰‹åŠ¨åˆ›å»º span å…ƒç´ çš„æ–¹å¼ä¸å¯¹

### ä½ çš„ä»£ç  (toolbarHijacker.ts:873-880)
```typescript
// âŒ é”™è¯¯ï¼šæ‰‹åŠ¨åˆ›å»º span
const highlightSpan = document.createElement("span");
highlightSpan.setAttribute("data-type", "text");
highlightSpan.style.backgroundColor = colorConfig.color;
highlightSpan.textContent = selectedText;

// âŒ é”™è¯¯ï¼šç›´æ¥DOMæ“ä½œ
range.deleteContents();
range.insertNode(highlightSpan);
```

### æ€æºåŸç”Ÿæ–¹å¼ (app/src/protyle/toolbar/index.ts:519-530)
```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ setInlineMark + setFontStyle
contents.childNodes.forEach((item: HTMLElement) => {
    if (item.nodeType === 3 && item.textContent) {
        const inlineElement = document.createElement("span");
        inlineElement.setAttribute("data-type", type);  // "text"
        inlineElement.textContent = item.textContent;
        
        // å…³é”®ï¼šä½¿ç”¨ setFontStyle è®¾ç½®æ ·å¼
        setFontStyle(inlineElement, textObj);
        // è¿™ä¼šå¤„ç†ï¼š
        // - backgroundColor è®¾ç½®
        // - ç›¸é‚» span åˆå¹¶
        // - IAL å±æ€§ç”Ÿæˆ
        
        newNodes.push(inlineElement);
    }
});
```

### ä¸ºä»€ä¹ˆé”™è¯¯ï¼Ÿ
- ä½ æ²¡æœ‰è°ƒç”¨ **æ€æºçš„ setInlineMark æ–¹æ³•**
- ç¼ºå°‘ **IAL (Inline Attribute List)** çš„ç”Ÿæˆ
- æ²¡æœ‰å¤„ç†**ç›¸é‚» span åˆå¹¶**çš„é€»è¾‘
- ä¸ç¬¦åˆæ€æºçš„ **Kramdown æ ¼å¼è¦æ±‚**

---

## é—®é¢˜ 3: âŒ ä¿å­˜çš„æ•°æ®æ ¼å¼å®Œå…¨é”™è¯¯

### ä½ çš„ä»£ç  (toolbarHijacker.ts:888-899)
```typescript
// âŒ é”™è¯¯ï¼šä¿å­˜ innerHTML è€Œä¸æ˜¯å®Œæ•´çš„å— HTML
const newContent = blockElement.innerHTML;  // åªæœ‰å†…å®¹ï¼Œæ²¡æœ‰å—çº§å±æ€§

// âŒ é”™è¯¯ï¼šç„¶ååˆå°è¯•æå– markdown
const markdownContent = await this.extractMarkdownFromBlock(blockElement);

// âŒ é”™è¯¯ï¼šä½¿ç”¨é”™è¯¯çš„ API å’Œæ ¼å¼
const updateResult = await this.api.updateBlock(blockId, markdownContent, "markdown");
```

### æ€æºåŸç”Ÿæ–¹å¼ (app/src/protyle/wysiwyg/transaction.ts:1436-1448)
```typescript
// âœ… æ­£ç¡®ï¼šä¿å­˜å®Œæ•´çš„å— outerHTML
export const updateTransaction = (protyle: IProtyle, id: string, 
                                  newHTML: string, html: string) => {
    if (newHTML === html) return;
    
    transaction(protyle, [{
        id,              // å— ID
        data: newHTML,   // âœ… æ–°çš„å®Œæ•´å— outerHTMLï¼ˆåŒ…å« <div data-node-id="...">...</div>ï¼‰
        action: "update"
    }], [{
        id,
        data: html,      // âœ… æ—§çš„å®Œæ•´å— outerHTML
        action: "update"
    }]);
};
```

### æ€æºéœ€è¦çš„å®Œæ•´ HTML æ ¼å¼
```html
<div 
    data-node-id="20251001111753-36y1un2" 
    data-type="NodeParagraph" 
    class="p" 
    updated="20251001111824"
>
    <div contenteditable="true" spellcheck="false">
        å…³é”®ä¿¡æ¯æ˜¯<span data-type="text" style="background-color: var(--b3-font-background2);">æˆ‘çˆ±</span>ä½ 
    </div>
    <div class="protyle-attr" contenteditable="false">â€‹</div>
</div>
```

### ä¸ºä»€ä¹ˆé”™è¯¯ï¼Ÿ
- ä½ åªä¿å­˜äº† `innerHTML`ï¼ˆå†…å®¹ï¼‰ï¼Œä½†æ€æºéœ€è¦ `outerHTML`ï¼ˆåŒ…å«å—å±æ€§çš„å®Œæ•´ HTMLï¼‰
- ç¼ºå°‘å¿…é¡»çš„å±æ€§ï¼š`data-node-id`ã€`data-type`ã€`class`ã€`updated`
- ç¼ºå°‘ `<div class="protyle-attr">` å±æ€§åŒºåŸŸ
- ä½ å°è¯•æå– markdownï¼Œä½†æ€æºçš„ transactions API **ä¸æ¥å— markdown**ï¼Œåªæ¥å— HTML

---

## é—®é¢˜ 4: âŒ æ²¡æœ‰ä½¿ç”¨æ€æºçš„å·¥å…·æ  API

### ä½ çš„ä»£ç  (toolbarHijacker.ts:129-143)
```typescript
// âŒ é”™è¯¯ï¼šåŠ«æŒ showContent åè‡ªå·±é‡æ–°å®ç°é«˜äº®é€»è¾‘
editor.protyle.toolbar.showContent = function(protyle: any, range: Range, nodeElement: Element) {
    hijacker.originalShowContent.call(this, protyle, range, nodeElement);
    
    setTimeout(() => {
        hijacker.enhanceToolbar(this, range, nodeElement, protyle);  // âŒ è‡ªå·±å®ç°
    }, 50);
};
```

### æ€æºåŸç”Ÿæ–¹å¼ (app/src/protyle/toolbar/Font.ts:228-287)
```typescript
// âœ… æ­£ç¡®ï¼šè°ƒç”¨æ€æºçš„ setInlineMark
export const fontEvent = (protyle: IProtyle, nodeElements: Element[], type?: string, color?: string) => {
    if (nodeElements && nodeElements.length > 0) {
        // æ‰¹é‡ä¿®æ”¹å·²é€‰ä¸­çš„å—
        updateBatchTransaction(nodeElements, protyle, (e: HTMLElement) => {
            if (type === "backgroundColor") {
                e.style.backgroundColor = color;
            }
        });
    } else {
        // âœ… å…³é”®ï¼šè°ƒç”¨ setInlineMark æ·»åŠ é«˜äº®
        protyle.toolbar.setInlineMark(protyle, "text", "range", {type, color});
    }
};
```

### ä¸ºä»€ä¹ˆé”™è¯¯ï¼Ÿ
- ä½ æ²¡æœ‰è°ƒç”¨ `protyle.toolbar.setInlineMark`
- è‡ªå·±æ‰‹åŠ¨å®ç°çš„é€»è¾‘ç¼ºå°‘å¾ˆå¤šè¾¹ç•Œå¤„ç†ï¼š
  - è·¨ span é€‰æ‹©çš„åˆå¹¶
  - é›¶å®½å­—ç¬¦ï¼ˆZWSPï¼‰çš„å¤„ç†
  - è¡¨æ ¼ã€ä»£ç å—ç­‰ç‰¹æ®Šåœºæ™¯
  - Range è¾¹ç•Œçš„è°ƒæ•´

---

## é—®é¢˜ 5: âŒ ç¼ºå°‘ undoOperationsï¼ˆæ’¤é”€æ“ä½œï¼‰

### ä½ çš„ä»£ç 
```typescript
// âŒ å®Œå…¨æ²¡æœ‰ undoOperations çš„æ¦‚å¿µ
const updateResult = await this.api.updateBlock(blockId, newContent, "markdown");
```

### æ€æºåŸç”Ÿæ–¹å¼
```typescript
// âœ… æ¯æ¬¡ä¿®æ”¹éƒ½éœ€è¦åŒæ—¶æä¾› do å’Œ undo æ“ä½œ
transaction(protyle, 
    // doOperations - è¦æ‰§è¡Œçš„æ“ä½œ
    [{
        id: blockId,
        data: newHTML,
        action: "update"
    }], 
    // undoOperations - æ’¤é”€æ“ä½œï¼ˆCtrl+Z ç”¨ï¼‰
    [{
        id: blockId,
        data: oldHTML,
        action: "update"
    }]
);
```

### ä¸ºä»€ä¹ˆé‡è¦ï¼Ÿ
- ç”¨æˆ·æŒ‰ `Ctrl+Z` æ—¶æ— æ³•æ’¤é”€
- æ€æºçš„**ååŒç¼–è¾‘**ä¾èµ– undoOperations
- **å†å²è®°å½•**åŠŸèƒ½éœ€è¦å®Œæ•´çš„æ“ä½œè®°å½•

---

## ğŸ”§ æ­£ç¡®çš„å®ç°æ–¹å¼

### æ–¹æ¡ˆ A: å®Œå…¨å¤ç”¨æ€æºåŸç”Ÿæ–¹æ³•ï¼ˆæ¨èï¼‰

```typescript
// 1. åŠ«æŒå·¥å…·æ ï¼Œä½†è°ƒç”¨åŸç”Ÿ API
private enhanceToolbar(toolbar: any, range: Range, nodeElement: Element, protyle: any): void {
    // æ·»åŠ ä½ çš„è‡ªå®šä¹‰æŒ‰é’®
    const btn = document.createElement('button');
    btn.onclick = () => {
        // âœ… è°ƒç”¨æ€æºåŸç”Ÿçš„ fontEvent
        const color = '#fff3cd';  // ä½ çš„è‡ªå®šä¹‰é¢œè‰²
        
        // å…³é”®ï¼šè°ƒç”¨æ€æºçš„ API
        protyle.toolbar.setInlineMark(protyle, "text", "range", {
            type: "backgroundColor",
            color: color
        });
    };
}
```

### æ–¹æ¡ˆ B: ä½¿ç”¨ transactions APIï¼ˆå¦‚æœå¿…é¡»è‡ªå®šä¹‰ï¼‰

```typescript
private async applyHighlight(protyle: any, range: Range, nodeElement: Element, color: string): Promise<void> {
    const blockElement = hasClosestBlock(range.startContainer);
    const blockId = blockElement.getAttribute("data-node-id");
    
    // 1. ä¿å­˜æ—§çš„å®Œæ•´ HTML
    const oldHTML = blockElement.outerHTML;  // âœ… outerHTMLï¼Œä¸æ˜¯ innerHTML
    
    // 2. ä½¿ç”¨æ€æºçš„ setInlineMark åˆ›å»º span
    const span = document.createElement("span");
    span.setAttribute("data-type", "text");
    span.style.backgroundColor = color;
    span.textContent = range.toString();
    
    range.deleteContents();
    range.insertNode(span);
    
    // 3. è·å–æ–°çš„å®Œæ•´ HTML
    const newHTML = blockElement.outerHTML;  // âœ… outerHTML
    
    // 4. ä½¿ç”¨ transactions API ä¿å­˜
    await fetchPost("/api/transactions", {
        session: protyle.id,
        app: "siyuan",
        transactions: [{
            doOperations: [{
                action: "update",
                id: blockId,
                data: newHTML  // âœ… å®Œæ•´çš„å— HTML
            }],
            undoOperations: [{
                action: "update",
                id: blockId,
                data: oldHTML  // âœ… æ—§çš„å®Œæ•´å— HTML
            }]
        }]
    });
}
```

---

## ğŸš« ä½ ä¸åº”è¯¥åšçš„äº‹æƒ…

### âŒ ä¸è¦è‡ªå·±è§£æ/ç”Ÿæˆ Markdown
```typescript
// âŒ é”™è¯¯
const markdownContent = await this.extractMarkdownFromBlock(blockElement);
const processedHtml = this.convertHighlightSpansToMarkdown(modifiedHtml);
```
**åŸå› **ï¼šæ€æºä¼šè‡ªåŠ¨å¤„ç† HTML â†’ Markdown çš„è½¬æ¢

### âŒ ä¸è¦ä½¿ç”¨ getBlockKramdown
```typescript
// âŒ é”™è¯¯
const response = await this.api.getBlockKramdown(blockId);
```
**åŸå› **ï¼šä½ ä¸éœ€è¦è·å– Kramdownï¼Œç›´æ¥æ“ä½œ DOM ç„¶åæäº¤ outerHTML å³å¯

### âŒ ä¸è¦æ‰‹åŠ¨å¤„ç† IAL
```typescript
// âŒ é”™è¯¯
const processedInnerHTML = this.processLinkWithHighlights(span);
```
**åŸå› **ï¼šæ€æºçš„åç«¯ä¼šè‡ªåŠ¨è§£æ HTML ç”Ÿæˆ IAL

### âŒ ä¸è¦ä¿å­˜ innerHTML
```typescript
// âŒ é”™è¯¯
const newContent = blockElement.innerHTML;
```
**åŸå› **ï¼šå¿…é¡»ä½¿ç”¨ `outerHTML` åŒ…å«å®Œæ•´çš„å—ç»“æ„

---

## âœ… æ¨èçš„ä¿®æ”¹æ­¥éª¤

### æ­¥éª¤ 1: åˆ é™¤é”™è¯¯çš„ API å°è£…
```typescript
// åˆ é™¤ toolbarHijacker.ts çš„ 28-57 è¡Œ
// ä¸éœ€è¦è‡ªå·±å°è£… updateBlock å’Œ getBlockKramdown
```

### æ­¥éª¤ 2: ä½¿ç”¨ siyuan åŒ…çš„ fetchPost
```typescript
import { fetchPost } from "siyuan";

// ä½¿ç”¨å®˜æ–¹çš„ fetchPost è°ƒç”¨ transactions API
await fetchPost("/api/transactions", { ... });
```

### æ­¥éª¤ 3: ç®€åŒ– applyHighlight æ–¹æ³•
```typescript
private async applyHighlight(protyle: any, range: Range, color: string): Promise<void> {
    // ç›´æ¥è°ƒç”¨æ€æºçš„ setInlineMark
    protyle.toolbar.setInlineMark(protyle, "text", "range", {
        type: "backgroundColor",
        color: color
    });
}
```

### æ­¥éª¤ 4: åˆ é™¤æ‰€æœ‰ Markdown ç›¸å…³ä»£ç 
```typescript
// åˆ é™¤ä»¥ä¸‹æ–¹æ³•ï¼ˆ845-1381 è¡Œï¼‰ï¼š
// - extractMarkdownFromBlock
// - mergeHighlightIntoMarkdown
// - convertHighlightSpansToMarkdown
// - processLinkWithHighlights

// åŸå› ï¼šæ€æºä¼šè‡ªåŠ¨å¤„ç†ï¼Œä¸éœ€è¦æ‰‹åŠ¨è½¬æ¢
```

### æ­¥éª¤ 5: ä¿®å¤äº‹åŠ¡æäº¤
```typescript
// å¦‚æœå¿…é¡»è‡ªå®šä¹‰å®ç°ï¼Œä½¿ç”¨æ­£ç¡®çš„æ ¼å¼
const blockElement = hasClosestBlock(range.startContainer);
const oldHTML = blockElement.outerHTML;  // âœ…

// ... DOM æ“ä½œ ...

const newHTML = blockElement.outerHTML;  // âœ…

await fetchPost("/api/transactions", {
    session: protyle.id,
    app: "siyuan",
    transactions: [{
        doOperations: [{ action: "update", id: blockId, data: newHTML }],
        undoOperations: [{ action: "update", id: blockId, data: oldHTML }]
    }]
});
```

---

## ğŸ“Š é—®é¢˜å½±å“ç­‰çº§

| é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | å½±å“ | ä¿®å¤ä¼˜å…ˆçº§ |
|------|---------|------|-----------|
| ä½¿ç”¨é”™è¯¯çš„ API | ğŸ”´ è‡´å‘½ | æ•°æ®æ— æ³•æ­£ç¡®ç´¢å¼•åˆ° spans/attributes è¡¨ | P0 |
| æ‰‹åŠ¨åˆ›å»º span ä¸ç¬¦åˆè§„èŒƒ | ğŸ”´ è‡´å‘½ | ç¼ºå°‘ IALï¼Œæ— æ³•è¢«æ€æºæ­£ç¡®è¯†åˆ« | P0 |
| ä¿å­˜æ ¼å¼é”™è¯¯ | ğŸ”´ è‡´å‘½ | å—ç»“æ„ä¸å®Œæ•´ï¼Œå¯¼è‡´æ•°æ®æŸå | P0 |
| æ²¡æœ‰ä½¿ç”¨ setInlineMark | ğŸŸ  ä¸¥é‡ | ç¼ºå°‘è¾¹ç•Œå¤„ç†ï¼Œæ˜“å‡º bug | P1 |
| ç¼ºå°‘ undoOperations | ğŸŸ¡ ä¸­ç­‰ | æ— æ³•æ’¤é”€ï¼Œç”¨æˆ·ä½“éªŒå·® | P2 |

---

## ğŸ¯ æœ€ç®€å•çš„ä¿®å¤æ–¹æ¡ˆ

**ç›´æ¥è°ƒç”¨æ€æºåŸç”Ÿæ–¹æ³•ï¼Œä¸è¦é‡æ–°å®ç°ï¼**

```typescript
// toolbarHijacker.ts - ç®€åŒ–ç‰ˆ
private createHighlightButton(colorConfig: any, range: Range, protyle: any): HTMLButtonElement {
    const btn = document.createElement('button');
    btn.style.cssText = `background: ${colorConfig.bg} !important; ...`;
    
    btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        
        // âœ… æ ¸å¿ƒï¼šç›´æ¥è°ƒç”¨æ€æºåŸç”Ÿ API
        protyle.toolbar.setInlineMark(protyle, "text", "range", {
            type: "backgroundColor",
            color: colorConfig.bg
        });
        
        // å®Œæˆï¼æ€æºä¼šè‡ªåŠ¨ï¼š
        // 1. åˆ›å»ºç¬¦åˆè§„èŒƒçš„ span
        // 2. ç”Ÿæˆ IAL
        // 3. è°ƒç”¨ /api/transactions
        // 4. æ›´æ–°æ•°æ®åº“ï¼ˆblocksã€spansã€attributesï¼‰
        // 5. æ”¯æŒæ’¤é”€ï¼ˆundoOperationsï¼‰
    });
    
    return btn;
}
```

è¿™æ ·ä¿®æ”¹åï¼Œä½ çš„ä»£ç é‡å¯ä»¥**å‡å°‘ 80%**ï¼Œè€Œä¸”æ›´åŠ ç¨³å®šå¯é ï¼

