# 数据库编辑防护 - 详细使用说明

## 📋 功能说明

在编辑思源笔记的数据库单元格或文档内容时，自动暂停数据库的排序和过滤功能，防止正在编辑的内容被意外移动或隐藏。

---

## 🔧 安装方法

### 方法一：通过思源的代码片段（推荐）

1. **打开思源笔记**

2. **进入设置**
   - 点击右上角 ⚙️ 图标
   - 或按快捷键 `Ctrl + Shift + P`

3. **找到代码片段**
   - 左侧菜单选择 **外观**
   - 点击 **代码片段** 标签
   - 选择 **JS** 子标签

4. **添加脚本**
   - 点击右上角的 **+** 按钮
   - 将 `数据库编辑防护.js` 的全部内容复制粘贴进去
   - 点击 **确定** 保存

5. **刷新思源**
   - 按 `F5` 或 `Ctrl + R`
   - 或关闭思源重新打开

### 方法二：通过主题自定义 JS

如果你的主题支持自定义 JS：

1. 将 `数据库编辑防护.js` 复制到：
   ```
   工作空间/conf/appearance/themes/你的主题名/
   ```

2. 在主题的 `theme.js` 或配置文件中引用这个脚本

---

## ✅ 验证是否成功

### 1. 打开浏览器控制台

- 按 `F12` 键
- 或右键点击页面 → 选择 **检查**
- 切换到 **Console（控制台）** 标签

### 2. 查看日志

如果安装成功，应该看到以下日志：

```
[数据库编辑防护] ✓ 脚本文件已加载
[数据库编辑防护 v2.0] 脚本开始加载...
[数据库编辑防护] 🚀 准备初始化...
[数据库编辑防护] document.readyState: complete
[数据库编辑防护] DOM 已就绪，延迟启动...
[数据库编辑防护] 开始初始化...
[数据库编辑防护] ✓ 编辑状态监听器已启动
[数据库编辑防护] ✓ 请求拦截器已注入
[数据库编辑防护] ✅ 启动成功！
```

### 3. 测试功能

1. **打开一个数据库文档**

2. **点击某个单元格开始编辑**
   - 控制台应显示：
     ```
     [数据库编辑防护] 🔒 数据库编辑模式已启用
     ```

3. **尝试触发排序或过滤**
   - 如果脚本工作正常，操作会被拦截
   - 控制台显示：
     ```
     [数据库编辑防护] ⛔ 已阻止操作: setAttrViewSorts
     └─ 原因：检测到正在编辑（数据库=true, 编辑器=false）
     ```

---

## 🐛 故障排查

### 问题 1：控制台显示 `undefined`

```javascript
window.siyuanDbProtection.getState()
// Uncaught TypeError: Cannot read properties of undefined (reading 'getState')
```

**原因**：脚本没有加载或执行失败

**解决方法**：
1. 检查控制台是否有 `[数据库编辑防护] ✓ 脚本文件已加载` 日志
2. 如果没有，说明脚本未添加成功，重新添加
3. 如果有但后续没有其他日志，查看是否有报错信息

### 问题 2：脚本加载了但不生效

**可能原因**：
- 延迟时间太短，思源还没完全加载
- DOM 选择器与实际页面结构不匹配

**解决方法**：
1. 修改延迟时间（第 264 行）：
   ```javascript
   setTimeout(() => {
       console.log('[数据库编辑防护] 开始初始化...');
       init();
   }, 2000); // 改为 2000 或 3000
   ```

2. 手动触发初始化：
   ```javascript
   // 在控制台执行
   window.siyuanDbProtection.forceEnable()
   ```

### 问题 3：排序/过滤仍然触发

**可能原因**：编辑状态没有被正确检测

**调试方法**：

1. 在控制台运行：
   ```javascript
   window.siyuanDbProtection.getState()
   ```
   查看当前状态是否为：
   ```javascript
   {isEditingDatabase: true, isEditingProtyle: false}
   ```

2. 手动强制启用保护：
   ```javascript
   window.siyuanDbProtection.forceEnable()
   ```

3. 如果手动启用后有效，说明是检测逻辑的问题，可以调整延迟时间：
   - 第 86 行：`delayResetEditingState('database', 5000);` // 改为 5秒
   - 第 94 行：`delayResetEditingState('protyle', 5000);` // 改为 5秒

---

## 🎮 调试命令

在浏览器控制台输入以下命令：

### 查看版本和状态
```javascript
window.siyuanDbProtection
```

### 查看当前编辑状态
```javascript
window.siyuanDbProtection.getState()
// 返回: {isEditingDatabase: false, isEditingProtyle: false}
```

### 手动启用保护（调试用）
```javascript
window.siyuanDbProtection.forceEnable()
```

### 手动禁用保护（调试用）
```javascript
window.siyuanDbProtection.forceDisable()
```

### 手动设置状态
```javascript
window.siyuanDbProtection.setEditingState('database', true)
window.siyuanDbProtection.setEditingState('protyle', true)
```

---

## ⚙️ 高级配置

### 调整延迟时间

如果发现保护过早关闭，可以增加延迟：

**位置 1**：编辑后保持保护的时间（第 86、94 行）
```javascript
delayResetEditingState('database', 5000); // 默认 2000ms，改为 5000ms
```

**位置 2**：失去焦点后保持保护的时间（第 115、116 行）
```javascript
delayResetEditingState('database', 2000); // 默认 500ms，改为 2000ms
delayResetEditingState('protyle', 2000);
```

### 调整初始化延迟

如果脚本加载太早，思源还没准备好：

**位置**：第 264 行
```javascript
setTimeout(() => {
    console.log('[数据库编辑防护] 开始初始化...');
    init();
}, 2000); // 默认 1000ms，改为 2000ms 或更长
```

---

## 📝 工作原理

1. **监听事件**：
   - `focusin` - 检测焦点进入数据库或编辑器
   - `input` - 检测输入操作
   - `click` - 检测点击单元格
   - `keydown` - 检测键盘输入
   - `focusout` - 检测失去焦点

2. **设置标志**：
   - 检测到编辑操作时，设置全局标志 `isEditingDatabase = true`
   - 使用防抖机制，延迟 2-3 秒后自动重置

3. **拦截请求**：
   - 劫持 `window.fetch` 函数
   - 检查发往 `/api/transactions` 的请求
   - 过滤掉 `setAttrViewSorts` 和 `setAttrViewFilters` 操作
   - 返回成功响应，让思源以为操作完成了

---

## 🆘 需要帮助？

如果以上方法都不能解决问题，请提供以下信息：

1. **控制台的完整日志**（从脚本加载开始）
2. **思源笔记版本号**
3. **使用的主题名称**
4. **具体的操作步骤**和什么时候失效

这样我可以更准确地帮你解决问题！

