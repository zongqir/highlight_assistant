# 手机端插件弹窗屏蔽脚本 - 使用说明

## 📱 功能简介

这是一个专门为思源笔记手机端设计的脚本，用于自动屏蔽/隐藏插件创建的弹窗、对话框和键盘工具栏。**基于 siyuan 源码实现，精准拦截**。

### ✨ 主要特性

- ✅ **屏蔽键盘工具栏**：隐藏手机端的 `#keyboardToolbar`（选择文本后弹出的工具栏）
- ✅ **屏蔽插件工具栏**：隐藏 `protyle-util`（插件自定义的编辑器工具栏）
- ✅ **屏蔽插件弹窗**：智能识别并隐藏插件创建的各类弹窗
- ✅ **移动端专属**：仅在手机端生效，不影响桌面端
- ✅ **支持白名单**：系统必要的UI（如菜单、面板）不受影响
- ✅ **多种拦截方式**：直接DOM操作、函数拦截、事件监听三管齐下
- ✅ **可手动控制**：支持随时启用/禁用，支持单独控制各个功能
- ✅ **详细日志**：可开启调试模式查看详细信息

### 🆕 v2.0 更新

- 🔥 **重写核心逻辑**：研究了 siyuan-master 源码，精准拦截手机端UI
- 🔥 **新增功能**：支持屏蔽键盘工具栏（最常用的功能）
- 🔥 **拦截 API**：hook `window.showKeyboardToolbar()` 函数
- 🔥 **事件监听**：监听 `mobile-keyboard-show` 插件事件
- 🔥 **分层控制**：可单独控制键盘工具栏、插件工具栏、插件弹窗

## 🚀 安装方法

### 方法一：通过代码片段（推荐）

1. 打开思源笔记
2. 进入 **设置 → 外观 → 代码片段**
3. 切换到 **JS** 标签页
4. 将 `屏蔽手机弹窗.js` 的内容复制粘贴进去
5. 点击保存
6. 重启思源笔记或刷新页面

### 方法二：通过插件加载

如果你在开发插件，可以在插件的 `onload` 方法中加载这个脚本：

```typescript
async onload() {
    // 加载屏蔽脚本
    const script = document.createElement('script');
    script.src = `/plugins/${this.name}/屏蔽手机弹窗.js`;
    document.head.appendChild(script);
}
```

## 💡 使用方法

### 基本使用

脚本加载后会自动工作，默认状态为**已启用**。

### 控制台命令

在浏览器控制台（开发者工具）中，可以使用以下命令：

#### 📖 查看帮助

```javascript
mdb.help()  // 显示完整的使用帮助
```

#### 📊 查看当前状态

```javascript
// 查看是否启用
mdb.enabled  // 返回 true 或 false

// 查看是否为移动端
mdb.isMobile  // 返回 true 或 false

// 查看统计信息
mdb.getStats()
// 返回：
// {
//   hiddenDialogs: 5,        // 已隐藏的UI元素数量
//   lastHiddenTime: "...",   // 最后隐藏时间
//   uptime: 123              // 运行时间（秒）
// }

// 查看配置
mdb.config
// blockKeyboardToolbar: true    - 是否屏蔽键盘工具栏
// blockPluginToolbar: true      - 是否屏蔽插件工具栏
// blockPluginDialogs: true      - 是否屏蔽插件弹窗
```

#### 🎛️ 启用/禁用功能

```javascript
// 启用所有屏蔽功能
mdb.enable()

// 禁用所有屏蔽功能
mdb.disable()

// 切换启用/禁用状态
mdb.toggle()

// ⭐ 单独控制键盘工具栏（最常用）
mdb.blockKeyboard()      // 只屏蔽键盘工具栏
mdb.unblockKeyboard()    // 只恢复键盘工具栏
```

#### 🛠️ 手动控制

```javascript
// 立即扫描并隐藏所有UI元素
mdb.scanNow()

// 恢复所有被隐藏的UI元素
mdb.restoreAll()
```

#### 🔍 调试功能

```javascript
// 启用详细日志（查看所有操作细节）
mdb.enableDebug()

// 关闭详细日志
mdb.disableDebug()

// 重置统计数据
mdb.resetStats()
```

## ⚙️ 配置选项

脚本支持通过修改 `CONFIG` 对象来自定义行为：

```javascript
const CONFIG = {
    debugMode: false,              // 是否启用详细调试日志
    autoHideDialogs: true,         // 是否自动隐藏弹窗
    hideDelay: 100,                // 隐藏延迟（毫秒）
    mobileOnly: true,              // 是否仅在移动端生效
    showNotification: true,        // 是否显示拦截通知
    
    // 弹窗特征选择器（可根据需要添加或删除）
    dialogSelectors: [
        '[style*="z-index: 99999"]',
        'div[style*="position: fixed"][style*="background: rgba"]',
        '.b3-dialog--open',
        // ... 更多选择器
    ],
    
    // 白名单（这些元素不会被屏蔽）
    whitelistSelectors: [
        '.protyle-util',              // 编辑器工具栏
        '.toolbar',                   // 工具栏
        '.b3-menu',                   // 菜单
        '.av__panel',                 // 数据库面板
        // ... 更多白名单
    ],
};
```

### 修改配置

如果需要修改配置，可以在控制台中：

```javascript
// 临时修改配置
mdb.config.hideDelay = 500;  // 修改隐藏延迟为 500ms
mdb.config.showNotification = false;  // 关闭通知

// 添加自定义选择器
mdb.config.dialogSelectors.push('.my-custom-dialog');

// 添加白名单
mdb.config.whitelistSelectors.push('.my-important-popup');
```

## 🎯 工作原理

### 1. 移动端检测（基于 siyuan 源码）

脚本会通过多种方式检测当前环境是否为移动端：

- **优先检测** `window.siyuan.mobile`（最准确）
- 检测 User Agent
- 检测屏幕宽度（<= 768px）
- 检测触摸支持
- 检测思源的移动端类名（`fn__mobile`、`body--mobile`）

### 2. 键盘工具栏拦截（核心功能）

手机端选择文本后会弹出键盘工具栏（`#keyboardToolbar`），脚本通过三种方式拦截：

**方法1：直接DOM操作**
```javascript
const toolbar = document.getElementById('keyboardToolbar');
toolbar.classList.add('fn__none');  // 添加隐藏类
toolbar.style.display = 'none';     // 强制隐藏
```

**方法2：函数拦截**
```javascript
// Hook window.showKeyboardToolbar() 函数
const originalShow = window.showKeyboardToolbar;
window.showKeyboardToolbar = function() {
    // 拦截调用，不执行原函数
    return;
};
```

**方法3：事件监听**
```javascript
// 监听插件事件 mobile-keyboard-show
plugin.eventBus.on('mobile-keyboard-show', () => {
    // 隐藏工具栏
});
```

### 3. protyle-util 拦截

`protyle-util` 是编辑器的工具栏（桌面端在顶部，手机端是 `protyle-util--mobile`）：

```javascript
// 查找并隐藏所有 protyle-util
const utils = document.querySelectorAll('.protyle-util:not(.fn__none)');
utils.forEach(util => hideDialog(util));
```

### 4. 插件弹窗识别

脚本会识别以下特征的元素作为弹窗：

- 高 z-index（>=1000 或 99999）的固定定位元素
- 包含半透明背景的全屏遮罩（`backdrop-filter`）
- 带有特定类名的对话框（`.b3-dialog`、`.b3-dialog--open`）
- 自定义对话框（`[data-type="dialog"]`、`[data-type="popup"]`）

### 5. 白名单机制

以下元素不会被屏蔽：

- `.b3-menu`：系统菜单
- `.av__panel`：数据库面板  
- `[data-type="wnd"]`：窗口
- `.protyle-wysiwyg`：编辑器内容
- `.protyle-title`：文档标题

### 6. DOM 监听

脚本使用 `MutationObserver` 持续监听 DOM 变化：

- 检测新增的元素
- 自动处理动态创建的UI
- 实时响应页面变化

## 🔧 故障排除

### 脚本不生效？

1. **检查是否为移动端环境**

   ```javascript
   mdb.isMobile  // 应该返回 true
   ```

2. **检查脚本是否已加载**

   ```javascript
   window.mdb  // 应该返回脚本对象
   ```

3. **检查是否已启用**

   ```javascript
   mdb.enabled  // 应该返回 true
   ```

4. **手动扫描弹窗**

   ```javascript
   mdb.scanNow()
   ```

5. **开启调试模式**

   ```javascript
   mdb.enableDebug()
   ```

### 某些弹窗没有被屏蔽？

可能是弹窗的特征不在识别范围内，可以：

1. **查看弹窗的 HTML 结构**

   在浏览器开发者工具中检查弹窗元素

2. **添加自定义选择器**

   ```javascript
   // 添加到配置中
   mdb.config.dialogSelectors.push('.your-dialog-class');
   
   // 重新扫描
   mdb.scanNow();
   ```

### 某些必要的弹窗被误屏蔽？

将该弹窗添加到白名单：

```javascript
// 添加到白名单
mdb.config.whitelistSelectors.push('.important-dialog');

// 恢复已隐藏的弹窗
mdb.restoreAll();

// 重新扫描（会跳过白名单中的元素）
mdb.scanNow();
```

## 📊 统计信息

脚本会记录以下统计信息：

```javascript
mdb.getStats()
// {
//   hiddenDialogs: 10,           // 已隐藏的弹窗数量
//   lastHiddenTime: "2024-...",  // 最后隐藏时间
//   uptime: 3600                 // 运行时间（秒）
// }
```

## ⚠️ 注意事项

1. **仅在移动端生效**：默认配置下，脚本只在移动端环境中工作
2. **可能影响正常功能**：某些插件的弹窗可能包含重要功能，被屏蔽后可能影响使用
3. **白名单管理**：建议仔细配置白名单，避免误屏蔽系统必要的弹窗
4. **性能影响**：脚本会持续监听 DOM 变化，可能对性能有轻微影响

## 🛠️ 高级用法

### 针对特定插件屏蔽

如果只想屏蔽特定插件的弹窗：

```javascript
// 只屏蔽特定类名的弹窗
mdb.config.dialogSelectors = [
    '.highlight-assistant-dialog',  // 只屏蔽这个插件的弹窗
];

mdb.scanNow();
```

### 设置延迟隐藏

有时需要让弹窗短暂显示后再隐藏：

```javascript
// 设置延迟 1 秒后隐藏
mdb.config.hideDelay = 1000;
```

### 完全禁用自动隐藏，仅手动控制

```javascript
// 禁用自动隐藏
mdb.config.autoHideDialogs = false;

// 需要时手动扫描
mdb.scanNow();
```

## 🎨 示例场景

### 场景1：临时查看某个弹窗

```javascript
// 1. 禁用屏蔽
mdb.disable()

// 2. 恢复所有弹窗
mdb.restoreAll()

// 3. 查看完毕后重新启用
mdb.enable()
```

### 场景2：调试弹窗问题

```javascript
// 1. 启用调试模式
mdb.enableDebug()

// 2. 触发弹窗，观察控制台日志

// 3. 查看被隐藏的弹窗
mdb.getStats()

// 4. 关闭调试模式
mdb.disableDebug()
```

### 场景3：选择性屏蔽

```javascript
// 只屏蔽高亮插件的标签选择对话框
mdb.config.dialogSelectors = [
    '[style*="z-index: 99999"]',  // 通用高 z-index 弹窗
];

// 允许其他弹窗
mdb.config.whitelistSelectors.push('.protyle-util', '.b3-menu');

mdb.scanNow();
```

## 📝 更新日志

### v2.0 (2024-10-05)

- 🔥 **重大更新**：研究 siyuan-master 源码后完全重写
- ✅ **新增功能**：屏蔽手机端键盘工具栏（`#keyboardToolbar`）
- ✅ **新增功能**：屏蔽编辑器工具栏（`protyle-util`）
- ✅ **三重拦截**：DOM操作 + 函数Hook + 事件监听
- ✅ **分层控制**：可单独控制各个屏蔽功能
- ✅ **精准识别**：基于 siyuan 实际实现的选择器

### v1.0 (2024-10-04)

- 🎉 初始版本发布
- ✅ 支持自动检测移动端环境
- ✅ 支持多种弹窗识别方式
- ✅ 支持白名单机制
- ✅ 支持手动控制
- ✅ 提供详细的调试日志

## 🤝 反馈与建议

如果你在使用过程中遇到问题，或有改进建议，欢迎反馈！

---

**最后更新时间**：2024-10-04

