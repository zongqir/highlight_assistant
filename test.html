<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§¦æ‘¸é€‰æ‹©æµ‹è¯•</title>
    <style>
        body { 
            font-family: Arial; 
            padding: 20px; 
            line-height: 1.6;
        }
        .test-content {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .popup {
            position: fixed;
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
        }
        .color-btn {
            width: 30px;
            height: 30px;
            margin: 2px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .yellow { background: #fff3cd; }
        .green { background: #d4edda; }
        .blue { background: #cce5ff; }
        .pink { background: #fce4ec; }
    </style>
</head>
<body>
    <h1>ğŸ§ª è§¦æ‘¸é€‰æ‹©æµ‹è¯•</h1>
    <p>åœ¨ä¸‹é¢çš„æ–‡æœ¬ä¸­é€‰æ‹©å†…å®¹ï¼Œåº”è¯¥ä¼šå‡ºç°é«˜äº®å¼¹çª—ï¼š</p>
    
    <div class="test-content protyle-wysiwyg">
        <p>è¿™æ˜¯ä¸€æ®µæµ‹è¯•æ–‡æœ¬ã€‚è¯·å°è¯•é€‰æ‹©è¿™äº›æ–‡å­—ï¼Œçœ‹çœ‹æ˜¯å¦ä¼šå‡ºç°é«˜äº®å·¥å…·ã€‚</p>
        <p>åœ¨æ‰‹æœºä¸Šï¼Œè¯·é•¿æŒ‰æ–‡æœ¬å¼€å§‹é€‰æ‹©ï¼Œç„¶åçœ‹çœ‹æ˜¯å¦ä¼šå¼¹å‡ºæˆ‘ä»¬çš„é«˜äº®å·¥å…·ã€‚</p>
        <p>å¦‚æœè¿™ä¸ªæ–¹æ¡ˆæœ‰æ•ˆï¼Œæˆ‘ä»¬å°±æ‰¾åˆ°äº†è§£å†³æ–¹æ¡ˆï¼</p>
    </div>
    
    <div id="popup" class="popup">
        <button class="color-btn yellow" onclick="highlight('yellow')"></button>
        <button class="color-btn green" onclick="highlight('green')"></button>
        <button class="color-btn blue" onclick="highlight('blue')"></button>
        <button class="color-btn pink" onclick="highlight('pink')"></button>
    </div>
    
    <div id="log" style="margin-top: 20px; padding: 10px; background: #f9f9f9; border-radius: 4px;">
        <strong>æ—¥å¿—:</strong><br>
    </div>

    <script>
        let currentSelection = null;
        
        function log(message) {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '<br>';
            console.log(message);
        }
        
        // æ ¸å¿ƒç›‘å¬é€»è¾‘ - ç›´æ¥ç›‘å¬touchend
        document.addEventListener('touchend', function() {
            log('touchend è§¦å‘');
            
            // çŸ­å»¶è¿Ÿè®©ç³»ç»Ÿå®Œæˆé€‰æ‹©å¤„ç†
            setTimeout(function() {
                checkSelection();
            }, 50);
        }, true);
        
        // ä¹Ÿç›‘å¬mouseupä»¥æ”¯æŒæ¡Œé¢æµ‹è¯•
        document.addEventListener('mouseup', function() {
            log('mouseup è§¦å‘');
            setTimeout(checkSelection, 50);
        });
        
        function checkSelection() {
            const selection = window.getSelection();
            const text = selection ? selection.toString().trim() : '';
            
            log('æ£€æŸ¥é€‰æ‹©: "' + text + '"');
            
            if (!text) {
                hidePopup();
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦åœ¨æµ‹è¯•åŒºåŸŸå†…
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const container = range.startContainer;
                const element = container.nodeType === Node.TEXT_NODE ? 
                    container.parentElement : container;
                
                // æŸ¥æ‰¾protyle-wysiwygå®¹å™¨
                let current = element;
                let inEditor = false;
                for (let i = 0; i < 10 && current; i++) {
                    if (current.classList && current.classList.contains('protyle-wysiwyg')) {
                        inEditor = true;
                        break;
                    }
                    current = current.parentElement;
                }
                
                if (inEditor) {
                    log('âœ… åœ¨ç¼–è¾‘å™¨ä¸­é€‰æ‹©äº†: ' + text);
                    showPopup(range);
                    currentSelection = selection;
                } else {
                    log('âŒ ä¸åœ¨ç¼–è¾‘å™¨ä¸­');
                    hidePopup();
                }
            }
        }
        
        function showPopup(range) {
            const popup = document.getElementById('popup');
            const rect = range.getBoundingClientRect();
            
            popup.style.left = (rect.left + rect.width / 2 - 70) + 'px';
            popup.style.top = (rect.bottom + 10) + 'px';
            popup.style.display = 'block';
            
            log('ğŸ¯ æ˜¾ç¤ºå¼¹çª—');
        }
        
        function hidePopup() {
            document.getElementById('popup').style.display = 'none';
            currentSelection = null;
        }
        
        function highlight(color) {
            if (!currentSelection) return;
            
            try {
                const range = currentSelection.getRangeAt(0);
                const text = range.toString();
                
                // åˆ›å»ºé«˜äº®span
                const span = document.createElement('span');
                span.style.backgroundColor = getColorValue(color);
                span.style.borderRadius = '2px';
                span.style.padding = '1px 2px';
                span.textContent = text;
                
                // æ›¿æ¢é€‰æ‹©å†…å®¹
                range.deleteContents();
                range.insertNode(span);
                
                // æ¸…é™¤é€‰æ‹©
                currentSelection.removeAllRanges();
                
                log('ğŸ¨ åº”ç”¨ ' + color + ' é«˜äº®: ' + text);
                hidePopup();
                
            } catch (error) {
                log('âŒ é«˜äº®å¤±è´¥: ' + error.message);
            }
        }
        
        function getColorValue(color) {
            const colors = {
                yellow: '#fff3cd',
                green: '#d4edda', 
                blue: '#cce5ff',
                pink: '#fce4ec'
            };
            return colors[color] || '#fff3cd';
        }
        
        // é¡µé¢åŠ è½½å®Œæˆ
        log('ğŸš€ æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
        log('ğŸ’¡ è¯·åœ¨ä¸Šæ–¹æ–‡æœ¬ä¸­é€‰æ‹©å†…å®¹è¿›è¡Œæµ‹è¯•');
    </script>
</body>
</html>

