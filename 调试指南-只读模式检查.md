# 只读模式检查调试指南

## 功能概述

本次更新添加了详细的只读模式检查和调试日志功能，帮助你了解弹窗在什么情况下出现。

## 新增功能

### 1. 系统只读模式检查
插件会自动检测思源笔记是否处于只读模式（阅读模式）

### 2. 详细的调试日志
在以下关键时刻会输出详细日志：
- 插件启动时
- 工具栏劫持时
- 选中文本触发工具栏时
- 显示备注弹窗时

## 如何查看调试日志

### 电脑版
1. 打开思源笔记
2. 按 `F12` 或 `Ctrl+Shift+I` 打开开发者工具
3. 切换到 `Console` (控制台) 标签
4. 查看带有以下前缀的日志：
   - `[ToolbarHijacker]` - 工具栏劫持相关
   - `[ReadonlyChecker]` - 只读模式检查相关
   - `[Plugin]` - 插件整体相关

### 手机版
1. 在手机浏览器中打开思源笔记
2. 使用远程调试工具（如 Chrome DevTools）
3. 查看控制台日志

## 日志示例

### 启动时的日志
```
[ToolbarHijacker] 🚀 ========== 启动工具栏劫持 ==========
[ToolbarHijacker] 环境: { isMobile: false, isDesktop: true }
[ToolbarHijacker] 🔐 检查系统只读状态...
[ReadonlyChecker] 🔐 检查系统只读模式...
[ReadonlyChecker] 🔒 系统为只读模式
[ReadonlyChecker] 系统配置: { readOnly: true, isPublish: false, start: true }
```

### 选中文本时的日志
```
[ToolbarHijacker] 🎯 ========== 工具栏 showContent 被触发 ==========
[ToolbarHijacker] 选中文本: 这是测试文本
[ReadonlyChecker] 🔐 检查系统只读模式...
[ReadonlyChecker] 🔒 系统为只读模式
[ToolbarHijacker] 当前系统状态: 🔒 只读模式（正常）
[ToolbarHijacker] ✨ 增强工具栏...
```

### 显示备注弹窗时的日志
```
[ToolbarHijacker] 💬 ========== 显示备注弹窗 ==========
[ReadonlyChecker] 🔐 检查系统只读模式...
[ReadonlyChecker] 🔒 系统为只读模式
[ToolbarHijacker] 📋 系统状态: 🔒 只读模式
[ToolbarHijacker] 🎨 准备显示备注输入对话框...
```

## 日志图标说明

- 🚀 - 启动/初始化
- 🔐 - 安全/权限检查
- 🔒 - 只读模式（已启用）
- ✏️ - 可写模式
- 📋 - 调用原生方法
- ✨ - 增强功能
- 💬 - 对话框/弹窗
- 📄 - 文档相关
- 📚 - 笔记本相关
- ✅ - 成功
- ❌ - 失败
- ⚠️ - 警告
- 🧪 - 测试/调试

## 重要发现

根据你的描述，**弹窗只在只读模式下出现**。从日志中你可以验证：

1. **检查系统状态**
   - 如果日志显示 `🔒 系统为只读模式` → 正常，应该出现弹窗
   - 如果日志显示 `✏️ 系统为可写模式` → 可能不出现弹窗

2. **检查工具栏增强**
   - 查找日志 `✨ 增强工具栏...`
   - 如果没有这条日志，说明增强失败

3. **检查备注弹窗触发**
   - 查找日志 `💬 ========== 显示备注弹窗 ==========`
   - 如果有这条日志，说明弹窗逻辑被触发

## 常见问题排查

### Q1: 弹窗没有出现
**排查步骤：**
1. 检查控制台是否有 `🔒 系统为只读模式` 日志
2. 检查是否有 `✨ 增强工具栏...` 日志
3. 检查是否有错误日志（红色）

### Q2: 如何切换只读模式
在思源笔记中：
- 电脑版：点击右上角的阅读模式图标
- 手机版：通常默认为只读模式

### Q3: 日志太多，如何过滤
在 Chrome 开发者工具的 Console 中：
1. 使用过滤器输入框
2. 输入 `[ToolbarHijacker]` 或 `[ReadonlyChecker]`
3. 只显示相关日志

## 全局调试函数

### 1. 检查劫持状态

在控制台中输入 `testHijack()` 可以查看当前劫持状态：

```javascript
testHijack()
```

输出示例：
```
🧪 手动测试劫持状态...
- 劫持器存在: true
- 劫持状态: true
- 是否手机版: false
- 是否电脑版: true
- 编辑器数量: 1
- 编辑器0: { hasProtyle: true, hasToolbar: true, hasShowContent: true }
```

### 2. 高亮点击调试模式

**功能说明**：可以开启/关闭高亮点击的详细调试日志，帮助分析DOM结构和元素识别过程。

#### 开启调试模式

```javascript
highlightDebug.enable()
```

输出：
```
[HighlightClickManager] ✅ 调试模式已开启
```

**开启后的效果**：点击任何元素时，会输出详细的DOM分析日志：

```
🔍 ========== DOM 结构分析 ==========
点击的元素: {
  tagName: 'SPAN',
  dataType: 'strong text',
  className: '',
  textContent: '测试文本',
  backgroundColor: 'rgb(252, 228, 236)'
}
完整HTML结构: <span data-type="strong text" style="background-color: rgb(252, 228, 236);">...</span>

📊 向上查找DOM树:
深度 0: {
  tagName: 'SPAN',
  dataType: 'strong text',
  backgroundColor: 'rgb(252, 228, 236)',
  hasBackgroundColor: true,
  className: ''
}
  HTML片段: <span data-type="strong text" style="background-color: rgb(252, 228, 236);">测试文本</span>
✅ 在深度 0 找到高亮元素! (data-type="strong text")
========== DOM 分析结束 ==========
```

#### 关闭调试模式

```javascript
highlightDebug.disable()
```

输出：
```
[HighlightClickManager] ❌ 调试模式已关闭
```

**关闭后的效果**：不再输出DOM分析日志，保持控制台干净。

#### 使用场景

- 🐛 **排查识别问题**：当某些高亮文本点击无反应时
- 🔬 **分析DOM结构**：了解不同格式组合的HTML结构
- 📖 **学习实现原理**：查看元素识别的查找过程
- 🚀 **日常使用**：保持关闭状态（默认）

#### 调试日志说明

| 日志项 | 说明 |
|--------|------|
| `点击的元素` | 鼠标点击的直接目标元素信息 |
| `完整HTML结构` | 点击元素的HTML代码（前500字符） |
| `向上查找DOM树` | 从点击元素向上遍历父元素的过程 |
| `深度 N` | 当前查找的层级（0=点击元素本身） |
| `HTML片段` | 每一层元素的HTML代码（前300字符） |
| `hasBackgroundColor` | 是否有有效的背景色 |
| `✅ 找到高亮元素` | 成功找到可操作的高亮元素 |
| `❌ 未找到高亮元素` | 未找到符合条件的高亮元素 |

#### 支持的格式组合

调试日志可以帮助你验证以下格式是否正确识别：

- ✅ 纯高亮：`data-type="text"`
- ✅ 高亮+加粗：`data-type="strong text"`
- ✅ 高亮+斜体：`data-type="em text"`
- ✅ 高亮+加粗+斜体：`data-type="strong em text"`
- ✅ 高亮+备注：`data-type="text"` 嵌套在 `inline-memo` 中

## 如何向开发者反馈

如果遇到问题，请提供以下信息：

1. **完整的控制台日志**（从启动到出现问题）
2. **系统信息**：
   - 思源笔记版本
   - 操作系统（Windows/Mac/iOS/Android）
   - 使用的前端（电脑版/手机版/浏览器）
3. **复现步骤**
4. **预期行为 vs 实际行为**

## 下一步

现在你可以：

1. ✅ 重启思源笔记
2. ✅ 打开控制台（F12）
3. ✅ 选中一些文本
4. ✅ 观察控制台日志
5. ✅ 确认系统是否为只读模式
6. ✅ 验证弹窗是否出现

---

**更新日期**: 2025-10-01
**版本**: v1.1.0
**最新更新**: 添加高亮点击调试模式 (highlightDebug)

