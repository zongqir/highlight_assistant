# 只读模式检查调试指南

## 功能概述

本次更新添加了详细的只读模式检查和调试日志功能，帮助你了解弹窗在什么情况下出现。

## 新增功能

### 1. 系统只读模式检查
插件会自动检测思源笔记是否处于只读模式（阅读模式）

### 2. 详细的调试日志
在以下关键时刻会输出详细日志：
- 插件启动时
- 工具栏劫持时
- 选中文本触发工具栏时
- 显示备注弹窗时

## 如何查看调试日志

### 电脑版
1. 打开思源笔记
2. 按 `F12` 或 `Ctrl+Shift+I` 打开开发者工具
3. 切换到 `Console` (控制台) 标签
4. 查看带有以下前缀的日志：
   - `[ToolbarHijacker]` - 工具栏劫持相关
   - `[ReadonlyChecker]` - 只读模式检查相关
   - `[Plugin]` - 插件整体相关

### 手机版
1. 在手机浏览器中打开思源笔记
2. 使用远程调试工具（如 Chrome DevTools）
3. 查看控制台日志

## 日志示例

### 启动时的日志
```
[ToolbarHijacker] 🚀 ========== 启动工具栏劫持 ==========
[ToolbarHijacker] 环境: { isMobile: false, isDesktop: true }
[ToolbarHijacker] 🔐 检查系统只读状态...
[ReadonlyChecker] 🔐 检查系统只读模式...
[ReadonlyChecker] 🔒 系统为只读模式
[ReadonlyChecker] 系统配置: { readOnly: true, isPublish: false, start: true }
```

### 选中文本时的日志
```
[ToolbarHijacker] 🎯 ========== 工具栏 showContent 被触发 ==========
[ToolbarHijacker] 选中文本: 这是测试文本
[ReadonlyChecker] 🔐 检查系统只读模式...
[ReadonlyChecker] 🔒 系统为只读模式
[ToolbarHijacker] 当前系统状态: 🔒 只读模式（正常）
[ToolbarHijacker] ✨ 增强工具栏...
```

### 显示备注弹窗时的日志
```
[ToolbarHijacker] 💬 ========== 显示备注弹窗 ==========
[ReadonlyChecker] 🔐 检查系统只读模式...
[ReadonlyChecker] 🔒 系统为只读模式
[ToolbarHijacker] 📋 系统状态: 🔒 只读模式
[ToolbarHijacker] 🎨 准备显示备注输入对话框...
```

## 日志图标说明

- 🚀 - 启动/初始化
- 🔐 - 安全/权限检查
- 🔒 - 只读模式（已启用）
- ✏️ - 可写模式
- 📋 - 调用原生方法
- ✨ - 增强功能
- 💬 - 对话框/弹窗
- 📄 - 文档相关
- 📚 - 笔记本相关
- ✅ - 成功
- ❌ - 失败
- ⚠️ - 警告
- 🧪 - 测试/调试

## 重要发现

根据你的描述，**弹窗只在只读模式下出现**。从日志中你可以验证：

1. **检查系统状态**
   - 如果日志显示 `🔒 系统为只读模式` → 正常，应该出现弹窗
   - 如果日志显示 `✏️ 系统为可写模式` → 可能不出现弹窗

2. **检查工具栏增强**
   - 查找日志 `✨ 增强工具栏...`
   - 如果没有这条日志，说明增强失败

3. **检查备注弹窗触发**
   - 查找日志 `💬 ========== 显示备注弹窗 ==========`
   - 如果有这条日志，说明弹窗逻辑被触发

## 常见问题排查

### Q1: 弹窗没有出现
**排查步骤：**
1. 检查控制台是否有 `🔒 系统为只读模式` 日志
2. 检查是否有 `✨ 增强工具栏...` 日志
3. 检查是否有错误日志（红色）

### Q2: 如何切换只读模式
在思源笔记中：
- 电脑版：点击右上角的阅读模式图标
- 手机版：通常默认为只读模式

### Q3: 日志太多，如何过滤
在 Chrome 开发者工具的 Console 中：
1. 使用过滤器输入框
2. 输入 `[ToolbarHijacker]` 或 `[ReadonlyChecker]`
3. 只显示相关日志

## 全局调试函数

在控制台中输入 `testHijack()` 可以查看当前劫持状态：

```javascript
testHijack()
```

输出示例：
```
🧪 手动测试劫持状态...
- 劫持器存在: true
- 劫持状态: true
- 是否手机版: false
- 是否电脑版: true
- 编辑器数量: 1
- 编辑器0: { hasProtyle: true, hasToolbar: true, hasShowContent: true }
```

## 如何向开发者反馈

如果遇到问题，请提供以下信息：

1. **完整的控制台日志**（从启动到出现问题）
2. **系统信息**：
   - 思源笔记版本
   - 操作系统（Windows/Mac/iOS/Android）
   - 使用的前端（电脑版/手机版/浏览器）
3. **复现步骤**
4. **预期行为 vs 实际行为**

## 下一步

现在你可以：

1. ✅ 重启思源笔记
2. ✅ 打开控制台（F12）
3. ✅ 选中一些文本
4. ✅ 观察控制台日志
5. ✅ 确认系统是否为只读模式
6. ✅ 验证弹窗是否出现

---

**更新日期**: 2025-10-01
**版本**: v1.1.0

