<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>轮询测试</title>
    <style>
        body { 
            font-family: Arial; 
            padding: 20px; 
            font-size: 18px;
        }
        .test-area {
            background: #f5f5f5;
            padding: 30px;
            border-radius: 8px;
            margin: 20px 0;
            border: 2px solid #ccc;
        }
        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 2px solid #333;
            padding: 20px;
            border-radius: 8px;
            z-index: 10000;
            display: none;
        }
        .color-btn {
            width: 40px;
            height: 40px;
            margin: 5px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
        }
    </style>
</head>
<body>
    <h1>🔄 轮询测试（最暴力方法）</h1>
    <p><strong>这个方法每200ms检查一次选择状态，不依赖任何事件！</strong></p>
    
    <div class="test-area protyle-wysiwyg">
        <p>请在这里选择文本。我们会每200ms检查一次你是否选择了文本。</p>
        <p>这是最暴力的方法，如果这个都不行，说明是其他问题。</p>
        <p>如果弹出高亮工具，说明轮询方法有效！</p>
    </div>

    <div id="popup" class="popup">
        <div style="margin-bottom: 10px;"><strong>选择高亮颜色：</strong></div>
        <button class="color-btn" style="background: #fff3cd;" onclick="highlight('yellow')">🟡</button>
        <button class="color-btn" style="background: #d4edda;" onclick="highlight('green')">🟢</button>
        <button class="color-btn" style="background: #cce5ff;" onclick="highlight('blue')">🔵</button>
        <button class="color-btn" style="background: #fce4ec;" onclick="highlight('pink')">🩷</button>
        <button onclick="hidePopup()" style="margin-left: 10px; padding: 5px 10px;">关闭</button>
    </div>

    <div id="status" style="position: fixed; bottom: 10px; left: 10px; background: #000; color: #fff; padding: 10px; border-radius: 4px; font-size: 12px;">
        状态: 初始化...
    </div>

    <script>
        let lastSelection = '';
        let currentSelection = null;
        let checkCount = 0;
        
        function updateStatus(message) {
            document.getElementById('status').textContent = '检查次数: ' + checkCount + ' | ' + message;
        }
        
        // 轮询检查选择状态
        function checkSelection() {
            checkCount++;
            
            try {
                const selection = window.getSelection();
                const currentText = selection ? selection.toString().trim() : '';
                
                updateStatus('当前选择长度: ' + currentText.length);
                
                // 检查选择是否变化
                if (currentText && currentText !== lastSelection) {
                    lastSelection = currentText;
                    
                    // 检查是否在测试区域内
                    if (selection && selection.rangeCount > 0) {
                        const range = selection.getRangeAt(0);
                        const container = range.startContainer;
                        const element = container.nodeType === Node.TEXT_NODE ? 
                            container.parentElement : container;
                        
                        // 查找protyle-wysiwyg容器
                        let current = element;
                        let inEditor = false;
                        for (let i = 0; i < 10 && current; i++) {
                            if (current.classList && current.classList.contains('protyle-wysiwyg')) {
                                inEditor = true;
                                break;
                            }
                            current = current.parentElement;
                        }
                        
                        if (inEditor) {
                            alert('🎯 轮询检测到文本选择！\n文本: ' + currentText.substring(0, 50));
                            showPopup();
                            currentSelection = selection;
                            updateStatus('✅ 检测到选择: ' + currentText.substring(0, 20) + '...');
                        } else {
                            updateStatus('❌ 选择不在编辑器中');
                        }
                    }
                } else if (!currentText && lastSelection) {
                    // 选择被清除
                    lastSelection = '';
                    hidePopup();
                    updateStatus('🗑️ 选择已清除');
                }
                
            } catch (error) {
                updateStatus('❌ 错误: ' + error.message);
            }
        }
        
        function showPopup() {
            document.getElementById('popup').style.display = 'block';
        }
        
        function hidePopup() {
            document.getElementById('popup').style.display = 'none';
            currentSelection = null;
        }
        
        function highlight(color) {
            if (!currentSelection) {
                alert('❌ 没有选择内容');
                return;
            }
            
            try {
                const range = currentSelection.getRangeAt(0);
                const text = range.toString();
                
                // 创建高亮span
                const span = document.createElement('span');
                span.style.backgroundColor = getColorValue(color);
                span.style.borderRadius = '3px';
                span.style.padding = '2px 4px';
                span.style.margin = '0 1px';
                span.textContent = text;
                
                // 替换选择内容
                range.deleteContents();
                range.insertNode(span);
                
                // 清除选择
                currentSelection.removeAllRanges();
                
                alert('✅ 应用 ' + color + ' 高亮成功！\n文本: ' + text.substring(0, 30));
                hidePopup();
                
            } catch (error) {
                alert('❌ 高亮失败: ' + error.message);
            }
        }
        
        function getColorValue(color) {
            const colors = {
                yellow: '#fff3cd',
                green: '#d4edda', 
                blue: '#cce5ff',
                pink: '#fce4ec'
            };
            return colors[color] || '#fff3cd';
        }
        
        // 页面加载完成后开始轮询
        window.onload = function() {
            alert('🚀 轮询测试启动！\n\n每200ms检查一次选择状态\n请在上方文本区域选择内容测试');
            
            // 开始轮询
            setInterval(checkSelection, 200);
            updateStatus('轮询已启动');
        };
    </script>
</body>
</html>

