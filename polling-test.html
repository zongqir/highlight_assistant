<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è½®è¯¢æµ‹è¯•</title>
    <style>
        body { 
            font-family: Arial; 
            padding: 20px; 
            font-size: 18px;
        }
        .test-area {
            background: #f5f5f5;
            padding: 30px;
            border-radius: 8px;
            margin: 20px 0;
            border: 2px solid #ccc;
        }
        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 2px solid #333;
            padding: 20px;
            border-radius: 8px;
            z-index: 10000;
            display: none;
        }
        .color-btn {
            width: 40px;
            height: 40px;
            margin: 5px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”„ è½®è¯¢æµ‹è¯•ï¼ˆæœ€æš´åŠ›æ–¹æ³•ï¼‰</h1>
    <p><strong>è¿™ä¸ªæ–¹æ³•æ¯200msæ£€æŸ¥ä¸€æ¬¡é€‰æ‹©çŠ¶æ€ï¼Œä¸ä¾èµ–ä»»ä½•äº‹ä»¶ï¼</strong></p>
    
    <div class="test-area protyle-wysiwyg">
        <p>è¯·åœ¨è¿™é‡Œé€‰æ‹©æ–‡æœ¬ã€‚æˆ‘ä»¬ä¼šæ¯200msæ£€æŸ¥ä¸€æ¬¡ä½ æ˜¯å¦é€‰æ‹©äº†æ–‡æœ¬ã€‚</p>
        <p>è¿™æ˜¯æœ€æš´åŠ›çš„æ–¹æ³•ï¼Œå¦‚æœè¿™ä¸ªéƒ½ä¸è¡Œï¼Œè¯´æ˜æ˜¯å…¶ä»–é—®é¢˜ã€‚</p>
        <p>å¦‚æœå¼¹å‡ºé«˜äº®å·¥å…·ï¼Œè¯´æ˜è½®è¯¢æ–¹æ³•æœ‰æ•ˆï¼</p>
    </div>

    <div id="popup" class="popup">
        <div style="margin-bottom: 10px;"><strong>é€‰æ‹©é«˜äº®é¢œè‰²ï¼š</strong></div>
        <button class="color-btn" style="background: #fff3cd;" onclick="highlight('yellow')">ğŸŸ¡</button>
        <button class="color-btn" style="background: #d4edda;" onclick="highlight('green')">ğŸŸ¢</button>
        <button class="color-btn" style="background: #cce5ff;" onclick="highlight('blue')">ğŸ”µ</button>
        <button class="color-btn" style="background: #fce4ec;" onclick="highlight('pink')">ğŸ©·</button>
        <button onclick="hidePopup()" style="margin-left: 10px; padding: 5px 10px;">å…³é—­</button>
    </div>

    <div id="status" style="position: fixed; bottom: 10px; left: 10px; background: #000; color: #fff; padding: 10px; border-radius: 4px; font-size: 12px;">
        çŠ¶æ€: åˆå§‹åŒ–...
    </div>

    <script>
        let lastSelection = '';
        let currentSelection = null;
        let checkCount = 0;
        
        function updateStatus(message) {
            document.getElementById('status').textContent = 'æ£€æŸ¥æ¬¡æ•°: ' + checkCount + ' | ' + message;
        }
        
        // è½®è¯¢æ£€æŸ¥é€‰æ‹©çŠ¶æ€
        function checkSelection() {
            checkCount++;
            
            try {
                const selection = window.getSelection();
                const currentText = selection ? selection.toString().trim() : '';
                
                updateStatus('å½“å‰é€‰æ‹©é•¿åº¦: ' + currentText.length);
                
                // æ£€æŸ¥é€‰æ‹©æ˜¯å¦å˜åŒ–
                if (currentText && currentText !== lastSelection) {
                    lastSelection = currentText;
                    
                    // æ£€æŸ¥æ˜¯å¦åœ¨æµ‹è¯•åŒºåŸŸå†…
                    if (selection && selection.rangeCount > 0) {
                        const range = selection.getRangeAt(0);
                        const container = range.startContainer;
                        const element = container.nodeType === Node.TEXT_NODE ? 
                            container.parentElement : container;
                        
                        // æŸ¥æ‰¾protyle-wysiwygå®¹å™¨
                        let current = element;
                        let inEditor = false;
                        for (let i = 0; i < 10 && current; i++) {
                            if (current.classList && current.classList.contains('protyle-wysiwyg')) {
                                inEditor = true;
                                break;
                            }
                            current = current.parentElement;
                        }
                        
                        if (inEditor) {
                            alert('ğŸ¯ è½®è¯¢æ£€æµ‹åˆ°æ–‡æœ¬é€‰æ‹©ï¼\næ–‡æœ¬: ' + currentText.substring(0, 50));
                            showPopup();
                            currentSelection = selection;
                            updateStatus('âœ… æ£€æµ‹åˆ°é€‰æ‹©: ' + currentText.substring(0, 20) + '...');
                        } else {
                            updateStatus('âŒ é€‰æ‹©ä¸åœ¨ç¼–è¾‘å™¨ä¸­');
                        }
                    }
                } else if (!currentText && lastSelection) {
                    // é€‰æ‹©è¢«æ¸…é™¤
                    lastSelection = '';
                    hidePopup();
                    updateStatus('ğŸ—‘ï¸ é€‰æ‹©å·²æ¸…é™¤');
                }
                
            } catch (error) {
                updateStatus('âŒ é”™è¯¯: ' + error.message);
            }
        }
        
        function showPopup() {
            document.getElementById('popup').style.display = 'block';
        }
        
        function hidePopup() {
            document.getElementById('popup').style.display = 'none';
            currentSelection = null;
        }
        
        function highlight(color) {
            if (!currentSelection) {
                alert('âŒ æ²¡æœ‰é€‰æ‹©å†…å®¹');
                return;
            }
            
            try {
                const range = currentSelection.getRangeAt(0);
                const text = range.toString();
                
                // åˆ›å»ºé«˜äº®span
                const span = document.createElement('span');
                span.style.backgroundColor = getColorValue(color);
                span.style.borderRadius = '3px';
                span.style.padding = '2px 4px';
                span.style.margin = '0 1px';
                span.textContent = text;
                
                // æ›¿æ¢é€‰æ‹©å†…å®¹
                range.deleteContents();
                range.insertNode(span);
                
                // æ¸…é™¤é€‰æ‹©
                currentSelection.removeAllRanges();
                
                alert('âœ… åº”ç”¨ ' + color + ' é«˜äº®æˆåŠŸï¼\næ–‡æœ¬: ' + text.substring(0, 30));
                hidePopup();
                
            } catch (error) {
                alert('âŒ é«˜äº®å¤±è´¥: ' + error.message);
            }
        }
        
        function getColorValue(color) {
            const colors = {
                yellow: '#fff3cd',
                green: '#d4edda', 
                blue: '#cce5ff',
                pink: '#fce4ec'
            };
            return colors[color] || '#fff3cd';
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåå¼€å§‹è½®è¯¢
        window.onload = function() {
            alert('ğŸš€ è½®è¯¢æµ‹è¯•å¯åŠ¨ï¼\n\næ¯200msæ£€æŸ¥ä¸€æ¬¡é€‰æ‹©çŠ¶æ€\nè¯·åœ¨ä¸Šæ–¹æ–‡æœ¬åŒºåŸŸé€‰æ‹©å†…å®¹æµ‹è¯•');
            
            // å¼€å§‹è½®è¯¢
            setInterval(checkSelection, 200);
            updateStatus('è½®è¯¢å·²å¯åŠ¨');
        };
    </script>
</body>
</html>

