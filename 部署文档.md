# 🚀 高亮助手插件部署文档

## 📋 概述

本文档记录了高亮助手插件的正确部署流程，包括开发环境部署和生产环境部署两种方式。

## 🛠️ 开发环境部署（推荐）

### 前置条件

1. **Node.js 环境**：确保已安装 Node.js 和 pnpm
2. **思源笔记**：确保思源笔记正在运行
3. **项目目录**：确保在项目根目录下操作

### 部署步骤

#### 1. 创建符号链接

```bash
# 在项目根目录执行
pnpm run make-link
```

**执行结果示例：**
```
>>> Constant "targetDir" is empty, try to get SiYuan directory automatically....
>>> Got 2 SiYuan workspaces
        [0] C:\Users\Administrator\测试空间
        [1] C:\Users\Administrator\SiYuan
        Please select a workspace[0-1]: 0
>>> Successfully got target directory: C:\Users\Administrator\测试空间/data/plugins
Done! Created symlink C:\Users\Administrator\测试空间/data/plugins/highlight-assistant
```

#### 2. 启动开发服务器

```bash
# 启动开发服务器（支持热重载）
pnpm run dev
```

**执行结果示例：**
```
> plugin-sample-vite-svelte@0.4.1 dev C:\Users\Administrator\测试空间\data\plugins\highlight_assistant
> cross-env NODE_ENV=development VITE_SOURCEMAP=inline vite build --watch
isDev=> true
isSrcmap=> true
outputDir=> dev
vite v5.4.20 building for production...
watching for file changes...
build started...
🌈 Parse I18n: YAML to JSON..
transforming (1) src\index.ts
✓ 3 modules transformed.
rendering chunks (1)...
LiveReload enabled on port 35730
dev/index.css    6.51 kB │ gzip:  1.60 kB
dev/index.js   161.83 kB │ gzip: 43.26 kB │ map: 93.43 kB
[vite-plugin-static-copy] Copied 5 items.
built in 440ms.
```

### 验证部署

#### 1. 检查符号链接

```powershell
# 检查符号链接是否正确创建
Get-Item "C:\Users\Administrator\测试空间\data\plugins\highlight-assistant" | Select-Object LinkType, Target
```

**预期结果：**
```
LinkType     Target
--------     ------
SymbolicLink {C:\Users\Administrator\测试空间\data\plugins\highlight_assistant\dev}
```

#### 2. 检查文件结构

确保以下文件存在于思源插件目录：
```
C:\Users\Administrator\测试空间\data\plugins\highlight-assistant\
├── i18n/
│   ├── en_US.json
│   └── zh_CN.json
├── icon.png
├── index.css
├── index.js
├── plugin.json
├── preview.png
├── README_zh_CN.md
└── README.md
```

#### 3. 重启思源笔记

1. 完全关闭思源笔记
2. 重新打开思源笔记
3. 检查插件是否在插件列表中显示
4. 启用插件

## 🏭 生产环境部署

### 构建生产版本

```bash
# 构建生产版本
pnpm run build
```

**执行结果示例：**
```
> plugin-sample-vite-svelte@0.4.1 build C:\Users\Administrator\测试空间\data\plugins\highlight_assistant
> cross-env NODE_ENV=production vite build
isDev=> false
isSrcmap=> false
outputDir=> dist
vite v5.4.20 building for production...
transforming (1) src\index.ts
✓ 3 modules transformed.
dist/index.css   6.51 kB │ gzip: 1.60 kB
dist/index.js   28.96 kB │ gzip: 8.27 kB
[vite-plugin-static-copy] Copied 5 items.
Cleanup searching patterns: [ 'dist/i18n/*.yaml', 'dist/i18n/*.md' ]
Cleaned up: C:/Users/Administrator/测试空间/data/plugins/highlight_assistant/dist/i18n/README.md
✓ built in 399ms
Zip packing - "./dist" folder :
  - Preparing files.
  - Creating zip archive.
  - Done.
```

### 安装到本地思源

```bash
# 构建并安装到本地思源
pnpm run make-install
```

## 🔧 部署脚本说明

### make-link 脚本

- **功能**：创建符号链接，将思源插件目录链接到项目的 `dev/` 目录
- **优势**：代码修改后自动生效，支持热重载
- **适用场景**：开发调试

### make-install 脚本

- **功能**：构建生产版本并复制到思源插件目录
- **优势**：生成完整的发布包
- **适用场景**：测试发布版本

## 📁 目录结构说明

### 开发模式输出 (`dev/` 目录)

```
dev/
├── index.js          # 主程序 (包含源码映射)
├── index.css         # 样式文件
├── i18n/             # 国际化文件
│   ├── en_US.json
│   └── zh_CN.json
├── plugin.json       # 插件配置
├── README*.md        # 说明文档
├── icon.png          # 插件图标
└── preview.png       # 预览图
```

### 生产模式输出 (`dist/` 目录)

```
dist/
├── index.js          # 主程序 (压缩)
├── index.css         # 样式文件 (压缩)
├── i18n/             # 国际化文件
├── plugin.json       # 插件配置
├── README*.md        # 说明文档
├── icon.png          # 插件图标
├── preview.png       # 预览图
└── package.zip       # 发布包 (自动生成)
```

## ⚠️ 常见问题

### 1. 符号链接创建失败

**问题**：Windows权限不足
**解决方案**：
```bash
# 使用管理员权限运行
pnpm run make-link-win
```

### 2. 思源笔记无法检测到插件

**解决方案**：
1. 检查符号链接是否正确创建
2. 重启思源笔记
3. 检查插件目录权限

### 3. 开发服务器启动失败

**解决方案**：
1. 检查端口是否被占用
2. 确保Node.js版本兼容
3. 清理node_modules重新安装依赖

## 🚀 最佳实践

### 开发流程

1. **首次部署**：`pnpm run make-link`
2. **启动开发**：`pnpm run dev`
3. **修改代码**：自动热重载
4. **测试功能**：在思源中测试
5. **提交代码**：正常git操作

### 发布流程

1. **构建发布**：`pnpm run build`
2. **测试安装**：`pnpm run make-install`
3. **验证功能**：在思源中测试
4. **创建发布**：使用生成的 `package.zip`

## 📝 注意事项

1. **开发模式**：使用符号链接，修改代码后自动生效
2. **生产模式**：需要手动构建和安装
3. **思源重启**：部署后需要重启思源笔记才能生效
4. **权限问题**：Windows可能需要管理员权限创建符号链接
5. **端口冲突**：开发服务器使用35730端口，确保端口可用

---

*最后更新：2024年10月1日*
*版本：1.1.0*
