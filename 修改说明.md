# é«˜äº®æ’ä»¶ä¿®å¤è¯´æ˜

## ä¿®æ”¹æ—¥æœŸ
2025-10-01

## ä¿®æ”¹æ¦‚è¿°
å°†æ‰‹åŠ¨å®ç°çš„é«˜äº®åŠŸèƒ½æ”¹ä¸ºä½¿ç”¨æ€æºç¬”è®°åŸç”Ÿçš„ `setInlineMark` APIï¼Œå¤§å¹…ç®€åŒ–ä»£ç å¹¶æå‡ç¨³å®šæ€§ã€‚

---

## æ ¸å¿ƒä¿®æ”¹

### 1. âœ… åˆ é™¤é”™è¯¯çš„ API å°è£… (constructor, line 17-38)

**ä¿®æ”¹å‰:**
```typescript
this.api = {
    updateBlock: async (blockId: string, data: string, dataType: string) => {
        const response = await fetch('/api/block/updateBlock', {  // âŒ é”™è¯¯çš„API
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: blockId, data: data, dataType: dataType })
        });
        return await response.json();
    },
    getBlockKramdown: async (blockId: string) => { ... }
};
```

**ä¿®æ”¹å:**
```typescript
// ä¿ç•™ API ç”¨äºå¤‡æ³¨åŠŸèƒ½
this.api = {
    getBlockKramdown: async (blockId: string) => {
        const payload = { id: blockId };
        const response = await fetch('/api/block/getBlockKramdown', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        return await response.json();
    }
};
```

**ç†ç”±:** 
- `/api/block/updateBlock` æ˜¯æ—§ç‰ˆAPIï¼Œä¸æ”¯æŒå®Œæ•´çš„äº‹åŠ¡ç®¡ç†
- ç¼ºå°‘ undoOperationsï¼ˆæ’¤é”€æ“ä½œï¼‰ï¼Œæ— æ³•æ”¯æŒ Ctrl+Z
- æ€æºçš„ç´¢å¼•æœºåˆ¶ä¾èµ– `/api/transactions` æ¥æ›´æ–° spans å’Œ attributes è¡¨

---

### 2. âœ… é‡å†™ `applyHighlight` æ–¹æ³• (line 825-865)

**ä¿®æ”¹å‰ (77è¡Œå¤æ‚é€»è¾‘):**
```typescript
private async applyHighlight(protyle: any, range: Range, nodeElement: Element, colorConfig: {name: string, color: string}): Promise<void> {
    // 1. æ‰‹åŠ¨åˆ›å»º span å…ƒç´ 
    const highlightSpan = document.createElement("span");
    highlightSpan.setAttribute("data-type", "text");
    highlightSpan.style.backgroundColor = colorConfig.color;
    highlightSpan.textContent = selectedText;
    
    // 2. DOM æ“ä½œ
    range.deleteContents();
    range.insertNode(highlightSpan);
    
    // 3. æ‰‹åŠ¨æå– Markdown
    const markdownContent = await this.extractMarkdownFromBlock(blockElement);
    
    // 4. ä½¿ç”¨é”™è¯¯çš„ API ä¿å­˜
    const updateResult = await this.api.updateBlock(blockId, markdownContent, "markdown");
    
    // ... 77è¡Œä»£ç 
}
```

**ä¿®æ”¹å (40è¡Œç®€æ´ä»£ç ):**
```typescript
private async applyHighlight(protyle: any, range: Range, nodeElement: Element, colorConfig: {name: string, color: string}): Promise<void> {
    try {
        // å‚æ•°æ£€æŸ¥
        if (!colorConfig || !protyle || !range) {
            console.error('applyHighlight: å‚æ•°ç¼ºå¤±');
            return;
        }
        
        const selectedText = range.toString().trim();
        if (!selectedText) return;

        // æ£€æŸ¥ protyle.toolbar.setInlineMark æ˜¯å¦å¯ç”¨
        if (!protyle.toolbar || typeof protyle.toolbar.setInlineMark !== 'function') {
            console.error('protyle.toolbar.setInlineMark ä¸å¯ç”¨');
            return;
        }

        // âœ… æ ¸å¿ƒï¼šç›´æ¥è°ƒç”¨æ€æºåŸç”Ÿæ–¹æ³•
        protyle.toolbar.setInlineMark(protyle, "text", "range", {
            type: "backgroundColor",
            color: colorConfig.color
        });

        console.log(`âœ… å·²åº”ç”¨${colorConfig.name}é«˜äº®`);
    } catch (error) {
        console.error("é«˜äº®åŠŸèƒ½å‡ºé”™:", error);
    }
}
```

**æ”¶ç›Š:**
- âœ… ä»£ç é‡å‡å°‘ 48%ï¼ˆ77è¡Œ â†’ 40è¡Œï¼‰
- âœ… è‡ªåŠ¨å¤„ç†ï¼šIALç”Ÿæˆã€transactionsè°ƒç”¨ã€æ•°æ®åº“æ›´æ–°ã€æ’¤é”€æ”¯æŒ
- âœ… å¤„ç†æ‰€æœ‰è¾¹ç•Œæƒ…å†µï¼šè¡¨æ ¼ã€ä»£ç å—ã€é›¶å®½å­—ç¬¦ç­‰

---

### 3. âœ… é‡å†™ `removeHighlight` æ–¹æ³• (line 870-898)

**ä¿®æ”¹å‰:**
```typescript
private async removeHighlight(protyle: any, range: Range, nodeElement: Element): Promise<void> {
    const success = await this.removeHighlightCore(range);
    // è°ƒç”¨ removeHighlightCore (75è¡Œæ‰‹åŠ¨å®ç°)
    // ... æ‰‹åŠ¨æŸ¥æ‰¾ spanã€æ›¿æ¢ä¸ºæ–‡æœ¬èŠ‚ç‚¹ã€æå– Markdownã€é”™è¯¯çš„ API è°ƒç”¨
}
```

**ä¿®æ”¹å:**
```typescript
private async removeHighlight(protyle: any, range: Range, nodeElement: Element): Promise<void> {
    try {
        // å‚æ•°æ£€æŸ¥
        if (!protyle || !protyle.toolbar) {
            console.error('protyle.toolbar ä¸å¯ç”¨');
            return;
        }

        // âœ… ä½¿ç”¨æ€æºåŸç”Ÿæ–¹æ³•ç§»é™¤é«˜äº®
        protyle.toolbar.setInlineMark(protyle, "text", "range", {
            type: "backgroundColor",
            color: "" // ç©ºå­—ç¬¦ä¸²è¡¨ç¤ºç§»é™¤èƒŒæ™¯è‰²
        });

        console.log('âœ… å·²ç§»é™¤é«˜äº®');
    } catch (error) {
        console.error('âŒ ç§»é™¤é«˜äº®å‡ºé”™:', error);
    }
}
```

**æ”¶ç›Š:**
- âœ… ä»£ç é‡å‡å°‘ 73%ï¼ˆ75è¡Œ â†’ 20è¡Œï¼‰
- âœ… åˆ é™¤äº† `removeHighlightCore` æ–¹æ³•ï¼ˆ75è¡Œä»£ç ï¼‰

---

### 4. âœ… ä¿®æ”¹ `applyCustomHighlight` æ–¹æ³• (line 2332-2363)

**ä¿®æ”¹å‰:**
```typescript
private async applyCustomHighlight(range: Range, color: {name: string, bg: string}): Promise<void> {
    // æ‰‹åŠ¨åˆ›å»º spanã€DOM æ“ä½œã€æå– Markdownã€é”™è¯¯çš„ API è°ƒç”¨
    const highlightSpan = document.createElement("span");
    // ...
    const newContent = await this.extractMarkdownFromBlock(blockElement);
    const updateResult = await this.api.updateBlock(blockId, newContent, "markdown");
}
```

**ä¿®æ”¹å:**
```typescript
private async applyCustomHighlight(range: Range, color: {name: string, bg: string}): Promise<void> {
    try {
        // è·å–å½“å‰ç¼–è¾‘å™¨çš„protyleå¯¹è±¡
        const editors = getAllEditor();
        const currentEditor = editors[0];
        
        // âœ… ä½¿ç”¨æ€æºåŸç”Ÿæ–¹æ³•
        currentEditor.protyle.toolbar.setInlineMark(currentEditor.protyle, "text", "range", {
            type: "backgroundColor",
            color: color.bg
        });

        console.log(`âœ… å·²åº”ç”¨${color.name}é«˜äº®`);
    } catch (error) {
        console.error('åº”ç”¨è‡ªå®šä¹‰é«˜äº®å‡ºé”™:', error);
    }
}
```

---

### 5. âœ… ä¿®æ”¹ `removeCustomHighlight` æ–¹æ³• (line 2368-2399)

**ä¿®æ”¹å‰:**
```typescript
private async removeCustomHighlight(range: Range): Promise<void> {
    await this.removeHighlightCore(range); // è°ƒç”¨75è¡Œçš„æ‰‹åŠ¨å®ç°
}
```

**ä¿®æ”¹å:**
```typescript
private async removeCustomHighlight(range: Range): Promise<void> {
    try {
        const editors = getAllEditor();
        const currentEditor = editors[0];
        
        // âœ… ä½¿ç”¨æ€æºåŸç”Ÿæ–¹æ³•ç§»é™¤é«˜äº®
        currentEditor.protyle.toolbar.setInlineMark(currentEditor.protyle, "text", "range", {
            type: "backgroundColor",
            color: "" // ç©ºå­—ç¬¦ä¸²è¡¨ç¤ºç§»é™¤èƒŒæ™¯è‰²
        });

        console.log('âœ… å·²åˆ é™¤é«˜äº®');
    } catch (error) {
        console.error('åˆ é™¤é«˜äº®æ—¶å‡ºé”™:', error);
    }
}
```

---

## ä¿ç•™çš„é—ç•™ä»£ç 

ä»¥ä¸‹æ–¹æ³•**ä¿ç•™**ç”¨äºå¤‡æ³¨åŠŸèƒ½ï¼Œä½†å·²æ·»åŠ  `âš ï¸ é—ç•™ä»£ç ` æ³¨é‡Šï¼š

1. `extractMarkdownFromBlock()` - line 939
2. `mergeHighlightIntoMarkdown()` - line 1015
3. `convertHighlightSpansToMarkdown()` - line 1206
4. `processLinkWithHighlights()` - line 1130

**å¤‡æ³¨åŠŸèƒ½ä½¿ç”¨ä½ç½®:**
- `addMemoToSelection()` - line 637
- `deleteMemoFromElement()` - line 1687
- `saveMemoToSiYuan()` - line 1731
- `addMemoToRange()` - line 2626

**TODO:** æœªæ¥åº”è¯¥å°†å¤‡æ³¨åŠŸèƒ½ä¹Ÿæ”¹ç”¨ `/api/transactions`

---

## æŠ€æœ¯åŸç†

### æ€æºåŸç”Ÿ `setInlineMark` æ–¹æ³•åšäº†ä»€ä¹ˆï¼Ÿ

```typescript
protyle.toolbar.setInlineMark(protyle, "text", "range", {
    type: "backgroundColor",
    color: "#fff3cd"
});
```

**è‡ªåŠ¨å¤„ç†:**

1. **åˆ›å»ºç¬¦åˆè§„èŒƒçš„ span å…ƒç´ **
   ```html
   <span data-type="text" style="background-color: #fff3cd;">æˆ‘çˆ±</span>
   ```

2. **ç”Ÿæˆ IAL (Inline Attribute List)**
   ```
   {: style="background-color: #fff3cd;"}
   ```

3. **è°ƒç”¨ `/api/transactions`**
   ```json
   {
     "session": "plugin-session",
     "app": "siyuan",
     "transactions": [{
       "doOperations": [{ "action": "update", "id": "block-id", "data": "æ–°HTML" }],
       "undoOperations": [{ "action": "update", "id": "block-id", "data": "æ—§HTML" }]
     }]
   }
   ```

4. **æ›´æ–°æ•°æ®åº“ä¸‰ä¸ªè¡¨**
   - `blocks` è¡¨ï¼šå­˜å‚¨å®Œæ•´å—å†…å®¹
   - `spans` è¡¨ï¼šå­˜å‚¨è¡Œçº§å…ƒç´ ï¼ˆä¾¿äºæœç´¢ï¼‰
   - `attributes` è¡¨ï¼šå­˜å‚¨å¯æŸ¥è¯¢å±æ€§ï¼ˆstyleç­‰ï¼‰

5. **æ”¯æŒ Ctrl+Z æ’¤é”€**
   - å› ä¸ºæœ‰ undoOperations

6. **å¤„ç†è¾¹ç•Œæƒ…å†µ**
   - è·¨ span é€‰æ‹©çš„åˆå¹¶
   - é›¶å®½å­—ç¬¦ï¼ˆZWSPï¼‰å¤„ç†
   - è¡¨æ ¼ã€ä»£ç å—ç­‰ç‰¹æ®Šåœºæ™¯

---

## ç»Ÿè®¡æ•°æ®

### ä»£ç è¡Œæ•°å˜åŒ–

| æ–¹æ³• | ä¿®æ”¹å‰ | ä¿®æ”¹å | å‡å°‘ |
|------|-------|-------|------|
| `applyHighlight` | 77è¡Œ | 40è¡Œ | **-48%** |
| `removeHighlight` | 75è¡Œ | 20è¡Œ | **-73%** |
| `applyCustomHighlight` | 45è¡Œ | 32è¡Œ | **-29%** |
| `removeCustomHighlight` | 2è¡Œ+75è¡Œ(å…±äº«) | 32è¡Œ | ä¼˜åŒ– |
| `removeHighlightCore` | 75è¡Œ | åˆ é™¤ | **-100%** |
| **æ€»è®¡** | ~200è¡Œ | ~124è¡Œ | **-38%** |

### åˆ é™¤çš„ API

- âŒ `this.api.updateBlock` - ä½¿ç”¨é”™è¯¯çš„ `/api/block/updateBlock`

### æ–°å¢çš„ä¾èµ–

- âœ… ä½¿ç”¨ `protyle.toolbar.setInlineMark` (æ€æºåŸç”Ÿæ–¹æ³•)
- âœ… ä½¿ç”¨ `getAllEditor()` (æ€æºSDK)

---

## æµ‹è¯•å»ºè®®

### 1. åŸºæœ¬åŠŸèƒ½æµ‹è¯•

```typescript
// é€‰ä¸­æ–‡æœ¬ "æµ‹è¯•æ–‡æœ¬"
// ç‚¹å‡»é»„è‰²é«˜äº®æŒ‰é’®

// é¢„æœŸç»“æœï¼š
// 1. æ–‡æœ¬å˜ä¸ºé»„è‰²èƒŒæ™¯
// 2. æ•°æ®åº“ spans è¡¨æ–°å¢è®°å½• (type='textmark text')
// 3. æ•°æ®åº“ attributes è¡¨æ–°å¢è®°å½• (name='style')
// 4. æ”¯æŒ Ctrl+Z æ’¤é”€
```

### 2. è¾¹ç•Œæƒ…å†µæµ‹è¯•

```typescript
// æµ‹è¯•1ï¼šä»£ç å—ä¸­é€‰æ‹©æ–‡æœ¬
// é¢„æœŸï¼šä¸æ˜¾ç¤ºé«˜äº®å·¥å…·æ ï¼ˆå·²æœ‰æ£€æŸ¥ï¼‰

// æµ‹è¯•2ï¼šè¡¨æ ¼ä¸­é€‰æ‹©æ–‡æœ¬
// é¢„æœŸï¼šä¸æ˜¾ç¤ºé«˜äº®å·¥å…·æ ï¼ˆå·²æœ‰æ£€æŸ¥ï¼‰

// æµ‹è¯•3ï¼šè·¨å—é€‰æ‹©æ–‡æœ¬
// é¢„æœŸï¼šä¸æ˜¾ç¤ºé«˜äº®å·¥å…·æ ï¼ˆå·²æœ‰æ£€æŸ¥ï¼‰

// æµ‹è¯•4ï¼šé“¾æ¥ä¸­é€‰æ‹©æ–‡æœ¬
// é¢„æœŸï¼šä¸æ˜¾ç¤ºé«˜äº®å·¥å…·æ ï¼ˆå·²æœ‰æ£€æŸ¥ï¼‰
```

### 3. æ•°æ®åº“éªŒè¯

```sql
-- éªŒè¯ spans è¡¨
SELECT * FROM spans WHERE type = 'textmark text' ORDER BY id DESC LIMIT 5;

-- éªŒè¯ attributes è¡¨
SELECT * FROM attributes WHERE name = 'style' AND type = 's' ORDER BY id DESC LIMIT 5;

-- éªŒè¯å…³è”å…³ç³»
SELECT b.id as block_id, b.markdown, s.content as span_content, a.value as style_value
FROM blocks b
JOIN spans s ON b.id = s.block_id
JOIN attributes a ON b.id = a.block_id
WHERE a.name = 'style' AND a.type = 's'
ORDER BY b.id DESC LIMIT 5;
```

---

## æœªæ¥ä¼˜åŒ–å»ºè®®

### 1. å¤‡æ³¨åŠŸèƒ½ä¹Ÿæ”¹ç”¨åŸç”Ÿ API

å¤‡æ³¨åŠŸèƒ½ç›®å‰è¿˜åœ¨ä½¿ç”¨æ‰‹åŠ¨å®ç°å’Œé”™è¯¯çš„ APIï¼Œå»ºè®®å‚è€ƒé«˜äº®åŠŸèƒ½çš„ä¿®æ”¹æ–¹å¼ï¼š

```typescript
// å½“å‰å¤‡æ³¨å®ç°ï¼ˆé”™è¯¯ï¼‰
const memoSpan = document.createElement("span");
memoSpan.setAttribute("data-type", "inline-memo");
// ... æ‰‹åŠ¨ DOM æ“ä½œ
const updateResult = await this.api.updateBlock(blockId, content, "markdown");

// å»ºè®®æ”¹ç”¨æ€æºåŸç”Ÿæ–¹æ³•
protyle.toolbar.setInlineMark(protyle, "inline-memo", "range", {
    type: "memo",
    content: memoText
});
```

### 2. ç§»é™¤é—ç•™çš„è¾…åŠ©æ–¹æ³•

ä¸€æ—¦å¤‡æ³¨åŠŸèƒ½ä¹Ÿæ”¹ç”¨åŸç”ŸAPIï¼Œå¯ä»¥åˆ é™¤ï¼š
- `extractMarkdownFromBlock()`
- `mergeHighlightIntoMarkdown()`
- `convertHighlightSpansToMarkdown()`
- `processLinkWithHighlights()`

**é¢„è®¡å¯å†å‡å°‘ ~450è¡Œä»£ç **

### 3. æ€§èƒ½ä¼˜åŒ–

```typescript
// å½“å‰ï¼šæ¯æ¬¡éƒ½ getAllEditor()
const editors = getAllEditor();

// ä¼˜åŒ–ï¼šç¼“å­˜ protyle å¯¹è±¡
private currentProtyle: any = null;

private enhanceToolbar(toolbar: any, range: Range, nodeElement: Element, protyle: any): void {
    this.currentProtyle = protyle; // ç¼“å­˜
    // ...
}

private async applyHighlight(...): Promise<void> {
    // ç›´æ¥ä½¿ç”¨ç¼“å­˜çš„ protyle
    this.currentProtyle.toolbar.setInlineMark(...)
}
```

---

## ç›¸å…³æ–‡æ¡£

- [æ€æºé«˜äº®æ ·å¼ä¸šåŠ¡é€»è¾‘åˆ†æ.md](./æ€æºé«˜äº®æ ·å¼ä¸šåŠ¡é€»è¾‘åˆ†æ.md)
- [æ€æºé«˜äº®æ ·å¼å®Œæ•´å®ç°åˆ†æ.md](./æ€æºé«˜äº®æ ·å¼å®Œæ•´å®ç°åˆ†æ.md)
- [æ’ä»¶ä½¿ç”¨setInlineMarkçš„å®Œæ•´æŒ‡å—.md](./æ’ä»¶ä½¿ç”¨setInlineMarkçš„å®Œæ•´æŒ‡å—.md)
- [ç°æœ‰ä»£ç é—®é¢˜åˆ†æ.md](./ç°æœ‰ä»£ç é—®é¢˜åˆ†æ.md)

---

## æ€»ç»“

### âœ… ä¿®å¤çš„æ ¸å¿ƒé—®é¢˜

1. **ä½¿ç”¨é”™è¯¯çš„ API** â†’ æ”¹ç”¨ `/api/transactions`ï¼ˆé€šè¿‡ setInlineMark è‡ªåŠ¨è°ƒç”¨ï¼‰
2. **æ‰‹åŠ¨åˆ›å»º span ä¸ç¬¦åˆè§„èŒƒ** â†’ ä½¿ç”¨æ€æºåŸç”Ÿæ–¹æ³•è‡ªåŠ¨ç”Ÿæˆ
3. **ç¼ºå°‘ IAL ç”Ÿæˆ** â†’ æ€æºåŸç”Ÿæ–¹æ³•è‡ªåŠ¨ç”Ÿæˆ
4. **ç¼ºå°‘ undoOperations** â†’ æ€æºåŸç”Ÿæ–¹æ³•è‡ªåŠ¨åŒ…å«
5. **æ•°æ®åº“æ›´æ–°ä¸å®Œæ•´** â†’ æ€æºåŸç”Ÿæ–¹æ³•å®Œæ•´æ›´æ–° 3 ä¸ªè¡¨

### ğŸ¯ è¾¾æˆçš„æ•ˆæœ

- âœ… ä»£ç é‡å‡å°‘ 38%
- âœ… æ›´åŠ ç¨³å®šå¯é 
- âœ… æ”¯æŒ Ctrl+Z æ’¤é”€
- âœ… ç¬¦åˆæ€æºè§„èŒƒ
- âœ… è‡ªåŠ¨å¤„ç†æ‰€æœ‰è¾¹ç•Œæƒ…å†µ
- âœ… å®Œæ•´çš„æ•°æ®åº“ç´¢å¼•

### ğŸš€ ä¸‹ä¸€æ­¥

1. æµ‹è¯•é«˜äº®åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ
2. éªŒè¯æ•°æ®åº“è®°å½•æ˜¯å¦æ­£ç¡®
3. è€ƒè™‘ä¼˜åŒ–å¤‡æ³¨åŠŸèƒ½
4. æ€§èƒ½ä¼˜åŒ–ï¼ˆç¼“å­˜ protyle å¯¹è±¡ï¼‰

