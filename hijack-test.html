<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工具栏劫持测试</title>
    <style>
        body { 
            font-family: Arial; 
            padding: 20px; 
            line-height: 1.6;
        }
        .test-area {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            user-select: text;
        }
        .toolbar-mock {
            position: fixed;
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            z-index: 1000;
        }
        .fn__flex {
            display: flex;
            gap: 4px;
        }
        .keyboard__action {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: #f9f9f9;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .keyboard__action:hover {
            background: #e9e9e9;
        }
        .keyboard__split {
            width: 1px;
            background: #ddd;
            margin: 0 4px;
        }
    </style>
</head>
<body>
    <h1>🔧 工具栏劫持测试</h1>
    <p>这个页面模拟思源的工具栏劫持机制</p>
    
    <div class="test-area">
        <p>这是测试内容。请选择这段文字来触发工具栏。</p>
        <p>工具栏劫持器会在原有的复制按钮基础上添加高亮按钮。</p>
        <p>选择任何文字都会触发模拟的工具栏显示。</p>
    </div>

    <div id="toolbar" class="toolbar-mock">
        <div class="fn__flex">
            <button class="keyboard__action" data-action="copy">
                📋 复制
            </button>
            <div class="keyboard__split"></div>
            <!-- 高亮按钮会被动态添加到这里 -->
            <button class="keyboard__action" data-action="more">
                ⋯ 更多
            </button>
        </div>
    </div>

    <div id="log" style="margin-top: 20px; padding: 10px; background: #f9f9f9; border-radius: 4px; font-family: monospace; font-size: 12px;">
        <strong>日志:</strong><br>
    </div>

    <script>
        let currentRange = null;
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `${time}: ${message}<br>`;
            console.log(message);
        }
        
        // 模拟思源的工具栏劫持
        class MockToolbarHijacker {
            constructor() {
                this.setupSelectionListener();
                log('🔧 模拟工具栏劫击器已启动');
            }
            
            setupSelectionListener() {
                document.addEventListener('mouseup', () => {
                    setTimeout(() => this.checkSelection(), 100);
                });
                
                document.addEventListener('touchend', () => {
                    setTimeout(() => this.checkSelection(), 100);
                });
            }
            
            checkSelection() {
                const selection = window.getSelection();
                const text = selection ? selection.toString().trim() : '';
                
                if (text && selection.rangeCount > 0) {
                    currentRange = selection.getRangeAt(0);
                    this.showToolbar(currentRange);
                    log(`📝 检测到选择: "${text.substring(0, 20)}..."`);
                } else {
                    this.hideToolbar();
                }
            }
            
            showToolbar(range) {
                const toolbar = document.getElementById('toolbar');
                const rect = range.getBoundingClientRect();
                
                // 定位工具栏
                toolbar.style.left = Math.max(10, rect.left) + 'px';
                toolbar.style.top = (rect.bottom + 10) + 'px';
                toolbar.style.display = 'block';
                
                // 劫持工具栏：添加高亮按钮
                this.hijackToolbar(toolbar, range);
                
                log('🛠️ 工具栏已显示并劫持');
            }
            
            hideToolbar() {
                const toolbar = document.getElementById('toolbar');
                toolbar.style.display = 'none';
                
                // 清理之前添加的高亮按钮
                const highlightBtns = toolbar.querySelectorAll('.highlight-btn');
                highlightBtns.forEach(btn => btn.remove());
                
                const separators = toolbar.querySelectorAll('.added-separator');
                separators.forEach(sep => sep.remove());
            }
            
            hijackToolbar(toolbar, range) {
                const container = toolbar.querySelector('.fn__flex');
                const moreBtn = container.querySelector('[data-action="more"]');
                
                // 检查是否已经添加过高亮按钮
                if (container.querySelector('.highlight-btn')) {
                    return;
                }
                
                // 添加分隔符
                const separator = document.createElement('div');
                separator.className = 'keyboard__split added-separator';
                container.insertBefore(separator, moreBtn);
                
                // 添加高亮按钮
                const colors = [
                    { name: 'yellow', icon: '🟡', bg: '#fff3cd' },
                    { name: 'green', icon: '🟢', bg: '#d4edda' },
                    { name: 'blue', icon: '🔵', bg: '#cce5ff' },
                    { name: 'pink', icon: '🩷', bg: '#fce4ec' }
                ];
                
                colors.forEach(color => {
                    const btn = this.createHighlightButton(color, range);
                    container.insertBefore(btn, moreBtn);
                });
                
                log(`✨ 已添加 ${colors.length} 个高亮按钮`);
            }
            
            createHighlightButton(color, range) {
                const btn = document.createElement('button');
                btn.className = 'keyboard__action highlight-btn';
                btn.innerHTML = color.icon;
                btn.style.backgroundColor = color.bg;
                btn.style.minWidth = '32px';
                btn.style.minHeight = '32px';
                btn.title = `${color.name} 高亮`;
                
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.applyHighlight(color, range);
                });
                
                return btn;
            }
            
            applyHighlight(color, range) {
                const selectedText = range.toString();
                
                // 创建高亮span
                const span = document.createElement('span');
                span.style.backgroundColor = color.bg;
                span.style.borderRadius = '2px';
                span.style.padding = '1px 2px';
                span.textContent = selectedText;
                
                // 替换选中内容
                range.deleteContents();
                range.insertNode(span);
                
                // 清除选择
                window.getSelection().removeAllRanges();
                
                // 隐藏工具栏
                this.hideToolbar();
                
                log(`🎨 应用 ${color.name} 高亮: "${selectedText.substring(0, 20)}..."`);
            }
        }
        
        // 启动模拟器
        window.onload = function() {
            new MockToolbarHijacker();
            log('📱 页面加载完成，请选择文本测试');
        };
        
        // 全局测试函数
        window.testHijack = function() {
            log('🧪 手动测试工具栏劫持...');
            
            // 模拟选择
            const testArea = document.querySelector('.test-area p');
            const range = document.createRange();
            range.selectNodeContents(testArea);
            
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            
            // 触发检查
            setTimeout(() => {
                const hijacker = new MockToolbarHijacker();
                hijacker.checkSelection();
            }, 100);
        };
    </script>
</body>
</html>
