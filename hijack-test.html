<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥å…·æ åŠ«æŒæµ‹è¯•</title>
    <style>
        body { 
            font-family: Arial; 
            padding: 20px; 
            line-height: 1.6;
        }
        .test-area {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            user-select: text;
        }
        .toolbar-mock {
            position: fixed;
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            z-index: 1000;
        }
        .fn__flex {
            display: flex;
            gap: 4px;
        }
        .keyboard__action {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: #f9f9f9;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .keyboard__action:hover {
            background: #e9e9e9;
        }
        .keyboard__split {
            width: 1px;
            background: #ddd;
            margin: 0 4px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ å·¥å…·æ åŠ«æŒæµ‹è¯•</h1>
    <p>è¿™ä¸ªé¡µé¢æ¨¡æ‹Ÿæ€æºçš„å·¥å…·æ åŠ«æŒæœºåˆ¶</p>
    
    <div class="test-area">
        <p>è¿™æ˜¯æµ‹è¯•å†…å®¹ã€‚è¯·é€‰æ‹©è¿™æ®µæ–‡å­—æ¥è§¦å‘å·¥å…·æ ã€‚</p>
        <p>å·¥å…·æ åŠ«æŒå™¨ä¼šåœ¨åŸæœ‰çš„å¤åˆ¶æŒ‰é’®åŸºç¡€ä¸Šæ·»åŠ é«˜äº®æŒ‰é’®ã€‚</p>
        <p>é€‰æ‹©ä»»ä½•æ–‡å­—éƒ½ä¼šè§¦å‘æ¨¡æ‹Ÿçš„å·¥å…·æ æ˜¾ç¤ºã€‚</p>
    </div>

    <div id="toolbar" class="toolbar-mock">
        <div class="fn__flex">
            <button class="keyboard__action" data-action="copy">
                ğŸ“‹ å¤åˆ¶
            </button>
            <div class="keyboard__split"></div>
            <!-- é«˜äº®æŒ‰é’®ä¼šè¢«åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
            <button class="keyboard__action" data-action="more">
                â‹¯ æ›´å¤š
            </button>
        </div>
    </div>

    <div id="log" style="margin-top: 20px; padding: 10px; background: #f9f9f9; border-radius: 4px; font-family: monospace; font-size: 12px;">
        <strong>æ—¥å¿—:</strong><br>
    </div>

    <script>
        let currentRange = null;
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `${time}: ${message}<br>`;
            console.log(message);
        }
        
        // æ¨¡æ‹Ÿæ€æºçš„å·¥å…·æ åŠ«æŒ
        class MockToolbarHijacker {
            constructor() {
                this.setupSelectionListener();
                log('ğŸ”§ æ¨¡æ‹Ÿå·¥å…·æ åŠ«å‡»å™¨å·²å¯åŠ¨');
            }
            
            setupSelectionListener() {
                document.addEventListener('mouseup', () => {
                    setTimeout(() => this.checkSelection(), 100);
                });
                
                document.addEventListener('touchend', () => {
                    setTimeout(() => this.checkSelection(), 100);
                });
            }
            
            checkSelection() {
                const selection = window.getSelection();
                const text = selection ? selection.toString().trim() : '';
                
                if (text && selection.rangeCount > 0) {
                    currentRange = selection.getRangeAt(0);
                    this.showToolbar(currentRange);
                    log(`ğŸ“ æ£€æµ‹åˆ°é€‰æ‹©: "${text.substring(0, 20)}..."`);
                } else {
                    this.hideToolbar();
                }
            }
            
            showToolbar(range) {
                const toolbar = document.getElementById('toolbar');
                const rect = range.getBoundingClientRect();
                
                // å®šä½å·¥å…·æ 
                toolbar.style.left = Math.max(10, rect.left) + 'px';
                toolbar.style.top = (rect.bottom + 10) + 'px';
                toolbar.style.display = 'block';
                
                // åŠ«æŒå·¥å…·æ ï¼šæ·»åŠ é«˜äº®æŒ‰é’®
                this.hijackToolbar(toolbar, range);
                
                log('ğŸ› ï¸ å·¥å…·æ å·²æ˜¾ç¤ºå¹¶åŠ«æŒ');
            }
            
            hideToolbar() {
                const toolbar = document.getElementById('toolbar');
                toolbar.style.display = 'none';
                
                // æ¸…ç†ä¹‹å‰æ·»åŠ çš„é«˜äº®æŒ‰é’®
                const highlightBtns = toolbar.querySelectorAll('.highlight-btn');
                highlightBtns.forEach(btn => btn.remove());
                
                const separators = toolbar.querySelectorAll('.added-separator');
                separators.forEach(sep => sep.remove());
            }
            
            hijackToolbar(toolbar, range) {
                const container = toolbar.querySelector('.fn__flex');
                const moreBtn = container.querySelector('[data-action="more"]');
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ è¿‡é«˜äº®æŒ‰é’®
                if (container.querySelector('.highlight-btn')) {
                    return;
                }
                
                // æ·»åŠ åˆ†éš”ç¬¦
                const separator = document.createElement('div');
                separator.className = 'keyboard__split added-separator';
                container.insertBefore(separator, moreBtn);
                
                // æ·»åŠ é«˜äº®æŒ‰é’®
                const colors = [
                    { name: 'yellow', icon: 'ğŸŸ¡', bg: '#fff3cd' },
                    { name: 'green', icon: 'ğŸŸ¢', bg: '#d4edda' },
                    { name: 'blue', icon: 'ğŸ”µ', bg: '#cce5ff' },
                    { name: 'pink', icon: 'ğŸ©·', bg: '#fce4ec' }
                ];
                
                colors.forEach(color => {
                    const btn = this.createHighlightButton(color, range);
                    container.insertBefore(btn, moreBtn);
                });
                
                log(`âœ¨ å·²æ·»åŠ  ${colors.length} ä¸ªé«˜äº®æŒ‰é’®`);
            }
            
            createHighlightButton(color, range) {
                const btn = document.createElement('button');
                btn.className = 'keyboard__action highlight-btn';
                btn.innerHTML = color.icon;
                btn.style.backgroundColor = color.bg;
                btn.style.minWidth = '32px';
                btn.style.minHeight = '32px';
                btn.title = `${color.name} é«˜äº®`;
                
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.applyHighlight(color, range);
                });
                
                return btn;
            }
            
            applyHighlight(color, range) {
                const selectedText = range.toString();
                
                // åˆ›å»ºé«˜äº®span
                const span = document.createElement('span');
                span.style.backgroundColor = color.bg;
                span.style.borderRadius = '2px';
                span.style.padding = '1px 2px';
                span.textContent = selectedText;
                
                // æ›¿æ¢é€‰ä¸­å†…å®¹
                range.deleteContents();
                range.insertNode(span);
                
                // æ¸…é™¤é€‰æ‹©
                window.getSelection().removeAllRanges();
                
                // éšè—å·¥å…·æ 
                this.hideToolbar();
                
                log(`ğŸ¨ åº”ç”¨ ${color.name} é«˜äº®: "${selectedText.substring(0, 20)}..."`);
            }
        }
        
        // å¯åŠ¨æ¨¡æ‹Ÿå™¨
        window.onload = function() {
            new MockToolbarHijacker();
            log('ğŸ“± é¡µé¢åŠ è½½å®Œæˆï¼Œè¯·é€‰æ‹©æ–‡æœ¬æµ‹è¯•');
        };
        
        // å…¨å±€æµ‹è¯•å‡½æ•°
        window.testHijack = function() {
            log('ğŸ§ª æ‰‹åŠ¨æµ‹è¯•å·¥å…·æ åŠ«æŒ...');
            
            // æ¨¡æ‹Ÿé€‰æ‹©
            const testArea = document.querySelector('.test-area p');
            const range = document.createRange();
            range.selectNodeContents(testArea);
            
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            
            // è§¦å‘æ£€æŸ¥
            setTimeout(() => {
                const hijacker = new MockToolbarHijacker();
                hijacker.checkSelection();
            }, 100);
        };
    </script>
</body>
</html>
