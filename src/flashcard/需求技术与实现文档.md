# 闪卡快切功能 - 需求技术与实现文档

## 1. 需求分析

### 1.1 功能概述
为思源笔记的闪卡系统提供快速筛选切换功能，避免用户每次都需要在长文档树中手动寻找目标文档/笔记本进行筛选。

### 1.2 用户痛点
- 闪卡筛选需要在复杂的文档树中导航，操作繁琐
- 常用的筛选目标需要重复查找，效率低下
- 缺乏筛选历史记录，无法快速回到之前的筛选状态

### 1.3 目标用户
经常使用思源笔记闪卡功能的用户，特别是有多个文档/笔记本需要频繁切换筛选的用户。

## 2. 功能设计

### 2.1 核心功能
1. **筛选监听** - 自动检测用户通过"文件树"进行的闪卡筛选操作
2. **历史记录** - 保存最近使用的筛选目标（最多10条）
3. **快速切换** - 提供浮窗界面，一键切换到历史筛选目标
4. **智能管理** - 支持固定、删除、去重和使用频次统计

### 2.2 界面设计
- **触发入口**：小圆球浮窗，悬浮在闪卡面板上
- **主界面**：扁平表格，显示筛选历史列表
- **操作按钮**：固定/取消固定、删除、直接切换

### 2.3 交互流程
```
用户使用闪卡筛选 → 自动记录到历史 → 用户点击圆球 → 显示历史列表 → 点击历史项 → 自动切换筛选
```

## 3. 技术方案

### 3.1 架构设计
```
FlashcardQuickSwitchManager (主管理器)
├── FlashcardMonitor (闪卡筛选监听器)
├── HistoryManager (历史记录管理器)  
├── UIManager (界面管理器)
└── DataPersistence (数据持久化)
```

### 3.2 核心模块职责

#### 3.2.1 FlashcardMonitor (闪卡筛选监听器)
- 监听思源闪卡面板的筛选操作
- 识别筛选类型（文档/笔记本）和目标ID
- 将筛选事件传递给历史管理器

#### 3.2.2 HistoryManager (历史记录管理器)
- 管理筛选历史数据（增删改查）
- 实现去重逻辑
- 处理固定状态和使用频次统计
- 维护最多10条记录的限制

#### 3.2.3 UIManager (界面管理器)
- 渲染小圆球浮窗
- 管理历史列表弹窗
- 处理用户交互事件
- 执行筛选切换操作

#### 3.2.4 DataPersistence (数据持久化)
- JSON文件读写
- 插件卸载时清理数据
- 数据格式验证和迁移

### 3.3 数据结构

#### 3.3.1 筛选历史记录
```typescript
interface FlashcardFilter {
    id: string;              // 文档ID或笔记本ID
    name: string;            // 显示名称
    type: 'doc' | 'notebook'; // 筛选类型
    useCount: number;        // 使用次数
    isPinned: boolean;       // 是否固定
    lastUsed: number;        // 最后使用时间戳
    createdAt: number;       // 创建时间戳
}

interface FlashcardQuickSwitchData {
    version: string;                    // 数据格式版本
    filters: FlashcardFilter[];         // 筛选历史列表
    maxCount: number;                   // 最大记录数（默认10）
}
```

#### 3.3.2 存储路径
```
data/storage/flashcard-quick-switch.json
```

### 3.4 监听机制

#### 3.4.1 思源闪卡筛选检测
监听思源闪卡面板中筛选按钮的点击事件：
```typescript
// 监听筛选按钮点击
document.addEventListener('click', (event) => {
    const filterButton = event.target.closest('[data-type="filter"]');
    if (filterButton) {
        // 检测到筛选操作
    }
});
```

#### 3.4.2 筛选结果捕获
通过监听API调用或DOM变化检测筛选结果：
```typescript
// 监听筛选API调用
// /api/riff/getTreeRiffDueCards 或 /api/riff/getNotebookRiffDueCards
```

## 4. 实现细节

### 4.1 历史记录管理逻辑

#### 4.1.1 添加新记录
```typescript
addFilter(filter: Omit<FlashcardFilter, 'useCount' | 'lastUsed' | 'createdAt'>) {
    const existing = this.findExistingFilter(filter.id);
    
    if (existing) {
        // 去重：更新现有记录
        existing.useCount++;
        existing.lastUsed = Date.now();
        existing.name = filter.name; // 更新可能变化的名称
    } else {
        // 检查是否已满（所有固定）
        const pinnedCount = this.filters.filter(f => f.isPinned).length;
        const unpinnedCount = this.filters.length - pinnedCount;
        
        if (pinnedCount >= this.maxCount) {
            // 10个都被固定了，不添加新记录
            console.log('所有位置都被固定，无法添加新记录');
            return;
        }
        
        if (this.filters.length >= this.maxCount) {
            this.removeOldestUnpinned(); // 移除最旧的非固定记录
        }
        
        // 添加新记录
        const newFilter: FlashcardFilter = {
            ...filter,
            useCount: 1,
            isPinned: false,
            lastUsed: Date.now(),
            createdAt: Date.now()
        };
        this.filters.push(newFilter);
    }
    
    this.sortFilters();
    this.saveData();
}
```

#### 4.1.2 排序规则
```typescript
sortFilters() {
    this.filters.sort((a, b) => {
        // 1. 固定项优先
        if (a.isPinned !== b.isPinned) {
            return a.isPinned ? -1 : 1;
        }
        
        // 2. 按使用频次降序
        if (a.useCount !== b.useCount) {
            return b.useCount - a.useCount;
        }
        
        // 3. 按最近使用时间降序
        return b.lastUsed - a.lastUsed;
    });
}
```

### 4.2 界面实现

#### 4.2.1 小圆球浮窗
```typescript
createFloatingBall(): HTMLElement {
    const ball = document.createElement('div');
    ball.className = 'flashcard-quick-switch-ball';
    ball.innerHTML = `
        <svg viewBox="0 0 24 24">
            <use xlink:href="#iconRiffCard"></use>
        </svg>
    `;
    
    // 定位和样式
    ball.style.cssText = `
        position: fixed;
        top: 100px;
        right: 20px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--b3-theme-primary);
        cursor: pointer;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        transition: all 0.2s ease;
    `;
    
    // 悬停效果
    ball.addEventListener('mouseenter', () => {
        ball.style.transform = 'scale(1.1)';
    });
    
    ball.addEventListener('mouseleave', () => {
        ball.style.transform = 'scale(1)';
    });
    
    return ball;
}
```

#### 4.2.2 历史列表弹窗
```typescript
createHistoryPanel(): HTMLElement {
    const panel = document.createElement('div');
    panel.className = 'flashcard-quick-switch-panel';
    panel.innerHTML = `
        <div class="panel-header">
            <span class="panel-title">闪卡快切</span>
            <button class="close-btn" title="关闭">×</button>
        </div>
        <div class="filter-list">
            ${this.renderFilterItems()}
        </div>
        <div class="panel-footer">
            <small class="count-info">${this.getCountInfo()}</small>
        </div>
    `;
    
    // 样式
    panel.style.cssText = `
        position: fixed;
        top: 150px;
        right: 20px;
        width: 320px;
        max-height: 400px;
        background: var(--b3-theme-background);
        border: 1px solid var(--b3-theme-surface-lighter);
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        z-index: 1001;
        font-size: 14px;
        overflow: hidden;
    `;
    
    return panel;
}

renderFilterItems(): string {
    if (this.filters.length === 0) {
        return `
            <div class="empty-state">
                <div class="empty-icon">📋</div>
                <div class="empty-text">暂无筛选历史</div>
                <div class="empty-hint">使用闪卡筛选后会自动记录</div>
            </div>
        `;
    }
    
    return this.filters.map(filter => `
        <div class="filter-item" data-id="${filter.id}">
            <div class="filter-info">
                <div class="filter-name" title="${filter.name}">
                    <span class="filter-icon">${filter.type === 'doc' ? '📄' : '📁'}</span>
                    ${this.truncateText(filter.name, 20)}
                </div>
                <div class="filter-meta">
                    <span class="use-count">${filter.useCount}次</span>
                    <span class="last-used">${this.formatTime(filter.lastUsed)}</span>
                </div>
            </div>
            <div class="filter-actions">
                <button class="pin-btn ${filter.isPinned ? 'pinned' : ''}" 
                        data-id="${filter.id}" 
                        title="${filter.isPinned ? '取消固定' : '固定'}">
                    📌
                </button>
                <button class="delete-btn" data-id="${filter.id}" title="删除">
                    🗑️
                </button>
            </div>
        </div>
    `).join('');
}
```

### 4.3 监听实现

#### 4.3.1 DOM变化监听
```typescript
setupFlashcardMonitoring() {
    // 监听闪卡面板的创建和筛选操作
    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            mutation.addedNodes.forEach((node) => {
                if (node.nodeType === Node.ELEMENT_NODE) {
                    const element = node as Element;
                    
                    // 检测闪卡面板
                    const cardDialog = element.querySelector('[data-key="dialog-viewcards"], [data-key="dialog-opencard"]');
                    if (cardDialog) {
                        this.onFlashcardPanelDetected(cardDialog);
                    }
                    
                    // 检测筛选按钮
                    const filterButton = element.querySelector('[data-type="filter"]');
                    if (filterButton) {
                        this.attachFilterMonitoring(filterButton);
                    }
                }
            });
        });
    });
    
    observer.observe(document.body, { childList: true, subtree: true });
}

onFlashcardPanelDetected(panel: Element) {
    // 显示快切小圆球
    this.showQuickSwitchBall(panel);
    
    // 监听面板关闭，隐藏小圆球
    const closeButtons = panel.querySelectorAll('[data-type="close"]');
    closeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            this.hideQuickSwitchBall();
        });
    });
}

attachFilterMonitoring(filterButton: Element) {
    filterButton.addEventListener('click', () => {
        // 延迟执行，等待筛选菜单出现
        setTimeout(() => {
            this.monitorFilterSelection();
        }, 100);
    });
}
```

#### 4.3.2 筛选切换实现
```typescript
async switchToFilter(filter: FlashcardFilter) {
    try {
        // 1. 找到筛选按钮
        const filterButton = document.querySelector('[data-type="filter"]') as HTMLElement;
        if (!filterButton) {
            console.error('找不到筛选按钮');
            return;
        }
        
        // 2. 更新按钮属性
        filterButton.setAttribute('data-id', filter.id);
        filterButton.setAttribute('data-cardtype', filter.type);
        
        // 3. 模拟点击筛选更新（触发思源原有逻辑）
        const fetchNewRoundEvent = new CustomEvent('fetchNewRound');
        filterButton.dispatchEvent(fetchNewRoundEvent);
        
        // 4. 如果自定义事件不生效，直接调用API
        const apiEndpoint = filter.type === 'doc' 
            ? '/api/riff/getTreeRiffDueCards'
            : '/api/riff/getNotebookRiffDueCards';
            
        const response = await fetch(apiEndpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                rootID: filter.id,
                deckID: filter.id,
                notebook: filter.id
            })
        });
        
        if (response.ok) {
            // 5. 更新使用统计
            this.historyManager.incrementUseCount(filter.id);
            
            // 6. 关闭快切面板
            this.uiManager.hideHistoryPanel();
            
            console.log(`已切换到筛选: ${filter.name}`);
        }
        
    } catch (error) {
        console.error('切换筛选失败:', error);
    }
}
```

## 5. 风险考虑与解决方案

### 5.1 技术风险

#### 5.1.1 思源版本兼容性
- **风险**：思源更新可能改变闪卡面板结构
- **解决**：使用容错性强的选择器，添加版本检测和降级处理

#### 5.1.2 性能影响
- **风险**：频繁的DOM监听可能影响性能
- **解决**：使用防抖处理，优化监听范围，仅在闪卡面板激活时监听

#### 5.1.3 API调用兼容性
- **风险**：思源API变化导致筛选切换失效
- **解决**：多种切换方案备选，API失效时降级到DOM操作

### 5.2 用户体验风险

#### 5.2.1 界面冲突
- **风险**：浮窗可能遮挡重要内容
- **解决**：
  - 支持拖拽调整位置
  - 提供自动隐藏选项
  - 智能避让重要UI元素

#### 5.2.2 数据丢失
- **风险**：意外删除重要的历史记录
- **解决**：
  - 删除操作需要确认
  - 固定记录有特殊标识
  - 支持数据导出备份

#### 5.2.3 误操作
- **风险**：用户可能误触发快切功能
- **解决**：
  - 小圆球有明确的视觉反馈
  - 提供功能开关选项
  - 支持撤销最近操作

## 6. 测试方案

### 6.1 功能测试
- [ ] 筛选操作自动记录
- [ ] 历史列表正确显示和排序
- [ ] 快速切换正常工作
- [ ] 去重逻辑正确执行
- [ ] 固定功能正常
- [ ] 删除操作正确
- [ ] 使用统计准确

### 6.2 边界测试
- [ ] 10条记录上限处理
- [ ] 全部记录固定时的行为
- [ ] 空历史记录状态
- [ ] 插件卸载清理
- [ ] 数据格式异常处理
- [ ] 网络异常处理

### 6.3 兼容性测试
- [ ] 不同思源版本兼容性
- [ ] 移动端和桌面端适配
- [ ] 不同主题下的样式适配
- [ ] 高DPI屏幕适配

### 6.4 性能测试
- [ ] 大量历史记录性能
- [ ] 监听机制性能影响
- [ ] 内存泄漏检查
- [ ] 长时间运行稳定性

## 7. 部署计划

### 7.1 开发阶段
1. **Phase 1**: 核心数据结构和持久化实现
   - FlashcardFilter接口定义
   - HistoryManager基础功能
   - JSON文件读写和清理

2. **Phase 2**: 监听机制和历史记录管理
   - FlashcardMonitor实现
   - 筛选操作检测和记录
   - 去重和排序逻辑

3. **Phase 3**: 界面实现和用户交互
   - UIManager界面渲染
   - 小圆球浮窗和历史面板
   - 用户交互事件处理

4. **Phase 4**: 筛选切换和集成
   - 筛选切换功能实现
   - 与现有插件架构集成
   - 全流程联调

5. **Phase 5**: 测试优化和文档完善
   - 全面测试和bug修复
   - 性能优化和兼容性处理
   - 用户文档和示例

### 7.2 发布策略
- 作为highlight-assistant插件的新功能模块
- 独立的配置选项，可选择启用/禁用
- 详细的使用说明和示例
- 向后兼容，不影响现有功能

### 7.3 维护计划
- 定期检查思源版本兼容性
- 收集用户反馈持续改进
- 性能监控和优化
- 功能扩展和增强

## 8. 配置选项

### 8.1 用户配置
```typescript
interface QuickSwitchConfig {
    enabled: boolean;           // 是否启用功能
    maxHistory: number;         // 最大历史记录数（默认10）
    ballPosition: {             // 小圆球位置
        x: number;
        y: number;
    };
    autoHide: boolean;          // 是否自动隐藏
    showUsageCount: boolean;    // 是否显示使用次数
    enableDrag: boolean;        // 是否支持拖拽
}
```

### 8.2 默认配置
```typescript
const DEFAULT_CONFIG: QuickSwitchConfig = {
    enabled: true,
    maxHistory: 10,
    ballPosition: { x: 20, y: 100 },
    autoHide: false,
    showUsageCount: true,
    enableDrag: true
};
```

---

## 附录

### A. 相关API文档
- `/api/riff/getTreeRiffDueCards` - 获取文档闪卡
- `/api/riff/getNotebookRiffDueCards` - 获取笔记本闪卡
- `/api/riff/getRiffDueCards` - 获取全部闪卡

### B. CSS样式规范
```css
.flashcard-quick-switch-ball {
    /* 小圆球样式 */
}

.flashcard-quick-switch-panel {
    /* 历史面板样式 */
}

.filter-item {
    /* 筛选项样式 */
}
```

### C. 错误代码
- `QS001`: 初始化失败
- `QS002`: 数据加载失败
- `QS003`: 筛选切换失败
- `QS004`: 数据保存失败

---

*文档版本：1.0*  
*创建时间：2024-10-01*  
*更新时间：2024-10-01*