# 更新日志 - 只读模式检查功能

**更新日期**: 2025-10-01  
**版本**: v1.1.0

## 📝 更新内容

### 新增文件

1. **`src/utils/readonlyChecker.ts`** - 只读模式检查器
   - 检查系统是否为只读模式
   - 检查文档是否可访问
   - 获取环境信息用于调试

### 修改文件

1. **`src/utils/toolbarHijacker.ts`** - 工具栏劫持器
   - 导入只读模式检查模块
   - `hijack()` 方法改为异步方法
   - 添加启动时的只读模式检查和环境信息输出
   - 在 `showContent` 劫持方法中添加详细日志
   - 在 `showCustomMemoDialog` 方法中添加详细日志

2. **`src/index.ts`** - 插件主入口
   - 更新 `onLayoutReady` 以支持异步的 `hijack()` 方法

### 新增文档

1. **`调试指南-只读模式检查.md`** - 用户调试指南
2. **`更新日志-只读模式检查.md`** - 本文档

## 🎯 主要功能

### 1. 系统只读模式检查

通过调用思源API `/api/system/getConf` 来检查系统是否处于只读模式：

```typescript
const readOnly = await isSystemReadOnly();
```

### 2. 详细的调试日志

在以下关键节点输出调试信息：

#### 启动时
```
[ToolbarHijacker] 🚀 ========== 启动工具栏劫持 ==========
[ToolbarHijacker] 🔐 检查系统只读状态...
[ReadonlyChecker] 🔒 系统为只读模式
[ReadonlyChecker] 📋 系统配置: { readOnly: true, ... }
[ReadonlyChecker] 📚 笔记本数量: 3
```

#### 工具栏触发时
```
[ToolbarHijacker] 🎯 ========== 工具栏 showContent 被触发 ==========
[ToolbarHijacker] 选中文本: xxx
[ToolbarHijacker] 当前系统状态: 🔒 只读模式（正常）
[ToolbarHijacker] ✨ 增强工具栏...
```

#### 备注弹窗显示时
```
[ToolbarHijacker] 💬 ========== 显示备注弹窗 ==========
[ToolbarHijacker] 📋 系统状态: 🔒 只读模式
[ToolbarHijacker] 🎨 准备显示备注输入对话框...
```

## 🔧 技术实现

### API调用

使用思源笔记的以下API：

1. **`/api/system/getConf`** - 获取系统配置
   ```typescript
   {
     "conf": {
       "editor": {
         "readOnly": true  // 关键字段
       }
     }
   }
   ```

2. **`/api/notebook/lsNotebooks`** - 列出笔记本
3. **`/api/filetree/getDoc`** - 获取文档信息（预留）

### 日志格式

所有日志使用统一的前缀和图标：

- `[ReadonlyChecker]` - 只读检查器相关
- `[ToolbarHijacker]` - 工具栏劫持器相关
- `[Plugin]` - 插件主程序相关

图标含义：
- 🚀 启动 | 🔐 权限 | 🔒 只读 | ✏️ 可写
- 📋 调用 | ✨ 增强 | 💬 对话框
- ✅ 成功 | ❌ 失败 | ⚠️ 警告

## 📊 调试信息输出

### 环境信息
```javascript
[ReadonlyChecker] 🌍 ========== 环境信息 ==========
[ReadonlyChecker] 📋 系统配置: {
  只读模式: true,
  发布模式: false,
  启动状态: true
}
[ReadonlyChecker] 📚 笔记本数量: 3
[ReadonlyChecker]   - 测试笔记本: 已打开
[ReadonlyChecker]   - 工作笔记: 已打开
[ReadonlyChecker]   - 日记本: 已关闭
```

### 选中文本信息
```javascript
[ToolbarHijacker] 环境: {
  isMobile: false,
  isDesktop: true,
  hasRange: true,
  selectedText: "这是被选中的文本..."
}
```

## 🐛 问题排查

根据用户反馈"**弹窗只在只读模式下出现**"，现在可以通过日志验证：

### 场景1：正常情况（只读模式）
```
[ReadonlyChecker] 🔒 系统为只读模式
[ToolbarHijacker] ✨ 增强工具栏...
[ToolbarHijacker] 💬 ========== 显示备注弹窗 ==========
```
**结果**: ✅ 弹窗正常出现

### 场景2：可写模式
```
[ReadonlyChecker] ✏️ 系统为可写模式
[ToolbarHijacker] ✨ 增强工具栏...
```
**结果**: ❓ 可能不出现弹窗

### 场景3：跨块选择
```
[ToolbarHijacker] ⚠️ 跨块选择，不增强工具栏
```
**结果**: ❌ 不增强工具栏

## 📦 构建信息

```bash
npm run build
```

构建产物：
- `dist/index.js` - 45.70 kB (gzip: 12.34 kB)
- `dist/index.css` - 7.63 kB (gzip: 1.77 kB)
- `package.zip` - 完整插件包

## 🧪 测试方法

1. **启动插件**
   - 重启思源笔记
   - 打开控制台 (F12)
   - 查看启动日志

2. **测试只读模式检查**
   - 在控制台查找 `[ReadonlyChecker]` 日志
   - 确认系统状态显示

3. **测试工具栏劫持**
   - 选中一段文本
   - 查看是否有 `工具栏 showContent 被触发` 日志
   - 查看是否有 `增强工具栏` 日志

4. **测试备注功能**
   - 点击备注按钮
   - 查看是否有 `显示备注弹窗` 日志

5. **使用调试函数**
   - 在控制台运行 `testHijack()`
   - 查看劫持状态

## 🔄 后续计划

- [ ] 根据只读模式动态调整UI
- [ ] 添加更多环境信息输出
- [ ] 优化日志级别（info/warn/error）
- [ ] 添加日志开关配置

## 📌 注意事项

1. 所有异步方法都需要 `await`
2. 日志可能影响性能，生产环境可考虑减少
3. 只读模式检查需要API权限
4. 日志输出仅在开发者工具可见

## 🙏 鸣谢

感谢用户反馈"弹窗只在只读模式下出现"的问题，促成了本次调试功能的开发。

---

**构建命令**: `npm run build`  
**测试环境**: Windows 10, 思源笔记 v3.x  
**开发者**: AI Assistant

