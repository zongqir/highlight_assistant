# 重要发现 - 文档级只读状态（锁图标）

## 🎯 核心发现

你提到的"锁"图标对应的是**文档级别的只读状态**，这与系统级只读模式是两个不同的概念！

## 📊 两种只读模式对比

### 1. 系统级只读模式
- **位置**: 设置 → 编辑器 → 只读模式
- **影响范围**: 所有笔记本
- **API检查**: `/api/system/getConf` → `conf.editor.readOnly`
- **用途**: 全局阅读模式

### 2. 文档级只读模式 ⭐️ **这才是你说的锁！**
- **位置**: 每个文档右上角的锁图标 🔒
- **影响范围**: 单个文档
- **检查方式**: DOM属性 `custom-sy-readonly`
- **用途**: 保护特定文档不被编辑
- **用户可以随时切换**: 点击锁图标即可

## 🔍 技术实现

### 文档级只读状态存储位置
```typescript
// 存储在 DOM 元素的属性上
protyle.wysiwyg.element.getAttribute('custom-sy-readonly')
// 返回值: "true" (只读) 或 "false" (可写) 或 null (可写)
```

### 如何设置
```typescript
// 通过 API 设置
fetchPost("/api/attr/setBlockAttrs", {
    id: docId,
    attrs: {
        "custom-sy-readonly": "true"  // 锁定
        // 或 "false" 解锁
    }
});
```

## 📝 新增的调试日志

现在插件会同时检查**两种**只读状态：

```
[ToolbarHijacker] 🎯 ========== 工具栏 showContent 被触发 ==========
[ReadonlyChecker] 🔐 检查系统只读模式...
[ReadonlyChecker] ✏️ 系统为可写模式

[ReadonlyChecker] 🎯 从选区查找文档只读状态...
[ReadonlyChecker] ✅ 找到 protyle-wysiwyg 元素
[ReadonlyChecker] 🔍 检查文档前端只读状态（DOM属性）...
[ReadonlyChecker] 🔒 文档为只读模式（锁已锁定）
[ReadonlyChecker] DOM属性值: { custom-sy-readonly: "true", isReadonly: true }

[ToolbarHijacker] 📊 只读状态汇总: {
  系统级只读: 否✏️,
  文档级只读: 是🔒（锁已锁定）,
  最终判断: 只读模式
}
```

## 🎨 日志说明

### 系统级只读检查
```
[ReadonlyChecker] 🔐 检查系统只读模式...
[ReadonlyChecker] 🔒 系统为只读模式  // 或 ✏️ 系统为可写模式
```

### 文档级只读检查
```
[ReadonlyChecker] 🎯 从选区查找文档只读状态...
[ReadonlyChecker] ✅ 找到 protyle-wysiwyg 元素
[ReadonlyChecker] 🔒 文档为只读模式（锁已锁定）  // 或 ✏️ 文档为可写模式（锁已解锁）
```

### 状态汇总
```
[ToolbarHijacker] 📊 只读状态汇总: {
  系统级只读: 是🔒/否✏️,
  文档级只读: 是🔒（锁已锁定）/否✏️（锁已解锁）,
  最终判断: 只读模式/可写模式
}
```

## 🧪 测试方法

### 测试步骤

1. **打开一个文档**
2. **打开控制台** (F12)
3. **点击右上角的锁图标** 🔒
   - 锁定 → 文档变为只读
   - 解锁 → 文档变为可写
4. **选中一段文本**
5. **查看控制台日志**

### 预期日志（锁定状态）
```
[ToolbarHijacker] 🎯 ========== 工具栏 showContent 被触发 ==========
[ReadonlyChecker] ✏️ 系统为可写模式
[ReadonlyChecker] 🔒 文档为只读模式（锁已锁定）  ← 关键！
[ToolbarHijacker] 📊 只读状态汇总: {
  系统级只读: 否✏️,
  文档级只读: 是🔒（锁已锁定）,  ← 这里！
  最终判断: 只读模式
}
[ToolbarHijacker] ✨ 增强工具栏...
```

### 预期日志（解锁状态）
```
[ToolbarHijacker] 🎯 ========== 工具栏 showContent 被触发 ==========
[ReadonlyChecker] ✏️ 系统为可写模式
[ReadonlyChecker] ✏️ 文档为可写模式（锁已解锁）  ← 关键！
[ToolbarHijacker] 📊 只读状态汇总: {
  系统级只读: 否✏️,
  文档级只读: 否✏️（锁已解锁）,  ← 这里！
  最终判断: 可写模式
}
[ToolbarHijacker] ✨ 增强工具栏...
```

## 💡 关键洞察

根据你说的"**弹窗只在只读模式下出现**"，现在可以精确验证：

### 场景1: 文档锁定（锁已锁🔒）
- **文档级只读**: ✅ 是
- **弹窗**: ✅ 应该出现
- **日志特征**: `文档为只读模式（锁已锁定）`

### 场景2: 文档解锁（锁已开🔓）
- **文档级只读**: ❌ 否
- **弹窗**: ❓ 可能不出现
- **日志特征**: `文档为可写模式（锁已解锁）`

### 场景3: 系统只读
- **系统级只读**: ✅ 是
- **弹窗**: ✅ 应该出现
- **日志特征**: `系统为只读模式`

## 🔧 DOM检查方法

如果想手动检查当前文档的只读状态，可以在控制台运行：

```javascript
// 找到编辑区域元素
const wysiwyg = document.querySelector('.protyle-wysiwyg');

// 检查 custom-sy-readonly 属性
const isReadonly = wysiwyg?.getAttribute('custom-sy-readonly');

console.log('文档只读状态:', isReadonly);
// 输出: "true" (只读) 或 "false"/"null" (可写)
```

## 📱 手机版说明

在手机版思源中：
- 通常默认为只读模式（为了防止误操作）
- 也可能有切换按钮（具体看版本）
- 检查逻辑完全相同

## 🎯 下一步操作

现在你可以：

1. ✅ **重启思源笔记**
2. ✅ **打开一个文档**
3. ✅ **打开控制台 (F12)**
4. ✅ **点击锁图标切换状态** 🔒 ↔️ 🔓
5. ✅ **每次切换后选中文本**
6. ✅ **观察控制台日志变化**
7. ✅ **验证弹窗是否只在锁定时出现**

## 📋 日志查找技巧

在控制台过滤器中输入：
- `文档级只读` - 只看文档级状态
- `系统级只读` - 只看系统级状态
- `只读状态汇总` - 看完整总结

## 🐛 可能的发现

如果弹窗确实只在只读模式下出现，日志会清楚显示：

**有弹窗时:**
```
文档级只读: 是🔒（锁已锁定）
```

**没弹窗时:**
```
文档级只读: 否✏️（锁已解锁）
```

这样就能100%确认问题原因了！

---

**更新日期**: 2025-10-01  
**版本**: v1.1.1  
**关键发现**: 文档级 `custom-sy-readonly` 属性是控制弹窗出现的关键！

